@import play.api.mvc.RequestHeader
@(webJarAssets: WebJarAssets, sectionname : String)(implicit messages: Messages, request: RequestHeader)
<link href="@routes.Assets.at("styles/reformat.css")" rel="stylesheet">
<link href="@routes.Assets.at("styles/reformat-common.css")" rel="stylesheet">

<div style="padding-top: 10px;"></div>
<div style="width: 80%; display: block; margin: auto;">
<ul class="vertical menu" data-accordion-menu>
    <li>
        <a href="#" class="menu-icon"><i class="fi-list"></i> <span id="reformat">Reformat Converter</span></a>
        <ul class="menu horizontal nested">
            <li><a download="export.txt" class="download" onclick="downloadResult()">Export</a></li>
            <li><a id="dropzonetoggle">Upload</a></li>
            <li><a data-open="alnvizmodal" onclick="initMSA()">AlignmentViewer</a></li>
            <li><a onclick="myCodeMirror.setValue('');myCodeMirror2.setValue('')">Clear</a></li>
            <li style="padding-top: 15px; padding-left: 10px;">
            <select id="forwardTool">
                <option selected>Forward To</option>
                <option  id="clans" onclick="forward('clans')" value="psi">Clans</option>
                <option  id="csblast" onclick="forward('csblast')" value="psi">CS-BLAST</option>
                <option  id="hhblits" onclick="forward('hhblits')" value="psi">HHblits</option>
                <option  id="hhpred" onclick="forward('hhpred')" value="psi">HHpred</option>
                <option  id="hmmer3" onclick="forward('hmmer3')" value="psi">Hmmer3</option>
                <option  id="mafft" onclick="forward('mafft')" value="psi">Mafft</option>
                <option  id="psiblast" onclick="forward('psiblast')" value="psi">PSI-BLAST</option>
                <option  id="tcoffee" onclick="forward('tcoffee')" value="psi">T-Coffee</option>
            </select>
            </li>
        </ul>
    </li>
</ul>
</div>
<div class="large-6 large-centered columns" id="dropzonewrapper" style="display: none;">
    <div id="progress_bar"><div class="percent">0%</div></div>
    <input type="file" id="files" name="file" />
        <!--<div id="drop_zone" type="file" class="dropzone" name="file" style="margin-top: 10px; text-align: center; line-height: 150px; vertical-align: middle;">Drop files here</div>-->
    <output id="list"></output>


</div>
<div style="width: 95%; display: block; margin: auto; padding-top: 15px;">
    <div class="large-12 columns" style="padding-right: 12px;">
        <div style="float: right; z-index: 9;">
            <span data-tooltip aria-haspopup="true" class="has-tip top" tabindex="1" title="Paste output as input">
                <button class="small button" id="copy-button" data-clipboard-target="#outputarea" onclick="pasteLeft()" style="margin: 0 -5px 0 0;">Paste</button></span>
            <span data-tooltip aria-haspopup="true" class="has-tip top" tabindex="1" title="Copy output to clipboard">
                <button class="small button warning" id="copy-button" data-clipboard-target="#outputarea" onclick="(function(){
                    new Clipboard('#copy-button');
                })();" style="margin: 0 0 0 0;">Copy</button></span>
        </div>
    </div>
    <div class="large-12 columns">
        <div id="inputMirror" style="width: 99%; border: 1px solid lightgray ;"></div>
    </div>
    <div class="large-12 columns">
        <div id="outputMirror" style="width: 99%; border: 1px solid lightgray ; padding-top: 8px;"></div>
        </div>


    </div>
<p>&nbsp;</p>

<div class="show-for-medium large-12 columns" style="padding-top: 20px;">
    <div class="success callout" id="callout" data-closable="slide-out-right" style="width: 50%; display: block; margin: auto;">
        <p style="width: 80%; text-align: justify;">It looks as we found a <span id="nonalignedwarning" style="color: red; display: none;">non-aligned</span> <span id="format"></span> formatted input. To which format do you want to convert it?</p>
        <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
            <span aria-hidden="true">&times;</span>
        </button>

        <label>Select Output Format
            <select id="outformat">
                <option selected>Choose</option>
                <option id="Fasta" value="Fasta">Fasta</option>
                <option id="A3M" value="A3M">A3M</option>
                <option id="Clustal" value="Clustal" class="clustaloption">CLUSTAL</option>
                <option id="Phylip" value="Phylip" class="clustaloption">PHYLIP</option>
                <option id="Stockholm" value="Stockholm">STOCKHOLM</option>
                <option id="PIR" value="PIR">PIR</option>
                <option id="EMBL" value="EMBL">EMBL</option>
                <option id="NEXUS" value="NEXUS">Nexus</option>
                <option id="Genbank" value="Genbank">Genbank</option>
            </select>
        </label>
    </div>

</div>
<p>&nbsp;</p>
<p>&nbsp;</p>

<div class="large reveal" id="alnvizmodal" data-reveal>
    <h1>AlignmentViewer</h1>

    <div id="menuDiv"></div>
    <div id="yourDiv">Loading ... </div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>



<textarea id="outputarea" style="height: 1px; position: relative; top: -10000px; left: -10000px;"></textarea>
<script src="@routes.WebJarAssets.at(webJarAssets.locate("reformat.js"))"></script>
<script src="@routes.Assets.at("scripts/validation.js")"></script>
<script>


           hideTools("");
        var inputFasta = ">gi|33300828|ref|NP_877456#7 putative ATP-dependent DNA ligase [Bacteriophage phiKMV]\nPEITVDGRIVGYVMGKTG-KNVGRVVGYRVELEDGSTVAATGLSEEHIQLLTCAYLNAHI\nD---EAMPNYGRIVEVSAMERSAN-TLRHPSFSRFR\n>gi|114796395|emb|CAK25951#9 putative ATP-dependent DNA ligase [Bacteriophage LKD16]\nPSLAVEGIVVGFVMGKTG-ANVGKVVGYRVDLEDGTIVSATGLTRDRIEMLTTEAELLGG\nA-DHPGMADLGRVVEVTAMERSAN-TLRHPKFSRFR\n>gi|114796457|emb|CAK24995#5 putative DNA ligase [Bacteriophage LKA1]   E=4e-40 s/c=1.7\nPGFEADGTVIDYVWGDPDKANANKIVGFRVRLEDGAEVNATGLTQDQMACYTQSYHATAY\nEVGITQTIYIGRACRVSGMERTKDGSIRHPHFDGFR\n>gi|29366706|ref|NP_813751#8 putative DNA ligase [Pseudomonas phage gh-1]   gi|29243565\nPDDNEDGFIQDVIWGTKGLANEGKVIGFKVLLESGHVVNACKISRALMDEFTDTETRLPG\n-------YYKGHTAKVTFMERYPDGSLRHPSFDSFR\n>gi|68299729|ref|YP_249578#6 DNA ligase [Vibriophage VP4]   gi|66473268|gb|AAY46277.1|\nPEGEIDGTVVGVNWGTVGLANEGKVIGFQVLLENGVVVDANGITQEQMEEYTNLVYKTGH\nD-----DCFNGRPVQVKYMEKTPKGSLRHPSFQRWR\n>gi|77118174|ref|YP_338096#3 ligase [Enterobacteria phage K1F]   gi|72527918|gb|AAZ7297\nPSEEADGHVVRPVWGTEGLANEGMVIGFDVMLENGMEVSATNISRALMSEFTENVKSDP-\n------DYYKGWACQITYMEETPDGSLRHPSFDQWR\n>gi|17570796|ref|NP_523305#4 DNA ligase [Bacteriophage T3]   gi|118769|sp|P07717|DNLI_B\nPECEADGIIQGVNWGTEGLANEGKVIGFSVLLETGRLVDANNISRALMDEFTSNVKAHGE\nD------FYNGWACQVNYMEATPDGSLRHPSFEKFR\n>gi|119637753|ref|YP_91898#2 DNA ligase [Yersinia phage Berlin]   gi|119391784|emb|CAJ\nPECEADGIIQSVNWGTPGLSNEGLVIGFNVLLETGRHVAANNISQTLMEELTANAKEHGE\nD------YYNGWACQVAYMEETSDGSLRHPSFVMFR\n";
        // document.getElementById("alignment").value = inputFasta;
        var inputClustal = "CLUSTAL multiple sequence alignment\n\ngi|33300828\tPEITVDGRIVGYVMGKTG-KNVGRVVGYRVELEDGSTVAATGLSEEHIQLLTCAYLNAHI\ngi|11479639\tPSLAVEGIVVGFVMGKTG-ANVGKVVGYRVDLEDGTIVSATGLTRDRIEMLTTEAELLGG\ngi|11479645\tPGFEADGTVIDYVWGDPDKANANKIVGFRVRLEDGAEVNATGLTQDQMACYTQSYHATAY\ngi|29366706\tPDDNEDGFIQDVIWGTKGLANEGKVIGFKVLLESGHVVNACKISRALMDEFTDTETRLPG\ngi|68299729\tPEGEIDGTVVGVNWGTVGLANEGKVIGFQVLLENGVVVDANGITQEQMEEYTNLVYKTGH\ngi|77118174\tPSEEADGHVVRPVWGTEGLANEGMVIGFDVMLENGMEVSATNISRALMSEFTENVKSDP-\ngi|17570796\tPECEADGIIQGVNWGTEGLANEGKVIGFSVLLETGRLVDANNISRALMDEFTSNVKAHGE\ngi|11963775\tPECEADGIIQSVNWGTPGLSNEGLVIGFNVLLETGRHVAANNISQTLMEELTANAKEHGE\n\ngi|33300828\tD---EAMPNYGRIVEVSAMERSAN-TLRHPSFSRFR\ngi|11479639\tA-DHPGMADLGRVVEVTAMERSAN-TLRHPKFSRFR\ngi|11479645\tEVGITQTIYIGRACRVSGMERTKDGSIRHPHFDGFR\ngi|29366706\t-------YYKGHTAKVTFMERYPDGSLRHPSFDSFR\ngi|68299729\tD-----DCFNGRPVQVKYMEKTPKGSLRHPSFQRWR\ngi|77118174\t------DYYKGWACQITYMEETPDGSLRHPSFDQWR\ngi|17570796\tD------FYNGWACQVNYMEATPDGSLRHPSFEKFR\ngi|11963775\tD------YYNGWACQVAYMEETSDGSLRHPSFVMFR";



        var myCodeMirror = CodeMirror(document.getElementById("inputMirror"), {
            value: inputFasta,
            lineNumbers: false,
            mode:  "none",
            theme: "reformat"
        });
        myCodeMirror.setSize("100%", 300);


        var myCodeMirror2 = CodeMirror(document.getElementById("outputMirror"), {
            value: "",
            lineNumbers: false,
            readOnly: true,
            mode:  "javascript",
            theme: "reformat"
        });

        myCodeMirror2.setSize("100%", 300);

        if(localStorage.getItem("resultcookie")  != null){
        myCodeMirror.setValue(localStorage.getItem("resultcookie"));
        localStorage.removeItem("resultcookie");
        }


        // on and off handler like in jQuery
        myCodeMirror.on('change',function(cMirror){
            hideFormats(getFormat(myCodeMirror.getValue()));

            // get value right from instance
            if(validateFasta(myCodeMirror.getValue())) {
                document.getElementById('callout').style.display = 'block';

                if (validateAlignment(fasta2json(myCodeMirror.getValue()))) {
                    $(".clustaloption").show();
                    document.getElementById('nonalignedwarning').style.display = 'none';
                }
                else {
                    $(".clustaloption").hide();
                    document.getElementById('nonalignedwarning').style.display = 'inline';
                }

            }

            if(getFormat(myCodeMirror.getValue()) != "") {
                 document.getElementById('callout').style.display = 'block';
                 $('#format').text(getFormat(myCodeMirror.getValue()))
            }

            if(getFormat(myCodeMirror.getValue()) == "") {
                 document.getElementById('callout').style.display = 'none';
            }


        });


        document.getElementById("outformat").onchange = function() {
            var currentVal = this.value;
             hideTools(currentVal);
                myCodeMirror2.setValue(($('#inputMirror').val(myCodeMirror.getValue())).reformat(currentVal));
                tempCode = myCodeMirror.getValue();
                myCodeMirror.setValue('');
                $(".CodeMirror-line").decodeEffect();
                myCodeMirror.setValue(tempCode);


            document.getElementById('outputarea').value = myCodeMirror2.getValue();
        };

        /* Export */

        function downloadResult() {
            if (myCodeMirror2.getValue())
                $('a.download').attr('href', 'data:application/octet-stream;content-disposition:attachment;filename=file.txt;charset=utf-8,' + encodeURIComponent(myCodeMirror2.getValue()));
        }



        /* DropZone */
        var reader;
        var progress = document.querySelector('.percent');

        function handleFileSelect(evt) {
            evt.stopPropagation();
            evt.preventDefault();


            var files = evt.dataTransfer.files; // FileList object.

            // files is a FileList of File objects. List some properties.
            var output = [];
            progress.style.width = '0%';
            progress.textContent = '0%';
            reader = new FileReader();

            for (var i = 0, f; f = files[i]; i++) {
                if (!f.type.match('text/plain')) {
                    output.push('<li><strong>', 'Please drop only plain text files with *.txt as suffix.', '</strong> </li>');
                    continue;
                }


                reader.onerror = errorHandler;
                reader.onprogress = updateProgress;
                reader.onabort = function(e) {
                    alert('File read cancelled');
                };
                reader.onloadstart = function(e) {
                    document.getElementById('progress_bar').className = 'loading';
                };
                reader.onload = function(e) {
                    // Ensure that the progress bar displays 100% at the end.
                    progress.style.width = '100%';
                    progress.textContent = '100%';
                    setTimeout("document.getElementById('progress_bar').className='';", 2000);
                };

                // Read in the image file as a binary string.
                reader.readAsBinaryString(evt.target.files[i]);



                output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                        f.size, ' bytes, last modified: ',
                        f.lastModifiedDate.toLocaleDateString(), '</li>');

            }

            document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
        }



        function handleFileSelect2(evt) {
            // Reset progress indicator on new file selection.
            progress.style.width = '0%';
            progress.textContent = '0%';

            reader = new FileReader();

            reader.onerror = errorHandler;
            reader.onprogress = updateProgress;
            reader.onabort = function(e) {
                alert('File read cancelled');
            };
            reader.onloadstart = function(e) {
                document.getElementById('progress_bar').className = 'loading';
            };
            reader.onload = function(e) {
                // Ensure that the progress bar displays 100% at the end.
                progress.style.width = '100%';
                progress.textContent = '100%';
                setTimeout("document.getElementById('progress_bar').className='';", 2000);
                if (evt.target.files[0].type.match('text/plain')) {

                    myCodeMirror.setValue(reader.resultpanel);

                } else alert("type mismatch, please upload only plain text files.");
            };


            // Read in the image file as a binary string.
            //reader.readAsBinaryString(evt.target.files[0]);

            reader.readAsText(evt.target.files[0]);

        }

        function updateProgress(evt) {
            // evt is an ProgressEvent.
            if (evt.lengthComputable) {
                var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
                // Increase the progress bar length.
                if (percentLoaded < 100) {
                    progress.style.width = percentLoaded + '%';
                    progress.textContent = percentLoaded + '%';
                }
            }
        }

        function errorHandler(evt) {
            switch(evt.target.error.code) {
                case evt.target.error.NOT_FOUND_ERR:
                    alert('File Not Found!');
                    break;
                case evt.target.error.NOT_READABLE_ERR:
                    alert('File is not readable');
                    break;
                case evt.target.error.ABORT_ERR:
                    break; // noop
                default:
                    alert('An error occurred reading this file.');
            };
        }

        function abortRead() {
            reader.abort();
        }

        function handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
        }

        // Setup the dnd listeners.
        //var dropZone = document.getElementById('drop_zone');
        //dropZone.addEventListener('dragover', handleDragOver, false);
        //dropZone.addEventListener('drop', handleFileSelect, false);
        document.getElementById('files').addEventListener('change', handleFileSelect2, false);


        // Dropzone Toggle

        $("#dropzonetoggle").on("click", function(){
            if($("#dropzonewrapper").css("display") == "none")
            {
                $("#dropzonewrapper").show();
            } else {
                $("#dropzonewrapper").hide();
            }

            return false;
        });

        /* Paste left */

        function pasteLeft() {

            if (myCodeMirror2.getValue()) {

                myCodeMirror.setValue(myCodeMirror2.getValue());
                myCodeMirror2.setValue("");
            }

            else alert("no output yet");

        }


        /* Decode Effect */


        jQuery.fn.decodeEffect = (function ($) {
            var defaultOptions = {
                duration:      0.001,
                stepsPerGlyph: 1,
                codeGlyphs:    "-ACDEFGHIKLMNPQRSTUVWY",
                className:     "code"
            };

            // get a random string from the given set,
            // or from the 33 - 125 ASCII range
            function randomString(set, length) {
                var string = "", i, glyph;
                for(i = 0 ; i < length ; i++) {
                    glyph = Math.random() * set.length;
                    string += set[glyph | 0];
                }
                return string;
            }

            function animate(element, options) {
                var text = element.text(),
                        span = $("<span/>").addClass(options.className).insertAfter(element),
                        interval = options.duration / (text.length * options.stepsPerGlyph),
                        step = 0,
                        length = 0,
                        stepper = function () {
                            if(++step % options.stepsPerGlyph === 0) {
                                length++;
                                element.text(text.slice(0, length));
                            }
                            if(length <= text.length) {
                                span.text(randomString(options.codeGlyphs, text.length - length));
                                setTimeout(stepper, interval);
                            } else {
                                span.remove();
                            }
                        };
                element.text("");
                stepper();
            }

            // Basic jQuery plugin pattern
            return function (options) {
                options = $.extend({}, defaultOptions, (options || {}));
                return this.each(function () {
                    animate($(this), options);
                });
            };
        }(jQuery));


        /* MSA */

        function initMSA(){

            // this is a way how you use a bundled file parser
            msa = require("msa");

            var opts = {colorscheme: {"scheme": "clustal"}};

            opts.el = document.getElementById("yourDiv");
            opts.vis = {
                conserv: false,
                overviewbox: true,
                seqlogo: true,

                labels: true,
                labelName: true,
                labelId: false,
                labelPartition: false,
                labelCheckbox: false
            };
            opts.conf = {
                dropImport: true
            };
            opts.zoomer = {
                // Alignment viewer is not scrolling with 'alignmentWidth: "auto"', use fixed numbers instead or
                // use script for handling
                alignmentHeight: 525, alignmentWidth: 900, labelNameLength: 165, labelWidth: 85,labelFontsize: "13px",labelIdLength: 75,   menuFontsize: "12px",menuMarginLeft: "2px", menuPadding: "0px 10px 0px 0px", menuItemFontsize: "14px", menuItemLineHeight: "14px", autoResize: true
            };
            if (validateFasta(myCodeMirror.getValue())){
                opts.seqs = readFastaText(myCodeMirror.getValue());
                console.log(opts.seqs)
            }
            if (validateClustal(myCodeMirror.getValue())) {
                opts.seqs = (clustalParser(myCodeMirror.getValue()));
            }
            if (!validateFasta(myCodeMirror.getValue()) && !validateClustal(myCodeMirror.getValue()))  { alert("currently, the alignmentviewer supports only fasta and clustal inputs."); }
            // init msa

            var ms = new msa.msa(opts);
            var menuOpts = {};
            menuOpts.el = document.getElementById('div');
            menuOpts.msa = ms;
            var defMenu = new msa.menu.defaultmenu(menuOpts);
            //ms.addView("menu", defMenu);

            // call render at the end to display the whole MSA
            ms.render();

        }



        // hides tools for forwarding that are not able to process the current format
        function hideTools(currentVal) {
                console.log(currentVal)
                var ddl = $('#forwardTool');
                for (var m = 0; m < ddl.length; m++) {
                    for (var i = 0; i < ddl[m].length; i++) {
                         ddl[m].options[i].disabled = false;
                    }
                }
            if (currentVal == 'Genbank') {
                $('#clans').prop('disabled', true);
                $('#csblast').prop('disabled', true);
                $('#hhblits').prop('disabled', true);
                $('#hhpred').prop('disabled', true);
                $('#hmmer3').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#psiblast').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);

            }
            else if (currentVal == 'NEXUS') {
                $('#clans').prop('disabled', true);
                $('#csblast').prop('disabled', true);
                $('#hhblits').prop('disabled', true);
                $('#hhpred').prop('disabled', true);
                $('#hmmer3').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#psiblast').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'EMBL') {
                $('#clans').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'Phylip') {
                $('#clans').prop('disabled', true);
                $('#csblast').prop('disabled', true);
                $('#hhblits').prop('disabled', true);
                $('#hhpred').prop('disabled', true);
                $('#hmmer3').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#psiblast').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'A3M') {
                $('#clans').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'Clustal') {
                $('#clans').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'Fasta') {

            }
            else if (currentVal == 'Stockholm') {
                $('#clans').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
            else if (currentVal == 'PIR') {
                $('#clans').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }else{
                $('#clans').prop('disabled', true);
                $('#csblast').prop('disabled', true);
                $('#hhblits').prop('disabled', true);
                $('#hhpred').prop('disabled', true);
                $('#hmmer3').prop('disabled', true);
                $('#mafft').prop('disabled', true);
                $('#psiblast').prop('disabled', true);
                $('#tcoffee').prop('disabled', true);
            }
        }

        function hideFormats(currentVal) {

                var ddl = $('#outformat');
                for (var m = 0; m < ddl.length; m++) {
                    for (var i = 0; i < ddl[m].length; i++) {
                         ddl[m].options[i].disabled = false;
                    }
                }
                 switch(currentVal) {
            case "Fasta":
                $('#Fasta').prop('disabled', true);
                break;
            case "A3M":
                $('#A3M').prop('disabled', true);
                break;
            case "Phylip":
                $('#Phylip').prop('disabled', true);
                break;
            case "Clustal":
                $('#Clustal').prop('disabled', true);
                break;
            case "Nexus":
                $('#NEXUS').prop('disabled', true);
                break;
            case "EMBL":
                $('#EMBL').prop('disabled', true);
                break;
            case "Genbank":
                $('#Genbank').prop('disabled', true);
                break;
            case "PIR":
                $('#PIR').prop('disabled', true);
                break;
            case "Stockholm":
                $('#Stockholm').prop('disabled', true);
                break;
            default:
                $('#Fasta').prop('disabled', true);
                $('#A3M').prop('disabled', true);
                $('#Phylip').prop('disabled', true);
                $('#Clustal').prop('disabled', true);
                $('#NEXUS').prop('disabled', true);
                $('#EMBL').prop('disabled', true);
                $('#Genbank').prop('disabled', true);
                $('#PIR').prop('disabled', true);
                $('#Stockholm').prop('disabled', true);
                break;
        }

            }


            /* Forwarding */

            function forward(tool) {
                if(myCodeMirror2.lineCount()>1) {
                var seqs = myCodeMirror2.getValue ( ) ;
                localStorage.setItem ( "resultcookie", seqs ) ;
                window.location.href = "/#/tools/" + tool ;
                } else alert("No output to forward.");
               }


    </script>