@import de.proteinevolution.models.database.results.HHomp.HHompResult
@import better.files._
@(jobID: String, result: HHompResult, tool: de.proteinevolution.models.Tool, htmlPath: String)(implicit request: RequestHeader)
@if(result.num_hits < 1) {
    <div class="callout alert noHitsWide" id="noHits">
        No hits found!
    </div>
} else {
    @* Loads ForwardModals *@
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort + "_hhomp")
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" onclick="scrollToSection('visualization')">Vis</a>
                <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hits</a>
                <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Aln</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">
                <a id="forwardButtonHHsuite" data-open="forwardModal_@{
                    tool.toolNameShort
                }_hhomp">Forward Query A3M</a>
                <a onclick="colorAA()" class="colorAA">Color Seqs</a>
                <a onclick="wrap()" id="wrap">Wrap Seqs</a>
                </div>
        </div>
    </div>
    <br>
    <text class="notePlain">Number of hits: <b>@result.num_hits</b></text><br>
    <text class="notePlain">Overall probability of the query to be an OMP: <b>@result.overall_prob%</b></text>
    <br>


    @* Load html Map used for the image representation *@
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div>
            <a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}')" type="button" id="resubmitSection">
                Resubmit section
            </a>
        </div>
        <div id='blastviz'>
            <div class='flat-slider' id='flat-slider'></div>
            @Html(htmlPath.toFile.contentAsString)
            <p><img src="files/@jobID/@{
                jobID
            }.png" border="0" alt="blasthits" usemap="#blastmap"></p>
        </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
        <table id="htb" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Nr</th>
                    <th>Hit</th>
                    <th>Name</th>
                    <th>Prob (hits)</th>
                    <th>Prob (OMP)</th>
                    <th>E-value</th>
                    <th>SS</th>
                    <th>Cols</th>
                    <th>Target Length</th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitleHHpred">Alignments</h5>
            <form id="hhpred_templates">
                <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                    <tr>
                        <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                    </tr>
                    <tr>
                        <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div id="toolReferences">
        <h5 id="refTitle">References</h5>
        If you use our HHomp server for your research, please cite:
        <div class="citation">
            <div>The MPI bioinformatics Toolkit as an integrative platform for advanced protein sequence and structure analysis.<br>
                Alva V, Nam SZ, Söding J, Lupas AN.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkw348" target="_blank" rel="noopener"> Nucleic Acids Res. 2016 Jul 8;44(W1):W410-5</a>.
            </div>
        </div>
            And the HHomp paper:
        <div class="citation">
            <div>HHomp--prediction and classification of outer membrane proteins.<br>
                Remmert M, Linke D, Lupas AN, Söding J.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkp325" target="_blank" rel="noopener"> Nucleic Acids Res. 2009 Jul;37:W446-51</a>.</div>
                    </div>
        </div>
    <hr id="line-element" colspan="4" class="horizontal-line">


    @*MODALS*@
    <div class="reveal" id="templateAlignmentModalhhomp" data-reveal>
        <p>Template Alignment (~100 most distinct sequences)</p><br>
        <textarea rows="35" id="alignmentTemplatehhomp" placeholder="Loading..." spellcheck="false"></textarea>
        <button class="close-button" id="alignmentTemplateClose" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

}
<script>

        $("#templateAlignmentModalhhomp").bind('closed.zf.reveal', (function () {
            $.LoadingOverlay("hide");
        }));

        var colorAAs = true;
        var shownHits = 100;
        var showMore = 100;
        var numHits = @{result.num_hits};
        var jobID = '@{jobID}';
        var loading = false;
        var wrapped = true;


        $(document).ready(function () {
            hitlistBaseFunctions();
            if (numHits > 0) {
                $("#wrap").text("Unwrap Seqs");
                $("#wrap").addClass("colorToggleBar");
                drawDataTable();
                var firstQueryStart = @{if(result.num_hits > 0){ result.HSPS.head.query.start}};
                var firstQueryEnd = @{if(result.num_hits > 0){ result.HSPS.head.query.end}};
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
                shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits, wrapped, colorAAs);
                $('#templateAlignmentModalhhomp').foundation();
                $(".colorAA").addClass("colorToggleBar");
                $("#wrap").hide();
                $(".colorAA").hide();
            }

        });


        function drawDataTable() {
            hitlist = $('#htb').dataTable({
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "/api/job/results/dataTableHHomp/" + jobID,
                "autoWidth": false,
                "lengthMenu": [[10, 25, 50, 100, numHits], [10, 25, 50, 100, "All"]],
                "searching": false,
                "iDisplayLength": 25
            });
        }


        function templateAlignment(accession) {
            $.LoadingOverlay("show");
            $('textarea#alignmentTemplatehhomp').val(" ");
            // replace '#' for url
            accession = accession.replace("#", "%23");

            $.ajax({
                type: 'GET',
                url: '/templateAlignmentHHomp/' + jobID + '/' + accession,
                error: function(){
                    $.LoadingOverlay("hide");
                }
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/' + jobID + '/' + accession + '.fas',
                    error: function(){
                        $.LoadingOverlay("hide");
                    }
                }).done(function (data) {
                    $("#alignmentTemplatehhomp").val(data.toString());
                    $.LoadingOverlay("hide");
                });
            }).fail(function () {
                $("#alignmentTemplatehhomp").val("Sorry, failed to fetch Template Alignment.");
                $.LoadingOverlay("hide");
            });

        }

        function @{tool.toolNameShort}_forwardQueryMSA(selectedTool) {
            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: "files/" + jobID + "/reduced.a3m"
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        }

        function getHits(start, end, isWrapped, isColor) {
            if (start <= numHits && end <= numHits && !loading) {
                var data = { "start": start, "end": end, "isColor": isColor, "wrapped": isWrapped };
                loading = true;
                $('#loadingHits').show();
                $('#loadHits').hide();
                var route = jsRoutes.controllers.HHompController.loadHits(jobID);
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
                    loading = false;
                    $('#loadingHits').hide();
                    if (shownHits !== numHits) {
                        $('#loadHits').show();
                    }
                    $("#alignments").floatingScroll('init');
                });
            }
            // hide loadHits

        }
</script>
