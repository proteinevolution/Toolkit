@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import modules.tel.TEL
@import models.database.results.HHBlitsResult
@(jobID: String, result: HHBlitsResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    @* Load html Map used for the image representation *@
    <div class="scrollContainer">
        <div id="scrollLinks">
            <a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a>
            <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a>
            <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a>
        </div>
        <span class="headerDivider"></span>
        <div id="controlls">
            <a onclick="selectAll()" class="selectAllSeq">Select all</a>
            <a data-open="forwardModal_@{tool.toolNameShort}">Forward</a>
            <a data-open="forwardModal_@{tool.toolNameShort}_hhsuite">Forward Query MSA</a>
        </div>
    </div>
    <br>
    Number of sequences: @result.num_hits
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div><a class="success button tiny resubmitSection" onclick="resubmitSection()" type="button" id="resubmitSection">Resubmit section</a></div>
            <div id='blastviz'>
                <div class='flat-slider' id='flat-slider'></div>
                @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
                <table id="htb" class="display" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Probability</th>
                            <th>E-value</th>
                            <th>Cols</th>
                            <th>Length of Target</th>
                        </tr>
                    </thead>
                </table>
    </div>
    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitle">Alignments</h5>
                <form id="hhpred_templates">
                    <table class="unstriped">
                        <tbody id="alignmentTable">
                        </tbody>
                    </table>
                </form>
        </div>
    </div>
}

@*MODALS*@


<div class="reveal" id="templateAlignmentModal" data-reveal>
    <h3>Template Alignment</h3>
    <div>
        <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
            <option value="" selected>Forward To</option>
            <option value="modeller" >Modeller</option>
        </select>
    </div>
    <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>
        var jobID = '@{jobID}';
        var fileUrlQueryMSA = "/files/"+jobID+"/"+jobID+".rep100.json";
        var fileUrlQueryMSAFas = "/files/"+jobID+"/"+jobID+".rep100.fas";
        var checkbox = "checkbox";
        var selectAllBool = false;
        var numHits = @{result.num_hits};
        var shownHits = 50;
        var showMore = 100;
	var loading = false;
        // use this array to store
        // checked checkboxes
        // due to pagination/lazyload
        var checkboxes = [];

        $(document).ready( function(){
            hitlistBaseFunctions();
            if(numHits > 0 ){
                drawDataTable();
                var firstQueryStart = @result.HSPS.head.query.start;
                var firstQueryEnd = @result.HSPS.head.query.end;
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
		shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits);
                $('#templateAlignmentModal').foundation()
            }
        });


        $(document).ready(function () {
            setTimeout(function () {
                $("#alignments").floatingScroll('init');
            }, 2000);
        });
        function drawDataTable(){
            hitlist = $('#htb').dataTable({
                "bProcessing" : true,
                "bServerSide" : true,
                "sAjaxSource" : "/api/job/results/dataTableHHblits/@jobID",
                "lengthMenu": [[10, 25, 50, numHits], [10, 25, 50, "All"]],
                "searching": false,
                "iDisplayLength": 25
            });
        }


        function selectAll(){
            selectAllBool = !selectAllBool;
            if(selectAllBool) {
                selectAllHelper(checkbox);
                $(".selectAllSeq").addClass("colorToggle");
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits+1).forEach(function(x){checkboxes.push(x)});
            }
            else {
                deselectAll(checkbox);
                $(".selectAllSeq").removeClass("colorToggle");
                // delete all checkboxes from array
                checkboxes = [];
            }
        }


       function hhblits_forward(selectedTool, boolSelectedHits,boolEvalue, evalue, boolFullLength){
            if(boolFullLength) {
                if(boolEvalue) {
                    var route = jsRoutes.controllers.HHblitsController.evalFull('@jobID', evalue);
                }else{
                    var route = jsRoutes.controllers.HHblitsController.full('@jobID', checkboxes);
                }
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    $.ajax({
                        type: 'GET',
                        url: 'files/@jobID/sequences.fa'
                    }).done(function (data_) {
                        forward(selectedTool, data_.toString());
                    });
                });
            } else{

                if(boolEvalue) {
                    route = jsRoutes.controllers.HHblitsController.alnEval('@jobID', evalue);
                }else{
                    route = jsRoutes.controllers.HHblitsController.aln('@jobID', checkboxes);
                }
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    $.ajax({
                        type: 'GET',
                        url: 'files/@jobID/alignment.fas'
                    }).done(function (data_) {
                        forward(selectedTool, data_.toString());
                    });
                });

            }
        }



        function hhblits_forwardQueryMSA(selectedTool){
            $.ajax({
                type: 'GET',
                url: fileUrlQueryMSAFas
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        }

        function resubmitSection(){
            resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
        }


        function templateAlignment(accession){
            $('textarea#alignmentTemplate').val(" ");
            // replace '#' for url
            accession = accession.replace("#", "%23");

            $.ajax({
                type: 'GET',
                url: '/templateAlignmentHHblits/@jobID/' + accession
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/@jobID/' + accession + '.fas'
                }).done(function (data) {
                    $("#alignmentTemplate").val(data.toString());
                });
            }).fail(function () {
                $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
            });
        }


        function forwardTemplateAlignment_(tool, forwardData){
            if(tool == ""){
                return;
            }
            $('#templateAlignmentModal').foundation('close');
            forward(tool, forwardData);
        }


        function getHits(start, end){
            if(start <= numHits && end <= numHits){
                loading = true;
                var route = jsRoutes.controllers.HHblitsController.loadHits(jobID,start, end);
                return $.ajax({
                    method: route.method,
                    url: route.url
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
		    loading = false;
                });
            }
        }


</script>
