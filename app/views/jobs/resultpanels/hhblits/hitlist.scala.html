@import de.proteinevolution.tools.results.HHBlits.HHBlitsResult
@import better.files._
@import play.twirl.api.Html
@(jobID: String, result: HHBlitsResult, tool: de.proteinevolution.models.Tool, htmlPath: String)()
    @if(result.num_hits < 1) {
        <div class="callout alert noHitsWide" id="noHits">
            No hits found!
        </div>
    } else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort, "")
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    @* Load html Map used for the image representation *@
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" name="#visualization" onclick="scrollToSection('visualization')">Vis</a>
                <a id="hitlistScroll" name="#hitlist" onclick="scrollToSection('hitlist')">Hits</a>
                <a id="alignmentsScroll" name="#alignments" onclick="scrollToSection('alignments')">Aln</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">
                <a onclick="selectAll()" class="selectAllSeqBar" id="extraWide">Select all</a>
                <a id="forwardButtonNormal" data-open="forwardModal_@{
                    tool.toolNameShort
                }">Forward</a>
                <a id="forwardButtonHHsuite" data-open="forwardModal_@{
                    tool.toolNameShort
                }_hhsuite">Forward Query A3M</a>
                <a onclick="wrap()" id="wrap">Wrap Seqs</a>
            </div>
        </div>
    </div>
    <br>
    <span class="notePlain">Number of hits: <b>@result.num_hits</b></span>
    <br>

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <br>
        <span class="note"><b> We have detected</b></span>

    }
    @if(result.TMPRED == "1"){

        <span class="note"><b> @result.TMPRED transmembrane helix</b></span>
    }
    @if(result.TMPRED.toInt > 1){

        <span class="note"><b> @result.TMPRED transmembrane helices</b></span>
    }
    @if((result.TMPRED == "1" || result.TMPRED.toInt > 1) && result.COILPRED == "0"){
        <span class="note"><b> and </b></span>

    }
    @if(result.COILPRED == "0"){
        <span class="note"><b>coiled-coil segments </b></span>
    }

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <span class="note"><b> in your query protein!</b></span>

    }

    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div><a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}')" type="button" id="resubmitSection">Resubmit section</a></div>
            <div id='blastviz'>
                <div class='flat-slider' id='flat-slider'></div>
                @{Html(htmlPath.toFile.contentAsString)}
                <p><img src="files/@{jobID + "/" + jobID + ".png"}" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
                <table id="htb" class="display" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Probability</th>
                            <th>E-value</th>
                            <th>Cols</th>
                            <th>Length of Target</th>
                        </tr>
                    </thead>
                </table>
    </div>
    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitle">Alignments</h5>
                <form id="hhpred_templates">
                    <table class="unstriped">
                        <tbody id="alignmentTable">
                        </tbody>
                        <tr>
                            <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                        </tr>
                        <tr>
                            <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                        </tr>
                    </table>
                </form>
        </div>
    </div>
    <br>
    <div id="toolReferences">
        <h5 id="refTitle">References</h5>

        If you use our HHblits server for your research, please cite:
        <div class="citation">
            @views.html.help.common.toolkit_citation_results()
        </div>
        And the HHblits paper:
        <div class="citation">
            <div>HHblits: lightning-fast iterative protein sequence searching by HMM-HMM alignment.<br>
                Remmert M, Biegert A, Hauser A, SÃ¶ding J.<a href="https://www.nature.com/nmeth/journal/v9/n2/full/nmeth.1818.html" target="_blank" rel="noopener"> Nat Methods. 2011 Dec 25;9(2):173-5</a>.
            </div>
        </div>
    </div>
    <hr id="line-element" class="horizontal-line">

}

@*MODALS*@


<div class="reveal" id="templateAlignmentModal" data-reveal>
    <p>Template Alignment (~100 most distinct sequences)</p>
    <div>
        <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
            <option value="" selected>Forward To</option>
            <option value="formatseq" >FormatSeq</option>
            <option value="hhblits" >HHblits</option>
            <option value="hhomp" >HHomp</option>
            <option value="hhpred" >HHpred</option>
            <option value="hhrepid" >HHrepID</option>
        </select>
    </div>
    <textarea rows="35" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
    <button class="close-button" id="alignmentTemplateClose" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>
        $("#templateAlignmentModal").bind('closed.zf.reveal', (function () {
            $('#alignmentTemplate_tool').val('');
            $.LoadingOverlay("hide");
        }));
        var jobID = '@{jobID}';
        var fileUrlQueryMSAFas = "/files/"+jobID+"/reduced.a3m";
        var checkbox = "checkbox";
        var selectAllBool = false;
        var numHits = @{result.num_hits};
        var shownHits = 50;
	var loading = false;
        var wrapped = true;
        var colorAAs = false;
        // use this array to store
        // checked checkboxes
        // due to pagination/lazyload
        var checkboxes = [];

        $(document).ready( function(){
            hitlistBaseFunctions();
            if(numHits > 0 ){
                $("#wrap").text("Unwrap Seqs");
                $("#wrap").addClass("colorToggleBar");
                new DataTables("hhblits").config(jobID, numHits);
                var firstQueryStart = @{if(result.num_hits > 0){ result.HSPS.head.query.start}};
                var firstQueryEnd = @{if(result.num_hits > 0){ result.HSPS.head.query.end}};
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
		        shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits, wrapped);
                $('#templateAlignmentModal').foundation();
                $("#wrap").hide();
            }

        });

        function selectAll(){
            selectAllBool = !selectAllBool;
            $(".selectAllSeqBar").toggleClass("colorToggleBar");
            $(".selectAllSeqBar").toggleText("Select all","Deselect all");
            if(selectAllBool) {
                selectAllHelper(checkbox);
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits+1).forEach(function(num){return checkboxes.push(num)});
            }
            else {
                deselectAll(checkbox);
                // delete all checkboxes from array
                checkboxes = [];
            }
        }

       function hhblits_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength){
           var data = {"checkboxes": checkboxes.removeDuplicates()};
           var route = null;
           var filename = generateFilename();
           $.LoadingOverlay("show");
            if(boolFullLength) {
                if(boolEvalue) {
                    data.evalue = evalue;
                    data.fileName = filename;
                    route = jsRoutes.controllers.HHblitsController.evalFull(jobID);
                }else{
                    data.fileName = filename;
                    route = jsRoutes.controllers.HHblitsController.full(jobID);
                    if(data.checkboxes.length === 0){
                        $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                        $.LoadingOverlay("hide");
                        alert("No sequences selected!");
                        return false;
                    }
                }
            } else{

                if(boolEvalue) {
                    data.evalue = evalue;
                    data.fileName = filename;
                    route = jsRoutes.controllers.HHblitsController.alnEval(jobID);
                }else{
                    if(data.checkboxes.length === 0){
                        $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                        $.LoadingOverlay("hide");
                        alert("No sequences selected!");
                        return false;
                    }
                    data.fileName = filename;
                    route = jsRoutes.controllers.HHblitsController.aln(jobID);
                }
            }

           $.ajax({
               url: route.url,
               method: route.method,
               contentType: "application/json",
               data: JSON.stringify(data),
               error: function(){
                   $.LoadingOverlay("hide")
               }
           }).done(function (data_) {
                   forwardPath(selectedTool, 'files/@jobID/'+filename+'.fa');
           });
        }

        function hhblits_forwardQueryMSA(selectedTool){
            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: fileUrlQueryMSAFas
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        }

        function templateAlignment(accession){
            $('textarea#alignmentTemplate').val(" ");
            // replace '#' for url
            accession = accession.replace("#", "%23");
            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: '/templateAlignmentHHblits/@jobID/' + accession
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/@jobID/' + accession + '.ra3m',
                    error: function(){
                        $.LoadingOverlay("hide")
                    }
                }).done(function (data) {
                    $("#alignmentTemplate").val(data.toString());
                    $.LoadingOverlay("hide");
                })
            }).fail(function () {
                $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
                $.LoadingOverlay("hide")
            })
        }


        function forwardTemplateAlignment_(tool, forwardData){
            if(tool === ""){
                return;
            }
            $.LoadingOverlay("show");
            $('#templateAlignmentModal').foundation('close');
            forward(tool, forwardData);
        }


        function getHits(start, end, wrapped){
            if(start <= numHits && end <= numHits && !loading){
                var data = {"start": start, "end": end, "wrapped": wrapped};
                loading = true;
                $('#loadingHits').show();
                $('#loadHits').hide();
                var route = jsRoutes.controllers.HHblitsController.loadHits(jobID);
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
		            loading = false;
                    $('#loadingHits').hide();
                    if (shownHits !== numHits) {
                        $('#loadHits').show();
                    }
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                    $("#alignments").floatingScroll('init');
                });
            }
        }

</script>

