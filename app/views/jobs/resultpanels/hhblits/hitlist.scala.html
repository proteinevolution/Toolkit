@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import modules.tel.TEL
@import models.database.results.HHBlitsResult
@(jobID: String, result: HHBlitsResult, tool: models.tools.Tool)(implicit request: RequestHeader)

@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    @* Load html Map used for the image representation *@
    <div class="container" id="loadingDiv"></div>
    <ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Visualization</a>
            <div class="accordion-content" data-tab-content>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                        Resubmit section</a>
                    <div id='blastviz'>
                        @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                        <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                    </div>
                </div>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Hitlist</a>
            <div class="accordion-content" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span class="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>
                <table id="htb" class="display" cellspacing="0" width="80%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Probability</th>
                            <th>E-value</th>
                            <th>Cols</th>
                            <th>Length of Target</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item id="alignmentAccordion">
            <a href="#" class="accordion-title">Alignments</a>
            <div id="alignments" class="accordion-content" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span class="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>

                <form id="hhpred_templates">
                    <table class="unstriped">
                        <tbody>
                            Number of sequences: @result.num_hits
                            <br />
                            <br />
                            @for(hit <- result.HSPS){
                                @* hit number, links *@
                                <tr>
                                    <td></td>
                                    <td colspan="3">
                                    @BlastVisualization.getLinksHHpred(hit.template.accession)
                                    </td>
                                    <td></td>
                                </tr>
                                @* checkboxes, accession, name of hit*@
                                <tr class="header">
                                    <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{hit.num}'> @{hit.num}.</td>
                                <td colspan="4">
                                    @BlastVisualization.getSingleLink(hit.template.accession)
                                    @{"  "+ hit.description}
                                </td>
                                </tr>
                                @* Alignment Details*@
                                <tr>
                                    <td></td>
                                    <td colspan="4">Probability: @{hit.info.probab}, E-value: @{hit.info.evalue},
                                        Score: @{hit.info.score}, Aligned Cols: @{hit.info.aligned_cols},
                                        Identities: @{BlastVisualization.percentage(hit.info.identities.toString)},
                                        Similarity: @{hit.info.similarity}


                                </td>
                                </tr>
                                <tr>
                                    <td><br /></td>
                                </tr>

                                @if(!hit.query.seq.isEmpty) {
                                    @{
                                        BlastVisualization.makeRow("sequence", Array("Q",hit.query.accession, hit.query.start.toString, BlastVisualization.colorRegexReplacer(hit.query.seq),hit.query.end.toString,"("+hit.query.ref+")"))
                                    }
                                }
                                @*Consensus of query, if present*@
                                @if(!hit.query.consensus.isEmpty) {
                                    @{
                                        BlastVisualization.makeRow("sequence", Array("Q", "Consensus",hit.query.start.toString, hit.query.consensus,hit.query.end.toString,"("+hit.query.ref+")"))
                                    }
                                }
                                @* agree of query, if present *@

                                @BlastVisualization.makeRow("sequence", Array("","","",hit.agree, ""))

                                @*  consensus template, if present *@
                                @if(!hit.template.consensus.isEmpty) {
                                    @{
                                        BlastVisualization.makeRow("sequence", Array("T", "Consensus",hit.template.start.toString, hit.template.consensus,hit.query.end.toString,"("+hit.template.ref+")"))
                                    }
                                }
                                @*  seq template, if present *@
                                @if(!hit.template.seq.isEmpty) {
                                    @{
                                        BlastVisualization.makeRow("sequence", Array("T",hit.template.accession, hit.template.start.toString, BlastVisualization.colorRegexReplacer(hit.template.seq),hit.template.end.toString,"("+hit.query.ref+")"))
                                    }
                                }
                                <tr>
                                    <td colspan="5"><hr id="line-element" colspan="4" class="horizontal-line"></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </form>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Information</a>
            <div class="accordion-content" data-tab-content>
                <table class="display" cellspacing="0" width="80%">
                    <tr>
                        <td>Query</td>
                        <td id="hhpred_query"></td>
                    </tr>
                    <tr>
                        <td>Match_columns</td>
                        <td id="hhpred_match_columns"></td>
                    </tr>
                    <tr>
                        <td>No_of_Seqs</td>
                        <td id="hhpred_noseqs"></td>
                    </tr>
                    <tr>
                        <td>Neff</td>
                        <td id="hhpred_neff"></td>
                    </tr>
                    <tr>
                        <td>Searched HMMs</td>
                        <td id="hhpred_searchedhmms"></td>
                    </tr>
                    <tr>
                        <td>Date</td>
                        <td id ="hhpred_date"></td>
                    </tr>
                </table>
            </div>
        </li>
    </ul>

}

@*MODALS*@


<div class="reveal" id="templateAlignmentModal" data-reveal>
    <h3>Template Alignment</h3>
    <div>
        <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
            <option value="" selected>Forward To</option>
            <option value="modeller" >Modeller</option>
        </select>
    </div>
    <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>

        var fileUrlQueryMSA = "/files/@jobID/@{jobID}.rep100.json";
        var fileUrlQueryMSAFas = "/files/@jobID/@{jobID}.rep100.fas";
        var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
        var hitlist;
        var selectAllBool_@{tool.toolNameShort} = false;
        var jobID;

        (function()  {
            // adding loading overlay
            $(document).ajaxStart(function(){
                $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
            });
            $(document).ajaxComplete(function(){
                $.LoadingOverlay("hide");
            });

            $('.slider').on('moved.zf.slider', function() {
                $('#lefthandle').html($('#hidden1').val());
                $('#lefthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
                $('#righthandle').html($('#hidden2').val());
                $('#righthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
            });
            if(@result.num_hits > 0){
            drawDataTable();
            drawInformation();
            //fill first query name and sequence for slider resubmit
            /* without timeout SLIDER is displayed */
            setTimeout(function () {
                slider_show('@{result.query.seq.length}', '@{result.HSPS{0}.query.start}', '@{result.HSPS{0}.query.end}');
            }, 1000);
            $("#accordion").foundation();
            $("#templateAlignmentModal").foundation();
        }
        })();


        $(document).ready(function () {
            setTimeout(function () {
                $("#alignments").floatingScroll('init');
            }, 2000);
        });


        function drawInformation(){
            /*  INFO TAB*/
        }

        function drawDataTable(){
            hitlist = $('#htb').dataTable({
                "bProcessing" : true,
                "bServerSide" : true,
                "sAjaxSource" : "/api/job/results/dataTableHHblits/@jobID"
            });
        }


        function _deselectAll(){
            deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
        }

        window["@{tool.toolNameShort}_selectAll"] = function () {
            selectAllDatatable(this.hitlist.fnGetNodes());
            this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
            if(this.selectAllBool_@{tool.toolNameShort}) {
                selectAll(checkbox_@{tool.toolNameShort});
                $(".selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
            }
            else {
                _deselectAll();
                $(".selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
            }
        };


        window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits,boolEvalue, evalue, boolFullLength){
            var checkedCheckboxes = getCheckedCheckboxes("checkbox_@{tool.toolNameShort}");
            if(boolFullLength) {
                if(boolEvalue) {
                    var route = jsRoutes.controllers.HHblitsController.evalFull('@jobID', evalue);
                    $.ajax({
                        url: route.url,
                        method: route.method
                    }).done(function () {
                        $.ajax({
                            type: 'GET',
                            url: 'files/@jobID/sequences.fa'
                        }).done(function (data_) {
                            forward(selectedTool, data_.toString());
                        });
                    });
                }else{
                    route = jsRoutes.controllers.HHblits.full('@jobID', checkedCheckboxes);
                    $.ajax({
                        url: route.url,
                        method: route.method
                    }).done(function (data_) {
                        $.ajax({
                            type: 'GET',
                            url: 'files/@jobID/sequences.fa'
                        }).done(function (data_) {
                            forward(selectedTool, data_.toString());
                        });
                    });
                }
            }else{

                if(boolEvalue) {
                    route = jsRoutes.controllers.HHblitsController.alnEval('@jobID', evalue);
                }else{
                    route = jsRoutes.controllers.HHblitsController.aln('@jobID', checkedCheckboxes);
                }
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    forward(selectedTool, data_);
                });

            }
        }


        window["@{tool.toolNameShort}_forwardQueryMSA"] = function(selectedTool){
            $.ajax({
                type: 'GET',
                url: fileUrlQueryMSAFas
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        };

        window["@{tool.toolNameShort}_resubmitSection"] = function(){
            resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
        };


        function templateAlignment(accession){
            $('textarea#alignmentTemplate').val(" ");
            // replace '#' for url
            accession = accession.replace("#", "%23");

            $.ajax({
                type: 'GET',
                url: '/templateAlignmentHHblits/@jobID/' + accession
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/@jobID/' + accession + '.fas'
                }).done(function (data) {
                    $("#alignmentTemplate").val(data.toString());
                });
            }).fail(function () {
                $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
            });
        }


        function forwardTemplateAlignment_(tool, forwardData){
            if(tool == ""){
                return;
            }
            $('#templateAlignmentModal').foundation('close');
            forward(tool, forwardData);
        }



</script>
