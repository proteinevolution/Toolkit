@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import modules.tel.TEL
@(jobID: String, jsValue: JsValue, tool: models.tools.Tool)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">

@if((jsValue \ jobID \ "hits").as[List[JsObject]].size < 1)  {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.forwardmodal(tool, tool.toolNameShort)

    @* Load html Map used for the image representation *@
    <div class="container" id="loadingDiv"></div>
    <ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Visualization</a>
            <div class="accordion-content" data-tab-content>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                        Resubmit section</a>
                    <div id='blastviz'>
                        @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                        <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                    </div>
                </div>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Hitlist</a>
            <div class="accordion-content" data-tab-content>
                <a type="button" class="button success tiny hhpred_extra_button" data-open="forwardModal_@{tool.toolNameShort}">Forward</a>
                <table id="htb" class="display" cellspacing="0" width="80%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Prob</th>
                            <th>E-value</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Alignments</a>
            <div id="alignments" class="accordion-content table-scroll" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>

                <form id="hhpred_templates">
                    <table class="unstriped">
                        <tbody>
                            Number of sequences: @{{jsValue \ jobID \ "hits"}.as[List[JsObject]].size}
                            <br />
                            <br />
                            @for((alignment, hit) <- ((jsValue \ jobID \ "alignments").as[List[JsObject]], (jsValue \ jobID \ "hits").as[List[JsObject]]).zipped.toList){
                                @* hit number, links *@
                                <tr>
                                    <td></td>
                                    <td colspan="3">
                                    @{alignment \ "template" \ "name" match {
                                        case JsDefined(jsValue) => BlastVisualization.getLinksHHpred((alignment \ "template" \ "name").get.as[String])
                                        case undefined: JsUndefined => BlastVisualization.getLinksHHpred("undefinedAccession") ;
                                    }
                                    }
                                    </td>
                                    <td></td>
                                </tr>
                                @* checkboxes, accession, name of hit*@
                                <tr class="header">
                                    <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{(hit \ "no").get}'> @{(hit \ "no").get}.</td>
                                <td colspan="4">

                                    @{alignment \ "template" \ "name" match {
                                        case JsDefined(jsValue) => {BlastVisualization.getSingleLink((alignment \ "template" \ "name").get.as[String])}
                                        case undefined: JsUndefined =>
                                    }
                                    }
                                    @{"  "+(alignment \ "header").get.as[String].replaceFirst(">", "")}
                                </td>
                                </tr>
                                @* Alignment Details*@
                                <tr>
                                    <td></td>
                                    <td colspan="4">Probability: @{(alignment \ "info" \ "probab").get}, E-value: @{(alignment \ "info" \ "eval").get},
                                        Score: @{(alignment \ "info" \ "score").get}, Aligned Cols: @{(alignment \ "info" \ "aligned_cols").get},
                                        Identities: @{BlastVisualization.percentage((alignment \ "info" \ "identities").get.toString)},
                                        Similarity: @{BlastVisualization.percentage((alignment \ "info" \ "similarity").get.toString)}


                                </td>
                                </tr>
                                <tr>
                                    <td><br /></td>
                                </tr>

                                @* seq of query, if present *@
                                @{alignment \ "query" \ "seq" match {
                                    case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("Q",(alignment \ "query" \ "name").get.as[String],(alignment \ "query" \ "start").get.toString(), BlastVisualization.colorRegexReplacer((alignment \ "query" \ "seq").get.as[String]),(alignment \ "query" \ "end").get.toString(),"("+(alignment \ "query" \ "ref").get+")".toString()))}
                                    case undefined: JsUndefined =>
                                }
                                }
                                @*Consensus of query, if present*@
                                @{alignment \ "query" \ "consensus" match {
                                    case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("Q", "Consensus",(alignment \ "query" \ "start").get.toString(), (alignment \ "query" \ "consensus").get.as[String],(alignment \ "query" \ "end").get.toString(),"("+(alignment \ "query" \ "ref").get+")".toString()))}
                                    case undefined: JsUndefined =>
                                }
                                }
                                @* agree of query, if present *@
                                @{alignment \ "agree" match {
                                    case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("","","",(alignment \ "agree").get.as[String], ""))}
                                    case undefined: JsUndefined =>
                                }
                                }
                                @*  consensus template, if present *@
                                @{alignment \ "template" \ "consensus" match {
                                    case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("T", "Consensus", (alignment \ "template" \ "start").get.toString(), (alignment \ "template" \ "consensus").get.as[String],(alignment \ "template" \ "end").get.toString(),"("+(alignment \ "template" \ "ref").get+(")").toString()))}
                                    case undefined: JsUndefined =>
                                }
                                }
                                @*  seq template, if present *@
                                @{alignment \ "template" \ "seq" match {
                                    case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("T", (alignment \ "template" \ "name").get.as[String], (alignment \ "template" \ "start").get.toString(), BlastVisualization.colorRegexReplacer((alignment \ "template" \ "seq").get.as[String]),(alignment \ "template" \ "end").get.toString(),"("+(alignment \ "template" \ "ref").get+")".toString()))}
                                    case undefined: JsUndefined =>
                                }
                                }
                                <tr>
                                    <td colspan="5"><hr id="line-element" colspan="4" class="horizontal-line"></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </form>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Information</a>
            <div class="accordion-content" data-tab-content>
                <table class="display" cellspacing="0" width="80%">
                    <tr>
                        <td>Query</td>
                        <td id="hhpred_query"></td>
                    </tr>
                    <tr>
                        <td>Match_columns</td>
                        <td id="hhpred_match_columns"></td>
                    </tr>
                    <tr>
                        <td>No_of_Seqs</td>
                        <td id="hhpred_noseqs"></td>
                    </tr>
                    <tr>
                        <td>Neff</td>
                        <td id="hhpred_neff"></td>
                    </tr>
                    <tr>
                        <td>Searched HMMs</td>
                        <td id="hhpred_searchedhmms"></td>
                    </tr>
                    <tr>
                        <td>Date</td>
                        <td id ="hhpred_date"></td>
                    </tr>
                </table>
            </div>
        </li>
    </ul>

}
<script>

        var data;
        var alignments;
        var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
        var hitlist;
        var selectAllBool_@{tool.toolNameShort} = false;
        var firstQueryName, firstQuerySequence, firstQueryStart, firstQueryEnd = null;
        var jobID;

        (function()  {
            // adding loading overlay
            $(document).ajaxStart(function(){
                $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
            });
            $(document).ajaxComplete(function(){
                $.LoadingOverlay("hide");
            });

            $('.slider').on('moved.zf.slider', function() {
                $('#lefthandle').html($('#hidden1').val());
                $('#lefthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
                $('#righthandle').html($('#hidden2').val());
                $('#righthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
            });

            var dataRoute = jsRoutes.controllers.DataController.get("@jobID");
            $.ajax({
                method: dataRoute.method,
                url: dataRoute.url
            }).done(function(data_) {
                jobID = data_.jobID;
                data = data_[jobID];
                var hits = data.hits;
                var info = data.info;
                alignments = data.alignments;

                if(alignments.length > 0){
                    drawDataTable(alignments);
                    drawInformation(info);

                    //fill first query name and sequence for slider resubmit

                    firstQueryName =  ">" + alignments[0].query.name;
                    firstQuerySequence = alignments[0].query.seq;
                    firstQueryStart = alignments[0].query.start;
                    firstQueryEnd = alignments[0].query.end;
                    /* without timeout SLIDER is displayed */
                    setTimeout(function () {
                        slider_show(info.Match_columns, firstQueryStart, firstQueryEnd)
                    }, 1000);

                    $("#accordion").foundation();
                    $("#templateAlignmentModal").foundation();


                }
            });

        })();


        function drawInformation(info ){
            /*  INFO TAB*/
            $("#hhpred_query").append(info.Query);
            $("#hhpred_match_columns").append(info.Match_columns);
            $("#hhpred_noseqs").append(info.No_of_seqs);
            $("#hhpred_neff").append(info.Neff);
            $("#hhpred_searchedhmms").append(info.Searched_HMMs);
            $("#hhpred_date").append(info.Date);
        }

        function drawDataTable(alignments){

            hitlist = $('#htb').dataTable({
                "bInfo": false,
                "bFilter": true,
                "bLengthChange": true,
                "aaData": alignments,
                "scrollY": 600,
                "scrollX": true,
                "aoColumns": [
                    { "mDataProp": "no" },
                    { "mDataProp": "template.name" , render: function (data){return getSingleLink(data)}},
                    { "mDataProp": "header" , render: function (data) {return data.replace(/;/g, "")}},
                    { "mDataProp": "info.probab" },
                    { "mDataProp": "info.eval" , render: function(data){return data.toExponential()}},
                    { "mDataProp": "info.score" },
                ],
                'columnDefs': [{
                    'targets': 0,
                    'searchable': false,
                    'orderable': true,
                    'render': function (data){
                        return '<input type="checkbox" name="templates" value="' + $('<div/>').text(data).html() + '"> ' + data;
                    }
                }]
            });

        }

        function _deselectAll(){
            deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
        }

        window["@{tool.toolNameShort}_selectAll"] = function () {
            selectAllDatatable(this.hitlist.fnGetNodes());
            this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
            if(this.selectAllBool_@{tool.toolNameShort}) {
                selectAll(checkbox_@{tool.toolNameShort});
                $("#selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
            }
            else {
                _deselectAll();
                $("#selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
            }
        };

        function checkAllBetterThan(evalue){
            var jsonData = {};
            jsonData.accessions = [];
            jsonData.seqs = [];
            jsonData.index = [];
            // get values of all checked Checkboxes
            alignments.forEach(function callback(currentValue) {
                if (currentValue.info.eval < evalue) {
                    $(":checkbox[value="+currentValue.no+"]").prop("checked","true");
                    jsonData.accessions.push(currentValue.template.name);
                    jsonData.seqs.push(currentValue.template.seq);
                    jsonData.index.push(currentValue.no-1);
                }
            });
            return jsonData;
        }


        function getCheckboxesData(){
            var jsonData = {};
            jsonData.accessions = [];
            jsonData.seqs = [];
            jsonData.index = [];


            // get all checked checkboxes and their respective accession
            $('input:checkbox.' + checkbox_@{tool.toolNameShort} + ":checked").each(function () {
                var index = $(this).val() - 1;
                var seq = alignments[index].template.seq;
                if (jsonData.seqs.indexOf(seq) == -1) {
                    jsonData.accessions.push(alignments[index].template.name);
                    jsonData.seqs.push(seq);
                    jsonData.index.push(index);
                }
            });
            return jsonData;
        }

        window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits,boolEvalue, evalue, boolFullLength){
            var dataTmp = preprocessingForward(selectedTool, boolSelectedHits,boolEvalue, evalue);
            // full seq is retrieved
            if(boolFullLength) {
                // retrieve full Seq
                var jsonData = new Object();
                jsonData.db =  chosenDB;
                jsonData.accessionsStr = dataTmp.accessions.join(" ");


                $.ajax({
                    url: 'retrieveFullSeq/@jobID',
                    contentType: "application/json",
                    type: 'POST',
                    data: JSON.stringify(jsonData)
                }).done(function() {
                    $.ajax({
                        type: 'GET',
                        url: 'files/@jobID/sequences.fa'
                    }).done(function (data_) {
                        forward(tool, data_.toString());
                    });
                });
            }else{
                var forwardData = '';
                // get slider range
                var sliderRange = getSliderRange();
                var alignmentData;
                // get alignment json
                var fileUrl = "/files/"+jobID+"/"+jobID+".full.json";
                $.getJSON(fileUrl, function (data_) {
                    alignmentData = data_;
                    for(var i=0; i < dataTmp.index.length; i++){
                        // index + number of querys because alignment json contains query sequences in alignment first
                        var index = dataTmp.index[i];
                        forwardData += ">" + alignmentData[index][0] + '\n';
                        forwardData += alignmentData[index][1].substr(sliderRange[0] - 1, sliderRange[1]) + '\n';
                    }
                    forward(tool, forwardData);
                });
            }
        }


        window["@{tool.toolNameShort}_resubmitSection"] = function(){
            resubmitSection(firstQuerySequence, firstQueryName);
        };


</script>
