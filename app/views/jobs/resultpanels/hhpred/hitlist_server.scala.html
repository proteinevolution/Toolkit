@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.HHpred
@(jobID: String, jsValue: JsValue)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">
@* Load html Map used for the image representation *@
<ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            <div class='flat-slider' id='flat-slider'></div>
            <div id='blastviz'>
            <a class="success button tiny resubmitSection" onclick="resubmitSection_()" type="button" id="resubmitSection">
                Resubmit section</a>
            <div id='blastviz'>
                @HHpred.html(s"$jobID/results/$jobID.html_NOIMG")
                <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
            </div>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <table id="htb" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Hit</th>
                        <th>Name</th>
                        <th>Prob</th>
                        <th>E-value</th>
                        <th>P-value</th>
                        <th>Score</th>
                        <th>SS</th>
                        <th>Cols</th>
                        <th>qStart</th>
                        <th>qEnd</th>
                        <th>tStart</th>
                        <th>tEnd</th>
                        <th>Ref</th>
                    </tr>
                </thead>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="alignments" class="accordion-content table-scroll" data-tab-content>
            <ul id="accordion" class="accordion forward_panel" data-accordion data-multi-expand="true" data-allow-all-closed="true">
                <li class="accordion-item" data-accordion-item>
                    <a href="#" class="accordion-title" style="background-color: #eee;">Forward</a>
                    <div id="alignments" class="alignments accordion-content forward_panel_content" data-tab-content>
                            <a class="success button tiny hhpred_extra_button" onclick="forwardHmm();" type="button">
                            Forward Hmm</a>
                    </div>
                </li>
            </ul>
            <div id="hhpred_alignment_control">
                <div id="hhpred_histo">
                    <a type="button" class="button success tiny hhpred_extra_button" onclick="toggleHistogram()">Histogram</a>
                </div>
                <div id="hhpred_advanced" >
                    <a type="button" class="button success tiny hhpred_extra_button" onclick="hhpred_manual()">Manual template selection</a>
                    <a type="button" class="button success tiny hhpred_extra_button" onclick="hhpred_automatic()">Select Templates Automatically</a>
                </div>
            </div>
            <!-- TODO FIX Coloring David -->
            <div class="colorOpts">
                <a onclick="selectAll_()" type="button" id="selectAllSeq">Select all</a>
                <a onclick='toggleAliColor_("letters")' type="button"><span id="letterColor">Color letters</span></a>
                <a onclick='toggleAliColor_("background")' type="button"><span id="backgroundColor">Color background</span></a>
                <a onclick="toggleSS_()" type="button"><span id="onlySS">Color only SS</span></a>
            </div>

            <form id="hhpred_templates">
                @for((alignment, hit) <- ((jsValue \ "hhr" \ "alignments").as[List[JsObject]], (jsValue \ "hhr" \ "hits").as[List[JsObject]]).zipped.toList){
                  <table class="unstriped">
                    <tbody>
                        @* hit number, links *@
                        <tr>
                            <td></td>
                            <td>No  @{(hit \ "no").get}</td>
                            <td></td>
                            <td>
                            @{hit \ "struc" match {
                                    case JsDefined(jsValue) => HHpred.getLinks((hit \ "struc").get.as[String])
                                    case undefined: JsUndefined => Logger.info("hit.struc undefined in results!")
                                }
                            }
                            </td>
                            <td></td>
                        </tr>
                        @* checkboxes, accession, name of hit*@
                        <tr class="name">
                            <td><input type="checkbox" name="templates" class="hitCheckbox" value='@{(hit \ "no").get}'></td>
                            <td colspan="2">
                            @{hit \ "struc" match {
                                case JsDefined(jsValue) => {HHpred.getSingleLink((hit \ "struc").get.as[String])}
                                case undefined: JsUndefined => Logger.info("hit.struc undefined in results!")
                            }
                            }
                            </td>
                            <td colspan="2">@{(hit \ "hit").get.as[String]}</td>
                        </tr>
                        @* Alignment Details*@
                        <tr>
                            <td colspan="3"></td>
                            <td colspan="2">Probability: @{(alignment \ "info" \ "probab").get}, Expect: @{(alignment \ "info" \ "eval").get}</td>
                        </tr>
                        <tr>
                            <td colspan="3"></td>
                            <td colspan="2">Score: @{(alignment \ "info" \ "score").get}, Aligned Cols: @{(alignment \ "info" \ "aligned_cols").get},
                                Identities: @{(alignment \ "info" \ "identities").get}</td>
                        </tr>
                        <tr>
                            <td colspan="3"></td>
                            <td colspan="2">Similarity: @{(alignment \ "info" \ "similarity").get}, Sum Probs: @{(alignment \ "info" \ "sum_probs").get},
                                Template Neff: @{(alignment \ "info" \ "template_neff").get}</td>
                        </tr>

                        <tr>
                            <td><br /></td>
                        </tr>

                        @* Handle secondary structure annotation for query, if present *@
                        @{alignment \ "query" \ "ss_dssp" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("Q", "ss_dssp", "" , HHpred.SSColorReplace({(alignment \ "query" \ "ss_dssp").get.as[String]}), ""))}
                            case undefined: JsUndefined => Logger.info("query.ss_dssp undefined in results!")
                            }
                        }
                        @{alignment \ "query" \ "ss_pred" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("Q", "ss_pred", "" , HHpred.SSColorReplace({(alignment \ "query" \ "ss_pred").get.as[String]}), ""))}
                            case undefined: JsUndefined => Logger.info("query.ss_pred undefined in results!")
                            }
                        }
                        @* seq of query, if present *@
                        @{alignment \ "query" \ "seq" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("Q",(alignment \ "query" \ "name").get.as[String],(alignment \ "query" \ "start").get.toString(), HHpred.colorRegexReplacer((alignment \ "query" \ "seq").get.as[String]),(alignment \ "query" \ "end").get.toString()))}
                            case undefined: JsUndefined => Logger.info("query.seq undefined in results!")
                            }
                        }
                        @*Consensus of query, if present*@
                        @{alignment \ "query" \ "consensus" match {
                            case JsDefined(jsValue) =>
                                {HHpred.makeRow("sequence", Array("Q", "Consensus",(alignment \ "query" \ "start").get.toString(), (alignment \ "query" \ "consensus").get.as[String],(alignment \ "query" \ "end").get.toString()))}
                            case undefined: JsUndefined => Logger.info("query.consensus undefined in results!")
                            }
                        }
                        @* agree of query, if present *@
                        @{alignment \ "agree" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("","","",(alignment \ "agree").get.as[String], ""))}
                            case undefined: JsUndefined => Logger.info("agree undefined in results!")
                            }
                        }
                        @*  consensus template, if present *@
                        @{alignment \ "template" \ "consensus" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("T", "Consensus", (alignment \ "template" \ "start").get.toString(), (alignment \ "template" \ "consensus").get.as[String],(alignment \ "template" \ "end").get.toString()))}
                            case undefined: JsUndefined => Logger.info("template.consensus undefined in results!")
                            }
                        }
                        @*  seq template, if present *@
                        @{alignment \ "template" \ "seq" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("T", (alignment \ "template" \ "name").get.as[String], (alignment \ "template" \ "start").get.toString(), HHpred.colorRegexReplacer((alignment \ "template" \ "seq").get.as[String]),(alignment \ "template" \ "end").get.toString()))}
                            case undefined: JsUndefined => Logger.info("template.seq undefined in results!")
                            }
                        }
                        @* Handle secondary structure annotation for template, if present *@
                        @{alignment \ "template" \ "ss_dssp" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("T", "ss_dssp", "" , HHpred.SSColorReplace({(alignment \ "template" \ "ss_dssp").get.as[String]}), ""))}
                            case undefined: JsUndefined => Logger.info("template.ss_dssp undefined in results!")
                         }
                        }

                        @{alignment \ "template" \ "ss_pred" match {
                            case JsDefined(jsValue) =>
                            {HHpred.makeRow("sequence", Array("T", "ss_pred", "" , HHpred.SSColorReplace({(alignment \ "template" \ "ss_pred").get.as[String]}), ""))}
                            case undefined: JsUndefined => Logger.info("template.ss_pred undefined in results!")
                         }
                        }

                        <tr>
                            <td class="histogram" colspan="4">@FileLoader.loadHTML(s"$jobID/results/${jobID}_${(hit \ "no").get}.map")</td>
                        </tr>
                        <tr>
                        <hr id="line-element" colspan="4" class="horizontal-line">
                        </tr>
                    </tbody>
                  </table>

                }
            </form>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="hhpred_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="hhpred_match_columns"></td>
                </tr>
                <tr>
                    <td>No_of_Seqs</td>
                    <td id="hhpred_noseqs"></td>
                </tr>
                <tr>
                    <td>Neff</td>
                    <td id="hhpred_neff"></td>
                </tr>
                <tr>
                    <td>Searched HMMs</td>
                    <td id="hhpred_searchedhmms"></td>
                </tr>
                <tr>
                    <td>Date</td>
                    <td id ="hhpred_date"></td>
                </tr>
            </table>
        </div>
    </li>
</ul>


<div class="reveal" id="templateAlignment" data-reveal>
    <h1>Template Alignment</h1>
    <div>
        <select>
            <option selected>Forward To</option>
            <option onclick="forward_('modeller', $('#alignmentTemplate').val())";>Modeller</option>
        </select>
    </div>
    <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<div class="reveal" id="structure" data-reveal>
    <h1>3D Structure</h1>
    <div id="viewport"></div>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>
$("#templateAlignment").foundation();
$("#structure").foundation();

$("#structure").bind('closed.zf.reveal', (function() {
    $('#viewport canvas').remove();
}))


var hitlist;
var colorSS = false;
var colorLetters = false;
var colorBackground = false;
var firstQueryName, firstQuerySequence, firstQueryStart, firstQueryEnd = null;
var hitNames;
var hitSequences;
var ss_helices = document.getElementsByClassName("ss_h");
var ss_extended = document.getElementsByClassName("ss_e");
var aas;

(function()  {
    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    $('#forward').niceSelect();

    var dataRoute = jsRoutes.controllers.DataController.get("@jobID", 'hhr');
    $.ajax({
        method: dataRoute.method,
        url: dataRoute.url
    }).done(function(data_) {
        var hits = data_.hhr.hits;
        var info = data_.hhr.info;
        var alignments = data_.hhr.alignments;

        firstQueryName = data_.query[0][0];
        firstQuerySequence = data_.query[0][1];


        drawDataTable(hits);
        drawInformation(info);

        //fill first query name and sequence for slider resubmit
        if(alignments.length > 0){
            firstQueryName =  ">" + alignments[0].query.name;
            firstQuerySequence = alignments[0].query.seq;
            firstQueryStart = alignments[0].query.start;
            firstQueryEnd = alignments[0].query.end;
        }else{
            alert("No hits found!");
            firstQueryEnd = 0;
            firstQueryStart = 0;
        }
        /* without timeout SLIDER is displayed */
        setTimeout(function () {
            slider_show(info.Match_columns, firstQueryStart, firstQueryEnd)
        }, 1000);

        aas = $('span[class^="aa_"]'); // Have to use jQuery for that one
    })
    $("#accordion").foundation();
    $('.histogram').hide();
})();


function drawInformation(info ){
    /*  INFO TAB*/
    $("#hhpred_query").append(info.Query);
    $("#hhpred_match_columns").append(info.Match_columns);
    $("#hhpred_noseqs").append(info.No_of_seqs);
    $("#hhpred_neff").append(info.Neff);
    $("#hhpred_searchedhmms").append(info.Searched_HMMs);
    $("#hhpred_date").append(info.Date);
}

function drawDataTable(hits){

    hitlist = $('#htb').dataTable({
        "bInfo": false,
        "bFilter": true,
        "bLengthChange": true,
        "aaData": hits,
        "scrollY": 600,
        "scrollX": true,
        "aoColumns": [
            { "mDataProp": "no" },
            { "mDataProp": "struc" , render: function (data){return getSingleLink(data)}},
            { "mDataProp": "hit" },
            { "mDataProp": "prob" },
            { "mDataProp": "eval" },
            { "mDataProp": "pval", render: function(data){return data.toExponential();}},
            { "mDataProp": "score" },
            { "mDataProp": "ss" },
            { "mDataProp": "cols" },
            { "mDataProp": "query_begin" },
            { "mDataProp": "query_end" },
            { "mDataProp": "template_begin" },
            { "mDataProp": "template_end" },
            { "mDataProp": "ref" }
        ],
        'columnDefs': [{
            'targets': 0,
            'searchable': false,
            'orderable': false,
            'render': function (data, type, full, meta){
                return '<input type="checkbox" name="templates" class="hitCheckbox" value="' + $('<div/>').text(data).html() + '">';
            }
        }]
    });

}



function hhpred_manual() {
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    if (!formData.has("templates")) {
        alert("Please select at least one template for modeling");
        return;
    }
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_manual", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {
        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_manual", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        });
    });
}

function hhpred_automatic() {
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_automatic", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {

        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_automatic", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        });
    });
}




function selectAll_() {
    selectAll(this.hitlist.fnGetNodes());
}

function onFullscreenToggle() {
    hitlist.draw();
}

function toggleHistogram(){
    if($('.sequence').is(':hidden')){
        $('.sequence').show();
        $('.histogram').hide();
    }else{
        $('.sequence').hide();
        $('.histogram').show();
    }
}

function toggleSS_(){
    this.colorSS = !this.colorSS;
    toggleSS(this.colorSS);
}


function forwardHmm(tool) {
    $.ajax({
        type: 'GET',
        url: 'files/@jobID/query.a3m'
    }).done(function (data) {
        $('#tool-tabs').tabs('option', 'active', $('#tool-tabs').tabs('option', 'active') -2);
        $('#alignment').val(data.toString());
    });
}


function templateAlignment(accession){

    $.ajax({
        type: 'GET',
        url: '/templateAlignment/@jobID/' + accession,
        async: false
    }).done(function () {
        $.ajax({
            type: 'GET',
            url: 'files/@jobID/' + accession + '.template.fas',
            async: false
        }).done(function (data) {
            document.getElementById("alignmentTemplate").value = data.toString();
        });

    });
}


function showStructure(accession) {

        $(document).ready(function(){
            stage = new NGL.Stage( "viewport" );
            stage.loadFile( ('http://files.rcsb.org/view/' + accession + '.pdb'), { defaultRepresentation: true } );
            stage.set
        });
}


function forward_(tool, forwardData){
    $('#templateAlignment').foundation('close');
    forward(tool, forwardData);
}

function toggleAliColor_(str){
    if(str == "letters" ){
        if(colorLetters)
            toggleAliColor("");
        else
            toggleAliColor("letters")
        this.colorLetters = !this.colorLetters;
    }
    if(str == "background"){
        if(colorBackground)
            toggleAliColor("");
        else
            toggleAliColor("background")
        this.colorBackground = !this.colorBackground;
    }
}
function resubmitSection_(){
    resubmitSection(firstQuerySequence, firstQueryName);
}

</script>
