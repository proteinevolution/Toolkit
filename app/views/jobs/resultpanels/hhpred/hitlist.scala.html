@import models.results.HHpred
@(jobID: String)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">

@*  Load html Map used for the image representation *@


<ul id="hhpred_accordion" class="accordion" data-accordion data-allow-all-closed="true">
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            @HHpred.html(s"$jobID/results/$jobID.html_NOIMG")
            <img src="/files/@{jobID}/@{jobID}.png" />
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table  class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="hhpred_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="hhpred_match_columns"></td>
                </tr>
                <tr>
                    <td>No_of_Seqs</td>
                    <td id="hhpred_noseqs"></td>
                </tr>
                <tr>
                    <td>Neff</td>
                    <td id="hhpred_neff"></td>
                </tr>
                <tr>
                    <td>Searched HMMs</td>
                    <td id="hhpred_searchedhmms"></td>
                </tr>
                <tr>
                    <td>Date</td>
                    <td id ="hhpred_date"></td>
                </tr>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <table id="htb" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th colspan="9"></th>
                        <th colspan="2">Query</th>
                        <th colspan="2">Template</th>
                    </tr>
                    <tr>
                        <th>No</th>
                        <th>Hit</th>
                        <th>Name</th>
                        <th>Prob</th>
                        <th>E-value</th>
                        <th>P-value</th>
                        <th>Score</th>
                        <th>SS</th>
                        <th>Cols</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Ref</th>
                    </tr>
                </thead>
            </table>

        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="hhpred_alignments" class="accordion-content table-scroll" data-tab-content>

            <div id="hhpred_alignment_control">
            <select id="hhpred_color_select" onchange="toggleAliColor(this)">
                <option value="none">No color</option>
                <option value="letters">Letters</option>
                <option value="background">Background</option>
            </select>
            <input type="checkbox" onchange="toggleSS(this)"> Color SS
            <button type="button" style="float: right;" class="button" onclick="submitManuallySelected()">Create Model from manually selected templates</button>
            <button type="button" style="float: right;" class="button">Select Templates Automatically</button>
            </div>
            <form id="hhpred_templates">
            </form>
        </div>
    </li>
</ul>



<script>
    var ss_helices = document.getElementsByClassName("ss_h");
    var ss_extended = document.getElementsByClassName("ss_e");
    var aas;
    var hitlist;


    function toggleAliColor(element) {
        if(element.value == "letters") {
            for(var i = 0; i < aas.length; i++) {
                var aa = aas[i];
                aa.style.color = aa_color_font.get(aa.className);
                aa.style.backgroundColor = "white"
            }
        } else if(element.value == "background") {
            for(var i = 0; i < aas.length; i++) {
                var aa = aas[i];
                aa.style.backgroundColor = aa_color_background.get(aa.className);
                aa.style.color = "black"
            }
        } else {
            for(var i = 0; i < aas.length; i++) {
                aas[i].style.color = "black";
                aas[i].style.backgroundColor = "white";
            }
        }
    }

        function toggleSS(element) {

            if(element.checked) {
                for (var i = 0; i < ss_helices.length; i++) {
                    ss_helices[i].style.color="#D00000";
                }
                for (var i = 0; i < ss_extended.length; i++) {
                    ss_extended[i].style.color="#0000D0";
                }
            } else {
                for (var i = 0; i < ss_helices.length; i++) {
                    ss_helices[i].style.color="black";
                }
                for (var i = 0; i < ss_extended.length; i++) {
                    ss_extended[i].style.color="black";
                }
            }
        }
    // Makes a table row with the specified content
    function makeRow(entries) {

        var row = document.createElement("tr");
        for(var i = 0; i < entries.length; i++ ) {
            var entry = document.createElement("td");
            entry.innerHTML = entries[i];
            row.appendChild(entry);
        }
        return row;
    }

        (function()  {
         $('.slider').on('moved.zf.slider', function() {
             $('#lefthandle').html($('#hidden1').val());
             $('#lefthandle').css({
                 'color' : 'white',
                 'font-weight': 'bold',
                 'padding-left' : '2px'
             });
             $('#righthandle').html($('#hidden2').val());
             $('#righthandle').css({
                 'color' : 'white',
                 'font-weight': 'bold',
                 'padding-left' : '2px'
             });
         });
         var dataRoute = jsRoutes.controllers.DataController.get("@jobID", 'hhr');
         $.ajax({
             method: dataRoute.method,
             url: dataRoute.url
         }).done(function(data) {
             // For the hitlist
             var hits = data.hhr.hits;
             var info = data.hhr.info;
             var alignments = data.hhr.alignments;
             $("#hhpred_query").append(info.Query);
             $("#hhpred_match_columns").append(info.Match_columns);
             $("#hhpred_noseqs").append(info.No_of_seqs);
             $("#hhpred_neff").append(info.Neff);
             $("#hhpred_searchedhmms").append(info.Searched_HMMs);
             $("#hhpred_date").append(info.Date);
             hitlist = $('#htb').dataTable({
                 "bInfo": false,
                 "bFilter": true,
                 "bLengthChange": true,
                 "aaData": hits,
                 "scrollY": 600,
                 "scrollX": true,
                 "aoColumns": [
                     { "mDataProp": "no" },
                     { "mDataProp": "struc" },
                     { "mDataProp": "hit" },
                     { "mDataProp": "prob" },
                     { "mDataProp": "eval" },
                     { "mDataProp": "pval", render: function(data){return data.toExponential();}},
                     { "mDataProp": "score" },
                     { "mDataProp": "ss" },
                     { "mDataProp": "cols" },
                     { "mDataProp": "query_begin" },
                     { "mDataProp": "query_end" },
                     { "mDataProp": "template_begin" },
                     { "mDataProp": "template_end" },
                     { "mDataProp": "ref" }
                 ]
             });

             var alignments_container = document.getElementById("hhpred_templates");
             for(var i = 0; i < alignments.length; i++) {

                 var ali = alignments[i];
                 var current_seq;
                 var divAlignment = document.createElement("div");
                 divAlignment.setAttribute("class", "alignment_box");
                 var checkbox = document.createElement("input");
                 checkbox.setAttribute("type", "checkbox");
                 checkbox.setAttribute("value", ali.no.toString());
                 checkbox.setAttribute("name", "templates");
                 divAlignment.appendChild(checkbox);
                 var tab = document.createElement("table");
                 tab.className += " unstriped ";
                 var tabbody = document.createElement("tbody");

                 // Query Sequence
                 tabbody.appendChild(makeRow([ali.no, "", "", ""]));
                 // Handle secondary structure annotation for query, if present
                 if(typeof ali.query.ss_dssp !== 'undefined') {

                     current_seq = ali.query.ss_dssp.replace(/[Ee]+/g, "<span class=\"ss_e\">$&</span>");
                     current_seq = current_seq.replace(/[Hh]+/g, "<span class=\"ss_h\">$&</span>");
                     tabbody.appendChild(makeRow(["Q", "ss_dssp", "", current_seq]));
                 }
                 if(typeof ali.query.ss_pred !== 'undefined') {

                     current_seq = ali.query.ss_pred.replace(/[Ee]+/g, "<span class=\"ss_e\">$&</span>");
                     current_seq = current_seq.replace(/[Hh]+/g, "<span class=\"ss_h\">$&</span>");
                     tabbody.appendChild(makeRow(["Q", "ss_pred", "", current_seq]));
                 }

                 current_seq = ali.query.seq.replace(color_regex, color_regex_replacer);
                 tabbody.appendChild(makeRow(["Q", ali.query.name, ali.query.start, current_seq]));
                 // Consensus, if present
                 if(typeof ali.query.consensus !== 'undefined') {
                     tabbody.appendChild(makeRow(["Q", "Consensus", ali.query.start, ali.query.consensus]));
                 }
                 if(typeof ali.agree !== 'undefined') {
                     tabbody.appendChild(makeRow(["", "", "", ali.agree]));
                 }
                 if(typeof ali.template.consensus !== 'undefined') {
                     tabbody.appendChild(makeRow(["T", "Consensus", ali.template.start, ali.template.consensus]));
                 }

                 // replace contiguous sequences of AA with the respective colors
                 current_seq = ali.template.seq.replace(color_regex, color_regex_replacer);
                 tabbody.appendChild(makeRow(["T", ali.template.name, ali.template.start, current_seq]));

                 // Handle secondary structure annotation for template
                 if(typeof ali.template.ss_dssp !== 'undefined') {

                     current_seq = ali.template.ss_dssp.replace(/[Ee]+/g, "<span class=\"ss_e\">$&</span>");
                     current_seq = current_seq.replace(/[Hh]+/g, "<span class=\"ss_h\">$&</span>");
                     tabbody.appendChild(makeRow(["T", "ss_dssp", "", current_seq]));
                 }
                 if(typeof ali.template.ss_pred !== 'undefined') {

                     current_seq = ali.template.ss_pred.replace(/[Ee]+/g, "<span class=\"ss_e\">$&</span>");
                     current_seq = current_seq.replace(/[Hh]+/g, "<span class=\"ss_h\">$&</span>");
                     tabbody.appendChild(makeRow(["T", "ss_pred", "", current_seq]));
                 }

                 tab.appendChild(tabbody);
                 divAlignment.appendChild(tab);
                 alignments_container.appendChild(divAlignment);
             }
             aas = $('span[class^="aa_"]'); // Have to use jQuery for that one
             $("#hhpred_accordion").foundation();
             $('#hhpred_color_select').niceSelect();
         });
        })();

    function submitManuallySelected() {

        // Get selected templates and append parentID
        var formData = new FormData(document.getElementById("hhpred_templates"));
        if(!formData.has("templates")) {
            alert("Please select at least one template for modeling");
            return;
        }
        formData.append("parentid", '@{jobID}' );

        var checkRoute = jsRoutes.controllers.JobController.check("hhpred_manual", null, false);
        m.request({
            method: checkRoute.method,
            url: checkRoute.url,
            data: formData,
            serialize: function(data) {
                return data;
            }
        }).then(function(data) {

            var submitRoute = jsRoutes.controllers.JobController.create("hhpred_manual", data.jobID);
            m.request({
                method: submitRoute.method,
                url: submitRoute.url,
                data: formData,
                serialize: function(data) {
                    return data;
                }
            });
        });

        // generate a new JobID


        /*
        submitRoute = jsRoutes.controllers.JobController.create("hhpred_check_templates", null);
        m.request({
            url: submitRoute.url,
            method: submitRoute.method,
            data: formData,
            serialize: function(data) {
                return data;
            }
        });
        */

    }
    function onFullscreenToggle() {
        hitlist.draw();
    }
</script>
