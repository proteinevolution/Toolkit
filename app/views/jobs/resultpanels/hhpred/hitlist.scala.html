@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import models.database.results.HHPredResult
@(jobID: String, result: HHPredResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModals *@
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    @views.html.forwardmodals.simple(tool, tool.toolNameShort)
    <div id="stickyAnchor"></div>
    <div class="scrollContainer">
        <div id="scrollLinks">
            <a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a>
            <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a>
            <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a>
        </div>
        <span class="headerDivider"></span>
        <div id="controlls">
            <a onclick="@{tool.toolNameShort}_selectAll()" class="selectAllSeq_@{tool.toolNameShort}">Select all</a>
            <a data-open="forwardModal_@{tool.toolNameShort}">Forward</a>
            <a data-open="forwardModal_@{tool.toolNameShort}_hhsuite">Forward Query MSA</a>
            @*only show create model when chosen db=mmcif70/pdb70*@
            @if(result.db.matches("mmcif70/pdb70")) {
                <a onclick="hhpred_manual()">Create model using selected templates</a>
            }
        </div>
    </div>
    Number of sequences: @result.num_hits
    @* Load html Map used for the image representation *@
        <div id="visualization">
            <h5 id="visualizationTitle">Visualization</h5>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                    Resubmit section</a>
                <div id='blastviz'>
                    @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                    <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
                </div>
        </div>
        <div id="hitlist">
            <h5 id="hitlistTitle">Hitlist</h5>
                <table id="htb" class="display" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Probability</th>
                            <th>E-value</th>
                            <th>Cols</th>
                            <th>Length of Target</th>
                        </tr>
                    </thead>
                </table>
        </div>
        <div id="alignmentResult">
            <div id="alignments">
                <h5 id="alignmentsTitle">Alignments</h5>
                <form id="hhpred_templates">
                      <table class="unstriped">
                        <tbody id="alignmentTable">
                        </tbody>
                      </table>
                </form>
            </div>
        </div>

    @*MODALS*@


    <div class="reveal" id="templateAlignmentModal" data-reveal>
        <h3>Template Alignment</h3>
        <div>
            <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
                <option value="" selected>Forward To</option>
                <option value="modeller" >Modeller</option>
            </select>
        </div>
        <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="reveal" id="structureModal" data-reveal>
        <a type="button" class="button success tiny hhpred_extra_button data-close" onclick="detachStructure()">Open in new window</a>
        <div id="accessionStructure"></div>
        <div id="viewport"></div>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}
<script>


$("#structureModal").bind('closed.zf.reveal', (function() {

    //clear 3D structure modal
    $('#accessionStructure').html("");
    $('#viewport canvas').remove();
}));


var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
var currentStructureAccession = "";
var hitlist;
var selectAllBool_@{tool.toolNameShort} = false;
var shownHits = 0;
var showMore = 100;


(function()  {
    // add scrollcontainer highlighting
    $(document).on('scroll', function() {
        if($(this).scrollTop()>=$('#alignments').position().top-10){
            $("#alignmentsScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }else if($(this).scrollTop()>=$('#hitlist').position().top-10){
            $("#hitlistScroll").addClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }  else if($(this).scrollTop()>=$('#visualization').position().top+75) {
            $('.scrollContainer').addClass('fixed');
        } else if($(this).scrollTop()>=$('#visualization').position().top-10) {
            $("#visualizationScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
        }else{
            $('.scrollContainer').removeClass('fixed');
        }
        if($(this).scrollTop() == $(this).height()-$(window).height()){
            getHits(shownHits, shownHits+showMore);
        }
    });

    // adding loading overlay
    $(document).ajaxStart(function(){
        $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
    });
    $(document).ajaxComplete(function(){
        $.LoadingOverlay("hide");
    });

    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    if(@result.num_hits > 0){
        drawDataTable();
        $("#templateAlignmentModal").foundation();
        $("#structureModal").foundation();
        $("#createModelModal").foundation();
        /* without timeout SLIDER is displayed */
        setTimeout(function () {
            slider_show('@{result.query.seq.length}', '@{result.HSPS{0}.query.start}', '@{result.HSPS{0}.query.end}');
        }, 1000);
        getHits(shownHits, shownHits+showMore);

    }
})();


$(document).ready(function () {
        $("#alignments").floatingScroll();
});


function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/dataTableHHpred/@jobID",
        "autoWidth" : false
    });
}


function hhpred_manual() {
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    if (!formData.has("templates")) {
        $("input:checkbox.checkbox_@{tool.toolNameShort}[value=1]").prop("checked",true)
        alert("No templates selected. Using first template for modelling.");
    }
    formData = new FormData(document.getElementById("hhpred_templates"));
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_manual", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {
        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_manual", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        }).then(setTimeout(function(){window.location.href = "/#/jobs/" + data.jobID},1000));

    });
}



function @{tool.toolNameShort}_deselectAll(){
    deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
}

window["@{tool.toolNameShort}_selectAll"] = function () {
    selectAllDatatable(this.hitlist.fnGetNodes());
    this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
    if(this.selectAllBool_@{tool.toolNameShort}) {
        selectAll(checkbox_@{tool.toolNameShort});
        $(".selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
        console.log("called")
    }
    else {
        @{tool.toolNameShort}_deselectAll();
        $(".selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
    }
};

function templateAlignment(accession){
    $('textarea#alignmentTemplate').val(" ");
    // replace '#' for url
    accession = accession.replace("#", "%23");

    $.ajax({
        type: 'GET',
        url: '/templateAlignment/@jobID/' + accession
    }).done(function () {
        $.ajax({
            type: 'GET',
            url: 'files/@jobID/' + accession + '.fas'
        }).done(function (data) {
            $("#alignmentTemplate").val(data.toString());
        });
    }).fail(function () {
    $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
    });
}


function showStructure(accession) {
    currentStructureAccession = accession;
    var db = identifyDatabase(accession);
    var fileEnding = "";
    switch(db){
        case "scop":
            fileEnding = ".pdb";
            break;
        case "mmcif":
            fileEnding = ".cif";
            accession = accession;
            break;
    }
    var url = '/getStructure/' +accession + fileEnding;
    $(document).ready(function(){
        $.get(url).done(function () {
            $(document).ready(function(){
                $('#accessionStructure').append("<h3 class='structureAccession'>3D Structure: "+accession+"</h3>");
                stage = new NGL.Stage( "viewport" );
                stage.loadFile( url, { defaultRepresentation: true, sele: ":A or :B or DPPC",  });
                stage.set
            });
        }).fail(function () {
            $('#viewport').append("<div class='fetchError'>Sorry, failed to fetch structure.</div>");
        });
    });

}

window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits,boolEvalue, evalue, boolFullLength){
    var checkedCheckboxes = getCheckedCheckboxes("checkbox_@{tool.toolNameShort}");
        if(boolEvalue) {
            route = jsRoutes.controllers.HHpredController.alnEval('@jobID', evalue);
        }else{
            route = jsRoutes.controllers.HHpredController.aln('@jobID', checkedCheckboxes);
        }
        $.ajax({
            url: route.url,
            method: route.method
        }).done(function (data_) {
            $.ajax({
                type: 'GET',
                url: 'files/@jobID/alignment.fas'
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        });

};


function forwardTemplateAlignment_(tool, forwardData){
    if(tool == ""){
        return;
    }
    $('#templateAlignmentModal').foundation('close');
    forward(tool, forwardData);
}

function detachStructure(){
    $('#structureModal').foundation('close');
    window.open('/structure3D/' + currentStructureAccession, '_blank','location=yes,height=550,width=850,scrollbars=yes,status=yes');
}


window["@{tool.toolNameShort}_forwardQueryMSA"] = function(selectedTool){
    $.ajax({
        type: 'GET',
        url: "files/@jobID/@{jobID}.reduced.msa"
    }).done(function (data_) {
        forward(selectedTool, data_.toString());
    });
};
window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
};
function getHits(start, end){
    if(start <= @{result.num_hits}){
        end = end > @{result.num_hits} ? @{result.num_hits} : end;
        this.shownHits += this.showMore;
        var route = jsRoutes.controllers.HHpredController.loadHits('@{jobID}',start, end);
        $.ajax({
            method: route.method,
            url: route.url
        }).done(function (data_) {
            $("#alignmentTable").append(data_);
        });
    }
}
</script>
