@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@(jobID: String, jsValue: JsValue, tool: models.tools.Tool)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">

@if((jsValue \ jobID \ "hits").as[List[JsObject]].size < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModals *@
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    @* Load html Map used for the image representation *@
    <div class="container" id="loadingDiv"></div>
    <ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Visualization</a>
            <div class="accordion-content" data-tab-content>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                    Resubmit section</a>
                <div id='blastviz'>
                    @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                    <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
                </div>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Hitlist</a>
            <div class="accordion-content" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    <a type="button" onclick="hhpred_manual()">Modeller: Manual template selection</a>
                    <a type="button" onclick="hhpred_automatic()">Select Templates Automatically</a>
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>
                <table id="htb" class="display" cellspacing="0" width="80%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Prob</th>
                            <th>E-value</th>
                            <th>P-value</th>
                            <th>Score</th>
                            <th>SS</th>
                            <th>Cols</th>
                            <th>qStart</th>
                            <th>qEnd</th>
                            <th>tStart</th>
                            <th>tEnd</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Alignments</a>
            <div id="alignments" class="accordion-content table-scroll" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    <a type="button" data-open="createModelModal"><span>Create Model</span></a>

                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>

                <form id="hhpred_templates">
                      <table class="unstriped">
                        <tbody>
                            Number of sequences: @{{jsValue \ jobID \ "hits"}.as[List[JsObject]].size}
                            <br />
                            <br />
                        @for((alignment, hit) <- ((jsValue \ jobID \ "alignments").as[List[JsObject]], (jsValue \ jobID \ "hits").as[List[JsObject]]).zipped.toList){
                            @* hit number, links *@
                            <tr>
                                <td></td>
                                <td colspan="3">
                                @{hit \ "struc" match {
                                        case JsDefined(jsValue) => BlastVisualization.getLinksHHpred((hit \ "struc").get.as[String])
                                        case undefined: JsUndefined => BlastVisualization.getLinksHHpred("undefinedAccession") ;
                                    }
                                }
                                </td>
                                <td></td>
                            </tr>
                            @* checkboxes, accession, name of hit*@
                            <tr class="header">
                                <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{(hit \ "no").get}'> @{(hit \ "no").get}.</td>
                                <td colspan="4">

                                @{hit \ "struc" match {
                                    case JsDefined(jsValue) => {BlastVisualization.getSingleLink((hit \ "struc").get.as[String])}
                                    case undefined: JsUndefined => Logger.info("hit.struc undefined in results!")
                                }
                                }
                                @{"  "+(alignment \ "header").get.as[String].replaceFirst(">", "")}
                                </td>
                            </tr>
                            @* Alignment Details*@
                            <tr>
                                <td></td>
                                <td colspan="4">Probability: @{(alignment \ "info" \ "probab").get}, E-value: @{(alignment \ "info" \ "eval").get},
                                    Score: @{(alignment \ "info" \ "score").get}, Aligned Cols: @{(alignment \ "info" \ "aligned_cols").get},
                                    Identities: @{BlastVisualization.percentage((alignment \ "info" \ "identities").get.toString)},
                                    Similarity: @{BlastVisualization.percentage((alignment \ "info" \ "similarity").get.toString)}


                                </td>
                            </tr>
                            <tr>
                                <td><br /></td>
                            </tr>

                            @* Handle secondary structure annotation for query, if present *@
                            @{alignment \ "query" \ "ss_dssp" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("Q", "ss_dssp", "" , BlastVisualization.SSColorReplace({(alignment \ "query" \ "ss_dssp").get.as[String]}), ""))}
                                case undefined: JsUndefined => Logger.info("query.ss_dssp undefined in results!")
                                }
                            }
                            @{alignment \ "query" \ "ss_pred" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("Q", "ss_pred", "" , BlastVisualization.SSColorReplace({(alignment \ "query" \ "ss_pred").get.as[String]}), ""))}
                                case undefined: JsUndefined => Logger.info("query.ss_pred undefined in results!")
                                }
                            }
                            @* seq of query, if present *@
                            @{alignment \ "query" \ "seq" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("Q",(alignment \ "query" \ "name").get.as[String],(alignment \ "query" \ "start").get.toString(), BlastVisualization.colorRegexReplacer((alignment \ "query" \ "seq").get.as[String]),(alignment \ "query" \ "end").get.toString(),"("+(alignment \ "query" \ "ref").get+")".toString()))}
                                case undefined: JsUndefined => Logger.info("query.seq undefined in results!")
                                }
                            }
                            @*Consensus of query, if present*@
                            @{alignment \ "query" \ "consensus" match {
                                case JsDefined(jsValue) =>
                                    {BlastVisualization.makeRow("sequence", Array("Q", "Consensus",(alignment \ "query" \ "start").get.toString(), (alignment \ "query" \ "consensus").get.as[String],(alignment \ "query" \ "end").get.toString(),"("+(alignment \ "query" \ "ref").get+")".toString()))}
                                case undefined: JsUndefined => Logger.info("query.consensus undefined in results!")
                                }
                            }
                            @* agree of query, if present *@
                            @{alignment \ "agree" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("","","",(alignment \ "agree").get.as[String], ""))}
                                case undefined: JsUndefined => Logger.info("agree undefined in results!")
                                }
                            }
                            @*  consensus template, if present *@
                            @{alignment \ "template" \ "consensus" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("T", "Consensus", (alignment \ "template" \ "start").get.toString(), (alignment \ "template" \ "consensus").get.as[String],(alignment \ "template" \ "end").get.toString(),"("+(alignment \ "template" \ "ref").get+(")").toString()))}
                                case undefined: JsUndefined => Logger.info("template.consensus undefined in results!")
                                }
                            }
                            @*  seq template, if present *@
                            @{alignment \ "template" \ "seq" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("T", (alignment \ "template" \ "name").get.as[String], (alignment \ "template" \ "start").get.toString(), BlastVisualization.colorRegexReplacer((alignment \ "template" \ "seq").get.as[String]),(alignment \ "template" \ "end").get.toString(),"("+(alignment \ "template" \ "ref").get+")".toString()))}
                                case undefined: JsUndefined => Logger.info("template.seq undefined in results!")
                                }
                            }
                            @* Handle secondary structure annotation for template, if present *@
                            @{alignment \ "template" \ "ss_dssp" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("T", "ss_dssp", "" , BlastVisualization.SSColorReplace({(alignment \ "template" \ "ss_dssp").get.as[String]}), ""))}
                                case undefined: JsUndefined => Logger.info("template.ss_dssp undefined in results!")
                             }
                            }

                            @{alignment \ "template" \ "ss_pred" match {
                                case JsDefined(jsValue) =>
                                {BlastVisualization.makeRow("sequence", Array("T", "ss_pred", "" , BlastVisualization.SSColorReplace({(alignment \ "template" \ "ss_pred").get.as[String]}), ""))}
                                case undefined: JsUndefined => Logger.info("template.ss_pred undefined in results!")
                             }
                            }
                            <tr>
                                <td colspan="5"><hr id="line-element" colspan="4" class="horizontal-line"></td>
                            </tr>
                        }
                        </tbody>
                      </table>
                </form>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Information</a>
            <div class="accordion-content" data-tab-content>
                <table class="display" cellspacing="0" width="80%">
                    <tr>
                        <td>Query</td>
                        <td id="hhpred_query"></td>
                    </tr>
                    <tr>
                        <td>Match_columns</td>
                        <td id="hhpred_match_columns"></td>
                    </tr>
                    <tr>
                        <td>No_of_Seqs</td>
                        <td id="hhpred_noseqs"></td>
                    </tr>
                    <tr>
                        <td>Neff</td>
                        <td id="hhpred_neff"></td>
                    </tr>
                    <tr>
                        <td>Searched HMMs</td>
                        <td id="hhpred_searchedhmms"></td>
                    </tr>
                    <tr>
                        <td>Date</td>
                        <td id ="hhpred_date"></td>
                    </tr>
                </table>
            </div>
        </li>
    </ul>

    @*MODALS*@


    <div class="reveal" id="templateAlignmentModal" data-reveal>
        <h3>Template Alignment</h3>
        <div>
            <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
                <option value="" selected>Forward To</option>
                <option value="modeller" >Modeller</option>
            </select>
        </div>
        <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="reveal" id="structureModal" data-reveal>
        <a type="button" class="button success tiny hhpred_extra_button data-close" onclick="detachStructure()">Open in new window</a>
        <div id="accessionStructure"></div>
        <div id="viewport"></div>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="reveal" id="createModelModal" data-reveal>
        <h3>Create Model</h3>
        <div>
            <div>
            Manual template selection: <br/>Generate a PIR-alignment of your sequence with the selected template or templates in order to build a 3D model with MODELLER.
            </div>
            <br />
            <a type="button" class="button success tiny hhpred_extra_button"  onclick="hhpred_manual()">Modeller: Manual template selection</a>

        </div>
        <br />
        <br />
        <div>
            <div>
            Automatic template selection: <br />Optimize diversities of query and template HMMs, rerank templates and automatically select best set. In further steps a multiple alignment is created from this set, and a 3D model is build with MODELLER using this alignment.
            </div>
            <br />
            <a type="button" class="button success tiny hhpred_extra_button"  onclick="hhpred_automatic()">Select Templates Automatically</a>
        </div>
    </div>
}
<script>

$("#structureModal").bind('closed.zf.reveal', (function() {

    //clear 3D structure modal
    $('#accessionStructure').html("");
    $('#viewport canvas').remove();
}));

var data;
var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
var currentStructureAccession = "";
var hitlist;
var selectAllBool_@{tool.toolNameShort} = false;
var firstQueryName, firstQuerySequence, firstQueryStart, firstQueryEnd = null;
var jobID;


(function()  {

    // adding loading overlay
    $(document).ajaxStart(function(){
        $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
    });
    $(document).ajaxComplete(function(){
        $.LoadingOverlay("hide");
    });

    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    var dataRoute = jsRoutes.controllers.DataController.get("@jobID");
    $.ajax({
        method: dataRoute.method,
        url: dataRoute.url
    }).done(function(data_) {
        jobID = data_.jobID;
        data = data_[jobID];
        var hits = data.hits;
        var info = data.info;
        var alignments = data.alignments;


        if(alignments.length > 0){
        drawDataTable(hits);
        drawInformation(info);

        //fill first query name and sequence for slider resubmit

        firstQueryName =  ">" + alignments[0].query.name;
        firstQuerySequence = alignments[0].query.seq;
        firstQueryStart = alignments[0].query.start;
        firstQueryEnd = alignments[0].query.end;
        /* without timeout SLIDER is displayed */
        setTimeout(function () {
            slider_show(info.Match_columns, firstQueryStart, firstQueryEnd)
        }, 1000);

        $("#accordion").foundation();
        $("#templateAlignmentModal").foundation();
        $("#structureModal").foundation();
        $("#createModelModal").foundation();


        }
    });

})();


function drawInformation(info ){
    /*  INFO TAB*/
    $("#hhpred_query").append(info.Query);
    $("#hhpred_match_columns").append(info.Match_columns);
    $("#hhpred_noseqs").append(info.No_of_seqs);
    $("#hhpred_neff").append(info.Neff);
    $("#hhpred_searchedhmms").append(info.Searched_HMMs);
    $("#hhpred_date").append(info.Date);
}

function drawDataTable(hits){

    hitlist = $('#htb').dataTable({
        "bInfo": false,
        "bFilter": true,
        "bLengthChange": true,
        "aaData": hits,
        "scrollY": 600,
        "scrollX": true,
        "aoColumns": [
            { "mDataProp": "no" },
            { "mDataProp": "struc" , render: function (data){return getSingleLink(data)}},
            { "mDataProp": "hit" , render: function (data) {return data.replace(/;/g, "")}},
            { "mDataProp": "prob" },
            { "mDataProp": "eval" },
            { "mDataProp": "pval", render: function(data){return data.toExponential();}},
            { "mDataProp": "score" },
            { "mDataProp": "ss" },
            { "mDataProp": "cols" },
            { "mDataProp": "query_begin" },
            { "mDataProp": "query_end" },
            { "mDataProp": "template_begin" },
            { "mDataProp": "template_end" }
        ],
        'columnDefs': [{
            'targets': 0,
            'searchable': false,
            'orderable': true,
            'render': function (data){
                return '<input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value="' + $('<div/>').text(data).html() + '"> ' + data;
            }
        }]
    });

}



function hhpred_manual() {
    $('#createModelModal').foundation('close');
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    if (!formData.has("templates")) {
        alert("Please select at least one template for modeling");
        return;
    }
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_manual", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {
        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_manual", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        });
    });
}

function hhpred_automatic() {
    $('#createModelModal').foundation('close');
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_automatic", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {

        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_automatic", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        });
    });
}


function @{tool.toolNameShort}_deselectAll(){
    deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
}

window["@{tool.toolNameShort}_selectAll"] = function () {
    selectAllDatatable(this.hitlist.fnGetNodes());
    this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
    if(this.selectAllBool_@{tool.toolNameShort}) {
        selectAll(checkbox_@{tool.toolNameShort});
        $("#selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
        console.log("called")
    }
    else {
        @{tool.toolNameShort}_deselectAll();
        $("#selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
    }
};

function templateAlignment(accession){
    $('textarea#alignmentTemplate').val(" ");
    // replace '#' for url
    accession = accession.replace("#", "%23");

    $.ajax({
        type: 'GET',
        url: '/templateAlignment/@jobID/' + accession
    }).done(function () {
        $.ajax({
            type: 'GET',
            url: 'files/@jobID/' + accession + '.fas'
        }).done(function (data) {
            $("#alignmentTemplate").val(data.toString());
        });
    }).fail(function () {
    $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
    });
}


function showStructure(accession) {
    currentStructureAccession = accession;
    var db = identifyDatabase(accession);
    var fileEnding = "";
    var chain = "";
    switch(db){
        case "scop":
            fileEnding = ".pdb";
            break;
        case "mmcif":
            fileEnding = ".cif";
            chain = ":"+accession.split("_")[1].toUpperCase();
            accession = accession.split("_")[0].toLowerCase();
            break;
    }
    var url = '/getStructure/' +accession + fileEnding;
    $(document).ready(function(){
        $.get(url).done(function () {
            $(document).ready(function(){
                $('#accessionStructure').append("<h3 class='structureAccession'>3D Structure: "+accession+"</h3>");
                stage = new NGL.Stage( "viewport" );
                stage.loadFile( url, { defaultRepresentation: true, sele: ":A or :B or DPPC",  });
                stage.set
            });
        }).fail(function () {
            $('#viewport').append("<div class='fetchError'>Sorry, failed to fetch structure.</div>");
        });
    });

}


function forwardTemplateAlignment_(tool, forwardData){
    if(tool == ""){
        return;
    }
    $('#templateAlignmentModal').foundation('close');
    forward(tool, forwardData);
}



window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection(firstQuerySequence, firstQueryName);
};

function detachStructure(){
    $('#structureModal').foundation('close');
    window.open('/structure3D/' + currentStructureAccession, '_blank','location=yes,height=550,width=850,scrollbars=yes,status=yes');
}


window["@{tool.toolNameShort}_forwardQueryMSA"] = function(selectedTool){
    $.ajax({
        type: 'GET',
        url: "files/@jobID/@{jobID}.reduced.msa"
    }).done(function (data_) {
        forward(selectedTool, data_.toString());
    });
};
window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection(firstQuerySequence, firstQueryName);
};
</script>
