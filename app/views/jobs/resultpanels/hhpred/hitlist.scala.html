@import de.proteinevolution.models.database.results.HHPred.HHPredResult
@import better.files._
@import play.api.mvc.RequestHeader
@(jobID: String, result: HHPredResult, tool: de.proteinevolution.models.Tool, htmlPath: String)(implicit request: RequestHeader)
    @if(result.num_hits < 1) {
        <div class="callout alert noHitsWide" id="noHits">
            No hits found!
        </div>
    } else {
    @* Loads ForwardModals *@
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort + "_hhsuite")
    @views.html.forwardmodals.simple(tool, tool.toolNameShort)
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" onclick="scrollToSection('visualization')">Vis</a>
                <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hits</a>
                <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Aln</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">
                <a onclick="selectAll()" class="selectAllSeqBar" id="extraWide">Select all</a>
                <a id="forwardButtonSimple" data-open="forwardModal_@{
                    tool.toolNameShort
                }">Forward</a>
                <a id="forwardButtonHHsuite" data-open="forwardModal_@{
                    tool.toolNameShort
                }_hhsuite">Forward Query A3M</a>
                @*only show create model when chosen db=mmcif70/pdb70*@
                @if(result.db.matches("mmcif70/pdb70")) {
                    <a onclick="@{tool.toolNameShort}_manual()">Model using selection</a>
                }
                <a onclick="downloadHHR()" class="downloadHHR">HHR file</a>
                <a onclick="colorAA()" class="colorAA">Color Seqs</a>
                <a onclick="wrap()" id="wrap">Wrap Seqs</a>
                </div>
        </div>
    </div>
    <br>
    <text class="notePlain">Number of hits: <b>@result.num_hits</b></text>
    <br>
    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <br>
        <text class="note"><b> We have detected</b></text>

    }
    @if(result.TMPRED == "1"){

        <text class="note"><b> @result.TMPRED transmembrane helix</b></text>
    }
    @if(result.TMPRED.toInt > 1){

        <text class="note"><b> @result.TMPRED transmembrane helices</b></text>
    }
    @if((result.TMPRED == "1" || result.TMPRED.toInt > 1) && result.COILPRED == "0"){
        <text class="note"><b> and </b></text>

    }
    @if(result.COILPRED == "0"){
        <text class="note"><b>coiled-coil segments </b></text>
    }

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <text class="note"><b> in your query protein!</b></text> <br>

    }

    @if(result.QA3M_COUNT < 20){
        <br><text class="note">Note: your query alignment consists of only @result.QA3M_COUNT sequence(s).</text>
        @if(result.MSA_GEN == "uniprot20"){

            <text class="note">You could improve the sensitivity of your search vastly by building a larger query
                alignment either with HHblits over Uniclust30 or with PSI-BLAST over nre70. You could also consider
                increasing the number of MSA generation iterations and/or relaxing the inclusion threshold.</text>
        }
        @if(result.MSA_GEN == "uniclust30"){
            <text class="note">You could improve the sensitivity of your search vastly by building a larger
                query alignment with PSI-BLAST over nre70. You could also consider increasing the number of MSA
                generation iterations and/or relaxing the inclusion threshold.</text>
        }
        @if(result.MSA_GEN == "psiblast"){
            <text class="note">You could improve the sensitivity of your search vastly by building a larger
                query alignment; for instance, by increasing the number of MSA generation iterations and/or relaxing the
            inclusion threshold. Alternatively, you could input your own alignment.</text>
        }
        @if(result.MSA_GEN == "custom"){
            <text class="note">You could improve the sensitivity of your search vastly by providing a larger query alignment.</text>
        }

    }

    @* Load html Map used for the image representation *@
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div>
            <a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}')" type="button" id="resubmitSection">
                Resubmit section
            </a>
        </div>
        <div id='blastviz'>
            <div class='flat-slider' id='flat-slider'></div>
            @Html(htmlPath.toFile.contentAsString)
            <p><img src="files/@jobID/@{
                jobID
            }.png" border="0" alt="blasthits" usemap="#blastmap"></p>
        </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
        <table id="htb" class="display" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>Nr</th>
                    <th>Hit</th>
                    <th>Name</th>
                    <th>Probability</th>
                    <th>E-value</th>
                    <th>SS</th>
                    <th>Cols</th>
                    <th>Target Length</th>
                </tr>
            </thead>
        </table>
    </div>
    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitleHHpred">Alignments</h5>
            <form id="hhpred_templates">
                <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                    <tr>
                        <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                    </tr>
                    <tr>
                        <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div id="toolReferences">
        <h5 id="refTitle">References</h5>
        If you use our HHpred server for your research, please cite:
        <div class="citation">
            <div>The MPI bioinformatics Toolkit as an integrative platform for advanced protein sequence and structure analysis.<br>
                Alva V, Nam SZ, Söding J, Lupas AN.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkw348" target="_blank" rel="noopener"> Nucleic Acids Res. 2016 Jul 8;44(W1):W410-5</a>.
            </div>
        </div>
            And one or more of the following:
        <div class="citation">
            <div>Protein homology detection by HMM-HMM comparison.<br>
                Söding J.<a href="https://academic.oup.com/bioinformatics/article-lookup/doi/10.1093/bioinformatics/bti125" target="_blank" rel="noopener"> Bioinformatics. 2005 Apr 1;21(7):951-60</a>,</div><br>
            <div>Fast and accurate automatic structure prediction with HHpred.<br>
                Hildebrand A, Remmert M, Biegert A, Söding J.<a href="http://onlinelibrary.wiley.com/doi/10.1002/prot.22499/abstract;jsessionid=6FF63B8F61E35391B79F4681BB12DB2C.f02t04" target="_blank" rel="noopener"> Proteins. 2009;77 Suppl 9:128-32</a>,</div><br>
            <div>Automatic Prediction of Protein 3D Structures by Probabilistic Multi-template Homology Modeling.<br>
                Meier A, Söding J.<a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004343" target="_blank" rel="noopener"> PLoS Comput Biol. 2015 Oct 23;11(10):e1004343</a>.</div><br>
        </div>
        </div>
    <hr id="line-element" colspan="4" class="horizontal-line">


    @*MODALS*@
    <div class="reveal" id="templateAlignmentModal" data-reveal>
        <p>Template Alignment (~100 most distinct sequences)</p>
        <div>
            <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
                <option value="" selected>Forward to</option>
                <option value="formatseq" >FormatSeq</option>
                <option value="hhblits" >HHblits</option>
                <option value="hhomp" >HHomp</option>
                <option value="hhpred" >HHpred</option>
                <option value="hhrepid" >HHrepID</option>
            </select>
        </div>
        <textarea rows="35" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
        <button class="close-button" id="alignmentTemplateClose" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="reveal" id="structureModal" data-reveal>
        <p>Template 3D structure</p>
        <div id="accessionStructure"> </div>

        <div id="viewport"></div>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}
<script>


        $("#structureModal").bind('closed.zf.reveal', (function () {
            //clear 3D structure modal
            $('#accessionStructure').html("");
            $('#viewport canvas').remove();
            $.LoadingOverlay("hide");
        }));


        $("#templateAlignmentModal").bind('closed.zf.reveal', (function () {
            $('#alignmentTemplate_tool').val('');
            $.LoadingOverlay("hide");
        }));

        var checkbox = "checkbox";
        var currentStructureAccession = "";
        var selectAllBool = false;
        var colorAAs = true;
        var shownHits = 100;
        var showMore = 100;
        var numHits = @{result.num_hits};
        var jobID = '@{jobID}';
        var loading = false;
        var wrapped = true;

        // use this array to store
        // checked checkboxes
        // due to pagination/lazyload
        var checkboxes = [];

        $(document).ready(function () {
            hitlistBaseFunctions();
            if (numHits > 0) {
                $("#wrap").text("Unwrap Seqs");
                $("#wrap").addClass("colorToggleBar");
                drawDataTable();
                var firstQueryStart = @{if(result.num_hits > 0){ result.HSPS.head.query.start}};
                var firstQueryEnd = @{if(result.num_hits > 0){ result.HSPS.head.query.end}};
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
                shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits, wrapped, colorAAs);
                $('#templateAlignmentModal').foundation();
                $('#structureModal').foundation();
                $(".colorAA").addClass("colorToggleBar");
                $("#wrap").hide();
                $(".colorAA").hide();
            }

        });

        window["downloadHHR"] = function(){
            var downloadFilename = "hhpred_" + jobID + ".hhr";
            var fileURL="/files/" + jobID + "/" + jobID + ".hhr";
            $.ajax({
                method: "GET",
                url: fileURL
            }).done(function(data){
                download(downloadFilename, data);
            })
        };

        function drawDataTable() {
            hitlist = $('#htb').dataTable({
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "/api/job/results/dataTableHHpred/" + jobID,
                "autoWidth": false,
                "lengthMenu": [[10, 25, 50, 100, numHits], [10, 25, 50, 100, "All"]],
                "searching": false,
                "iDisplayLength": 25,
                "drawCallback": function() {
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                }
            });
        }

        function selectAll(){
            selectAllBool = !selectAllBool;
            $(".selectAllSeqBar").toggleClass("colorToggleBar");
            $(".selectAllSeqBar").toggleText("Select all","Deselect all");
            if(selectAllBool) {
                selectAllHelper(checkbox);
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits+1).forEach(function(num){return checkboxes.push(num)});
            }
            else {
                deselectAll(checkbox);
                // delete all checkboxes from array
                checkboxes = [];
            }
        }


        function @{tool.toolNameShort}_manual() {
            // Get selected templates and append parentID
            var formData = new FormData(document.getElementById("hhpred_templates"));
            if ($('input:checkbox[name=alignment_elem]:checked').length === 0) {
                $("input:checkbox[name=alignment_elem][value=1]").prop("checked", true);
                alert("No templates selected. Using first template for modelling.");
            }
            formData.append("templates", checkboxes.join(" "));
            formData.append("parentid", jobID);


            var submitRoute = jsRoutes.controllers.JobController.submitJob("hhpred_manual");
            m.request({
                method: submitRoute.method,
                url: submitRoute.url,
                data: formData,
                serialize: function(submissionReturnData) {
                    return submissionReturnData;
                }
            }).then(function(submissionReturnData){
                console.log("Data(then):", submissionReturnData);
                if (submissionReturnData.successful) {
                    console.log("Job Submission was successful.");
                    jobID = submissionReturnData.jobID;
                    var jobListComp = JobListComponent.Job(
                            { jobID: jobID, state: 0, dateCreated: Date.now().valueOf(), tool: "hhpred_manual" }
                    );
                    if (!JobListComponent.contains(jobID)) {
                        JobListComponent.pushJob(jobListComp, true);
                    }
                } else {
                    console.log("Error while submitting:", submissionReturnData.message)
                }
                $(".submitJob").prop("disabled", false);
                JobSubmissionComponent.submitting = false;
            }).catch(function(error){
                console.log("Error while submitting:", error);
                $(".submitJob").prop("disabled", false);
                JobSubmissionComponent.submitting = false;
            });
        }


        function templateAlignment(accession) {
            $.LoadingOverlay("show");
            $('textarea#alignmentTemplate').val(" ");
            // replace '#' for url
            accession = accession.replace("#", "%23");

            $.ajax({
                type: 'GET',
                url: '/templateAlignment/' + jobID + '/' + accession,
                error: function(){
                    $.LoadingOverlay("hide")
                }
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/' + jobID + '/' + accession + '.a3m',
                    error: function(){
                        $.LoadingOverlay("hide")
                    }
                }).done(function (data) {
                    $("#alignmentTemplate").val(data.toString());
                    $.LoadingOverlay("hide")
                });
            }).fail(function () {
                $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
                $.LoadingOverlay("hide")
            });

        }

        function showStructure(accession) {
            currentStructureAccession = accession;
            var db = identifyDatabase(accession);
            var fileEnding = "";
            switch (db) {
                case "scop":
                    fileEnding = ".pdb";
                    break;
                case "ecod":
                    fileEnding = ".pdb";
                    break;
                case "mmcif":
                    fileEnding = ".cif";
                    accession = accession;
                    break;
            }
            var url = '/getStructure/' + accession + fileEnding;

            $(document).ready(function () {
                $('#accessionStructure').append("<h6 class='structureAccession'>3D Structure: " + accession + "</h6>");
                $('#viewport').width(800).height(700).find('canvas').first().remove();
                stage = new NGL.Stage("viewport");
                $.get(url).done(function () {
                    $(document).ready(function () {
                        stage.loadFile(url, {defaultRepresentation: true, sele: ":A or :B or DPPC"});
                    });
                }).fail(function () {
                    $('#accessionStructure').append("<div class='fetchError'>Sorry, failed to fetch structure.</div>");
                    $.LoadingOverlay("hide")
                });
            });

        }

        function @{tool.toolNameShort}_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength) {
            var data = {"checkboxes": checkboxes.removeDuplicates()};
            $.LoadingOverlay("show");
            var route = null;
            var filename = generateFilename();
            if (boolEvalue) {
                data.evalue = evalue;
                data.fileName = filename;
                route = jsRoutes.controllers.HHpredController.alnEval(jobID);
            } else {
                if(data.checkboxes.length === 0){
                    $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                    $.LoadingOverlay("hide");
                    alert("No sequence(s) selected!");
                    return false;
                }
                data.fileName = filename;
                route = jsRoutes.controllers.HHpredController.aln(jobID);
            }
            $.ajax({
                url: route.url,
                method: route.method,
                contentType: "application/json",
                data: JSON.stringify(data),
                error: function(){
                    $.LoadingOverlay("hide")
                }
            }).done(function (data_) {
                    forwardPath(selectedTool, 'files/' + jobID + '/'+filename+'.fa');
                });
        }

        function forwardTemplateAlignment_(tool, forwardData) {
            if (tool === "") {
                return;
            }
            $('#templateAlignmentModal').foundation('close');
            forward(tool, forwardData);
        }


        function @{tool.toolNameShort}_forwardQueryMSA(selectedTool) {
            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: "files/" + jobID + "/reduced.a3m"
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        }

        function getHits(start, end, isWrapped, isColor) {
            if (start <= numHits && end <= numHits && !loading) {
                var data = { "start": start, "end": end, "isColor": isColor, "wrapped": isWrapped };
                loading = true;
                $('#loadingHits').show();
                $('#loadHits').hide();
                var route = jsRoutes.controllers.HHpredController.loadHits(jobID);
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
                    loading = false;
                    $('#loadingHits').hide();
                    if (shownHits !== numHits) {
                        $('#loadHits').show();
                    }
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                    $("#alignments").floatingScroll('init');
                });
            }
            // hide loadHits

        }



</script>
