@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import models.database.results.HHPredResult
@(jobID: String, result: HHPredResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>
}else{
    @* Loads ForwardModals *@
    @views.html.forwardmodals.hhsuite(tool, tool.toolNameShort+"_hhsuite")
    <div id="stickyAnchor"></div>
    <div class="scrollContainer">
        <p><a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a></p>
        <p><a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a></p>
        <p><a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a></p>
    </div>
    @* Load html Map used for the image representation *@
        <div id="visualization">
            <h5 id="visualizationTitle">Visualization</h5>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                    Resubmit section</a>
                <div id='blastviz'>
                    @BlastVisualization.html(s"$jobID/results/$jobID.html_NOIMG")
                    <p><img src="files/@jobID/@{jobID}.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
                </div>
        </div>
        <div id="hitlist">
            <h5 id="hitlistTitle">Hitlist</h5>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span class="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    @*only show create model when chosen db=mmcif70/pdb70*@
                    @if(result.db.matches("mmcif70/pdb70")) {
                        <a type="button" onclick="hhpred_manual()"><span>Create model using selected templates</span></a>
                    }
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>
                <table id="htb" class="display" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Hit</th>
                            <th>Name</th>
                            <th>Probability</th>
                            <th>E-value</th>
                            <th>Cols</th>
                            <th>Length of Target</th>
                        </tr>
                    </thead>
                </table>
        </div>
        <div id="alignmentResult">
            <div id="alignments">
                <h5 id="alignmentsTitle">Alignments</h5>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span class="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}_hhsuite"><span>Forward Query MSA</span></a>
                    @*only show create model when chosen db=mmcif70/pdb70*@
                    @if(result.db.matches("mmcif70/pdb70")) {
                        <a type="button" onclick="hhpred_manual()"><span>Create model using selected templates</span></a>
                    }
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>

                <form id="hhpred_templates">
                      <table class="unstriped">
                        <tbody>
                            Number of sequences: @result.num_hits
                            <br />
                            <br />
                        @for(hit <- result.HSPS){
                            @* hit number, links *@
                            <tr>
                                <td></td>
                                <td colspan="3">
                                @BlastVisualization.getLinksHHpred(hit.template.accession)
                                </td>
                                <td></td>
                            </tr>
                            @* checkboxes, accession, name of hit*@
                            <tr class="header">
                                <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{hit.num}'> @{hit.num}.</td>
                                <td colspan="4">
                                    @BlastVisualization.getSingleLink(hit.template.accession)
                                @{"  "+ hit.description}
                                </td>
                            </tr>
                            @* Alignment Details*@
                            <tr>
                                <td></td>
                                <td colspan="4">Probability: @{hit.info.probab}, E-value: @{hit.info.evalue},
                                    Score: @{hit.info.score}, Aligned Cols: @{hit.info.aligned_cols},
                                    Identities: @{BlastVisualization.percentage(hit.info.identities.toString)},
                                    Similarity: @{hit.info.similarity}


                                </td>
                            </tr>
                            <tr>
                                <td><br /></td>
                            </tr>

                            @* Handle secondary structure annotation for query, if present *@
                            @if(!hit.query.ss_dssp.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Q", "ss_dssp", "", BlastVisualization.SSColorReplace(hit.query.ss_dssp)))
                                }
                            }
                            @if(!hit.query.ss_pred.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Q", "ss_pred", "", BlastVisualization.SSColorReplace(hit.query.ss_pred)))
                                }
                            }
                            @if(!hit.query.seq.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Q",hit.query.accession, hit.query.start.toString, BlastVisualization.colorRegexReplacer(hit.query.seq) +" "+hit.query.end.toString + " " +"("+hit.query.ref+")"))
                                }
                            }
                            @*Consensus of query, if present*@
                           @if(!hit.query.consensus.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Q", "Consensus",hit.query.start.toString, hit.query.consensus + " " + hit.query.end.toString + " " + "("+hit.query.ref+")"))
                                }
                             }
                            @* agree of query, if present *@

                            @BlastVisualization.makeRow("sequence", Array("","","",hit.agree))

                            @*  consensus template, if present *@
                            @if(!hit.template.consensus.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("T", "Consensus",hit.template.start.toString, hit.template.consensus  + " " + hit.query.end.toString + " " + "("+hit.template.ref+")"))
                                }
                            }
                            @*  seq template, if present *@
                            @if(!hit.template.seq.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("T",hit.template.accession, hit.template.start.toString, BlastVisualization.colorRegexReplacer(hit.template.seq) + " "+hit.template.end.toString + " "+"("+hit.query.ref+")"))
                                }
                            }
                            @* Handle secondary structure annotation for template, if present *@
                            @if(!hit.template.ss_pred.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("T", "ss_pred", "", BlastVisualization.SSColorReplace(hit.template.ss_pred)))
                                }
                            }
                            @if(!hit.template.ss_dssp.isEmpty) {
                                @{
                                    BlastVisualization.makeRow("sequence", Array("T", "ss_dssp", "", BlastVisualization.SSColorReplace(hit.template.ss_dssp)))
                                }
                            }
                            <tr>
                                <td colspan="5"><hr id="line-element" colspan="4" class="horizontal-line"></td>
                            </tr>
                        }
                        </tbody>
                      </table>
                </form>
            </div>
        </div>

    @*MODALS*@


    <div class="reveal" id="templateAlignmentModal" data-reveal>
        <h3>Template Alignment</h3>
        <div>
            <select onclick="forwardTemplateAlignment_(this.value, $('#alignmentTemplate').val())" id="alignmentTemplate_tool">
                <option value="" selected>Forward To</option>
                <option value="modeller" >Modeller</option>
            </select>
        </div>
        <textarea rows="50" id="alignmentTemplate" placeholder="Loading..." spellcheck="false"></textarea>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>

    <div class="reveal" id="structureModal" data-reveal>
        <a type="button" class="button success tiny hhpred_extra_button data-close" onclick="detachStructure()">Open in new window</a>
        <div id="accessionStructure"></div>
        <div id="viewport"></div>
        <button class="close-button" data-close aria-label="Close modal" type="button">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}
<script>


$("#structureModal").bind('closed.zf.reveal', (function() {

    //clear 3D structure modal
    $('#accessionStructure').html("");
    $('#viewport canvas').remove();
}));


var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
var currentStructureAccession = "";
var hitlist;
var selectAllBool_@{tool.toolNameShort} = false;


(function()  {
    // add scrollcontainer highlighting
    $(document).on('scroll', function() {
        if($(this).scrollTop()>=$('#alignments').position().top-10){
            $("#alignmentsScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }else if($(this).scrollTop()>=$('#hitlist').position().top-10){
            $("#hitlistScroll").addClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }  else if($(this).scrollTop()>=$('#visualization').position().top+75) {
            $('.scrollContainer').addClass('fixed');
        } else if($(this).scrollTop()>=$('#visualization').position().top-10) {
            $("#visualizationScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
        }else{
            $('.scrollContainer').removeClass('fixed');
        }
    });

    // adding loading overlay
    $(document).ajaxStart(function(){
        $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
    });
    $(document).ajaxComplete(function(){
        $.LoadingOverlay("hide");
    });

    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    if(@result.num_hits > 0){
        drawDataTable();
        $("#templateAlignmentModal").foundation();
        $("#structureModal").foundation();
        $("#createModelModal").foundation();
        /* without timeout SLIDER is displayed */
        setTimeout(function () {
            slider_show('@{result.query.seq.length}', '@{result.HSPS{0}.query.start}', '@{result.HSPS{0}.query.end}');
        }, 1000);

    }
})();


$(document).ready(function () {
        $("#alignments").floatingScroll();
});


function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/dataTableHHpred/@jobID",
        "autoWidth" : false
    });
}


function hhpred_manual() {
    // Get selected templates and append parentID
    var formData = new FormData(document.getElementById("hhpred_templates"));
    if (!formData.has("templates")) {
        $("input:checkbox.checkbox_@{tool.toolNameShort}[value=1]").prop("checked",true)
        alert("No templates selected. Using first template for modelling.");
    }
    formData = new FormData(document.getElementById("hhpred_templates"));
    formData.append("parentid", '@{jobID}');

    var checkRoute = jsRoutes.controllers.JobController.check("hhpred_manual", null, false);
    m.request({
        method: checkRoute.method,
        url: checkRoute.url,
        data: formData,
        serialize: function (data) {
            return data;
        }
    }).then(function (data) {
        var submitRoute = jsRoutes.controllers.JobController.create("hhpred_manual", data.jobID);
        m.request({
            method: submitRoute.method,
            url: submitRoute.url,
            data: formData,
            serialize: function (data) {
                return data;
            }
        });
    });
}



function @{tool.toolNameShort}_deselectAll(){
    deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
}

window["@{tool.toolNameShort}_selectAll"] = function () {
    selectAllDatatable(this.hitlist.fnGetNodes());
    this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
    if(this.selectAllBool_@{tool.toolNameShort}) {
        selectAll(checkbox_@{tool.toolNameShort});
        $(".selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
        console.log("called")
    }
    else {
        @{tool.toolNameShort}_deselectAll();
        $(".selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
    }
};

function templateAlignment(accession){
    $('textarea#alignmentTemplate').val(" ");
    // replace '#' for url
    accession = accession.replace("#", "%23");

    $.ajax({
        type: 'GET',
        url: '/templateAlignment/@jobID/' + accession
    }).done(function () {
        $.ajax({
            type: 'GET',
            url: 'files/@jobID/' + accession + '.fas'
        }).done(function (data) {
            $("#alignmentTemplate").val(data.toString());
        });
    }).fail(function () {
    $("#alignmentTemplate").val("Sorry, failed to fetch Template Alignment.");
    });
}


function showStructure(accession) {
    currentStructureAccession = accession;
    var db = identifyDatabase(accession);
    var fileEnding = "";
    switch(db){
        case "scop":
            fileEnding = ".pdb";
            break;
        case "mmcif":
            fileEnding = ".cif";
            accession = accession;
            break;
    }
    var url = '/getStructure/' +accession + fileEnding;
    $(document).ready(function(){
        $.get(url).done(function () {
            $(document).ready(function(){
                $('#accessionStructure').append("<h3 class='structureAccession'>3D Structure: "+accession+"</h3>");
                stage = new NGL.Stage( "viewport" );
                stage.loadFile( url, { defaultRepresentation: true, sele: ":A or :B or DPPC",  });
                stage.set
            });
        }).fail(function () {
            $('#viewport').append("<div class='fetchError'>Sorry, failed to fetch structure.</div>");
        });
    });

}


function forwardTemplateAlignment_(tool, forwardData){
    if(tool == ""){
        return;
    }
    $('#templateAlignmentModal').foundation('close');
    forward(tool, forwardData);
}

function detachStructure(){
    $('#structureModal').foundation('close');
    window.open('/structure3D/' + currentStructureAccession, '_blank','location=yes,height=550,width=850,scrollbars=yes,status=yes');
}


window["@{tool.toolNameShort}_forwardQueryMSA"] = function(selectedTool){
    $.ajax({
        type: 'GET',
        url: "files/@jobID/@{jobID}.reduced.msa"
    }).done(function (data_) {
        forward(selectedTool, data_.toString());
    });
};
window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
};
</script>
