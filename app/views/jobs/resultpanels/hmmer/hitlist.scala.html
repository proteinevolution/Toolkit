@import play.api.libs.json.JsObject
@import models.results.BlastVisualization
@import models.database.results.HmmerResult
@import models.database.results.HmmerHSP
@(jobID: String, result: HmmerResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@* Load html Map used for the image representation *@
@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

} else {
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    <div class="scrollContainer">
        <div id="scrollLinks">
            <a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a>
            <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a>
            <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a>
        </div>
        <span class="headerDivider"></span>
        <div id="controlls">
            <a onclick="selectAll()" class="selectAllSeq">Select all</a>
            <a type="button" data-open="forwardModal_@{
                tool.toolNameShort
            }">Forward</a>
        </div>
    </div>
    <br>
    Number of sequences: @{
        result.num_hits
    }
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div>
            <a class="success button tiny resubmitSection" onclick="resubmitSection()" type="button" id="resubmitSection">Resubmit section</a>
        </div>

        <div id='blastviz'>
            <div class='flat-slider' id='flat-slider'></div>
            @BlastVisualization.html(s"$jobID/results/blastviz.html")
            <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
        </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
        <table id="htb" class="display" width="100%">
            <thead>
                <tr>
                    <th>Nr</th>
                    <th>Id</th>
                    <th>Title</th>
                    <th>E-value</th>
                    <th>Bitscore</th>
                    <th>Aligned positions</th>
                </tr>
            </thead>
        </table>
    </div>

    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitle">Alignments</h5>
            <form id="hhpred_templates">
                <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                </table>
            </form>
        </div>
    </div>
}
<script>
        var checkbox = "checkbox";
        var selectAllBool = false;
        var shownHits = 50;
        var showMore = 100;
        var numHits = @{result.num_hits};
        var jobID = '@{jobID}';
        var loading = false;
        // use this array to store
        // checked checkboxes
        // due to pagination/lazyload
        var checkboxes = [];

        $(document).ready(function () {
            hitlistBaseFunctions();
            if (numHits > 0) {
                drawDataTable();
                var firstQueryStart = @result.HSPS.head.query_start;
                var firstQueryEnd = @result.HSPS.head.query_end;
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
                shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits);
            }
        });

        function drawDataTable() {
            hitlist = $('#htb').dataTable({
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "/api/job/results/dataTableHmmer/" + jobID,
                "autoWidth": false,
                "lengthMenu": [[10, 25, 50, numHits], [10, 25, 50, "All"]],
                "searching": false,
                "iDisplayLength": 10
            });
        }

        function hmmer_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength) {
            if (boolFullLength) {
                if (boolEvalue) {
                    var route = jsRoutes.controllers.HmmerController.evalFull(jobID, evalue);
                } else {
                    var route = jsRoutes.controllers.HmmerController.full(jobID, checkboxes);
                }
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function () {
                    $.ajax({
                        type: 'GET',
                        url: 'files/' + jobID + '/sequences.fa'
                    }).done(function (data_) {
                        forward(selectedTool, data_.toString());
                    });
                });
            } else {
                if (boolEvalue) {
                    route = jsRoutes.controllers.HmmerController.alnEval(jobID, evalue);
                } else {
                    route = jsRoutes.controllers.HmmerController.aln(jobID, checkboxes);
                }
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    forward(selectedTool, data_);
                });
            }
        }


        function selectAll() {
            selectAllBool = !selectAllBool;
            if (selectAllBool) {
                selectAllHelper(checkbox);
                $(".selectAllSeq").addClass("colorToggle");
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits + 1).forEach(function (x) {
                    checkboxes.push(x)
                });
            }
            else {
                deselectAll(checkbox);
                $(".selectAllSeq").removeClass("colorToggle");
                // delete all checkboxes from array
                checkboxes = [];
            }
        }


        function resubmitSection() {
            resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}');
        }


        function getHits(start, end) {
            if (start <= numHits && end <= numHits) {
                loading = true;
                var route = jsRoutes.controllers.HmmerController.loadHits(jobID, start, end);
                return $.ajax({
                    method: route.method,
                    url: route.url
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
                    loading = false;
                });
            }
        }

</script>
