@import play.api.libs.json.JsObject
@import models.results.BlastVisualization
@import models.database.results.HmmerResult
@import models.database.results.HmmerHSP
@(jobID: String, result: HmmerResult, tool: models.tools.Tool)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">
@* Load html Map used for the image representation *@

@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.simple(tool, tool.toolNameShort)
    <div class="container" id="loadingDiv"></div>
    <ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Visualization</a>
            <div class="accordion-content" data-tab-content>
                <div class='flat-slider' id='flat-slider'></div>
                <div id='blastviz'>
                    <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                        Resubmit section</a>
                        @BlastVisualization.html(s"$jobID/results/blastviz.html")
                        <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Hitlist</a>
            <div class="accordion-content" data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                    <hr id="line-element" class="horizontal-line">
                </div>
                <table id="htb" class="display" width="100%">
                    <thead>
                        <tr>
                            <th>Nr</th>
                            <th>Id</th>
                            <th>Title</th>
                            <th>E-value</th>
                            <th>Bitscore</th>
                            <th>Length</th>
                        </tr>
                    </thead>
                </table>
            </div>
        </li>
        <li class="accordion-item" data-accordion-item id="alignmentAccordion">
            <a href="#" class="accordion-title">Alignments</a>
            <div id="alignments" class="accordion-content " data-tab-content>
                <div class="colorOpts">
                    <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                    <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                    <hr id="line-element" colspan="4" class="horizontal-line">
                </div>

                <form id="hhpred_templates">
                    <table class="unstriped">
                        <tbody>
                            Number of sequences: @{result.num_hits}
                            <br />
                            <br />
                                @for(hit <- result.HSPS){
                                    @* hit number, links *@
                                    <tr>
                                        <td></td>
                                        <td colspan="3">
                                        @BlastVisualization.getLinksHmmer(hit.accession)
                                        </td>
                                        <td></td>
                                    </tr>
                                    @* checkboxes, accession, name of hit*@
                                    <tr class="header">
                                        <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{hit.num}'> @{hit.num}</td>
                                        <td colspan="4">
                                            @BlastVisualization.getSingleLinkDB(result.db,hit.accession)
                                            @{"  "+hit.description}
                                        </td>
                                    </tr>
                                    @* Alignment Details*@
                                    <tr>
                                        <td></td>
                                        <td colspan="4">E-value: @{hit.evalue},
                                            Score: @{hit.bitscore}, Hit length: @{hit.hit_len},
                                            Domain expected number: @{hit.dom_exp_num}, Domain observed number: @{hit.domain_obs_num}
                                    </td>
                                    </tr>
                                    @* color only 150 first hits, to avoid bloating of the generated html*@
                                    @if(hit.num <  150) {
                                        @* seq of query, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("Q", hit.query_start.toString, BlastVisualization.colorRegexReplacer(hit.query_seq), hit.query_end.toString))
                                        }
                                        @* agree of query, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("", "", BlastVisualization.colorRegexReplacer(hit.midline), ""))
                                        }
                                        @* seq of hit, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("H", hit.hit_start.toString, BlastVisualization.colorRegexReplacer(hit.hit_seq), hit.hit_end.toString))
                                        }
                                    }else{
                                        @* seq of query, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("Q", hit.query_start.toString, hit.query_seq, hit.query_end.toString))
                                        }
                                        @* agree of query, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("", "", hit.midline, ""))
                                        }
                                        @* seq of hit, if present *@
                                        @{
                                            BlastVisualization.makeRow("sequence", Array("H", hit.hit_start.toString, hit.hit_seq, hit.hit_end.toString))
                                        }

                                    }
                                    <tr>
                                        <td><br /></td>
                                    </tr>
                                    <tr>
                                        <td colspan="5"><hr id="line-element" colspan="4" class="horizontal-line"></td>
                                    </tr>
                                }
                        </tbody>
                    </table>
                </form>


            </div>
        </li>
        <li class="accordion-item" data-accordion-item>
            <a href="#" class="accordion-title">Information</a>
            <div class="accordion-content" data-tab-content>
                <table  class="display" cellspacing="0" width="80%">
                    <tr>
                        <td>Query</td>
                        <td id="psiblast_query"></td>
                    </tr>
                    <tr>
                        <td>Query Length</td>
                        <td id="psiblast_queryLength"></td>
                    </tr>
                    <tr>
                        <td>DB</td>
                        <td id="psiblast_db"></td>
                    </tr>
                </table>
            </div>
        </li>
    </ul>

}
<script>
        var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
        var hitlist;
        var query;
        var selectAllBool_@{tool.toolNameShort} = false;
        var firstQueryStart, firstQueryEnd = null;
        var chosenDB = null;

        (function()  {

            // adding loading overlay
            $(document).ajaxStart(function(){
                $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
            });
            $(document).ajaxComplete(function(){
                $.LoadingOverlay("hide");
            });
            $('.slider').on('moved.zf.slider', function() {
                $('#lefthandle').html($('#hidden1').val());
                $('#lefthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
                $('#righthandle').html($('#hidden2').val());
                $('#righthandle').css({
                    'color' : 'white',
                    'font-weight': 'bold',
                    'padding-left' : '2px'
                });
            });

            var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
            var selectAllBool_@{tool.toolNameShort} = false;
            var chosenDB = null;
            var numHits = @{result.num_hits};
            var urlParams = "/api/job/@jobID";
            var evalueParam = null;


            $.getJSON(urlParams, function(data_){
                chosenDB = data_.paramValues.standarddb;
                evalueParam = data_.paramValues.inclusion_ethresh;
            });
                if(numHits > 0){
                    var firstQueryStart = @result.HSPS(0).query_start;
                    var firstQueryEnd = @result.HSPS(0).query_end;
                    /* without timeout SLIDER is displayed */
                    drawDataTable();
                    setTimeout(function () {
                        slider_show('@{result.query.seq.length}', firstQueryStart, firstQueryEnd)
                    }, 1000);

                    $("#accordion").foundation();

                }
        })();

        $("#alignmentAccordion").bind('down.zf.accordion', (function() {
            $("#alignments").floatingScroll('update');

        }));


        $(document).ready(function () {
            setTimeout(function () {
                $("#alignments").floatingScroll('init');
            }, 2000);
        });

        function drawDataTable(){
            hitlist = $('#htb').dataTable({
                "bProcessing" : true,
                "bServerSide" : true,
                "sAjaxSource" : "/api/job/results/dataTableHmmer/@jobID",
                "autoWidth": false
            });
        }

        window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits,boolEvalue, evalue, boolFullLength){
            if(boolEvalue) {
                var route = jsRoutes.controllers.HmmerController.alnEval('@jobID', evalue);
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    forward(selectedTool, data_.toString());
                });
            }else if(boolSelectedHits){
                var data = getCheckedCheckboxes("checkbox_@{tool.toolNameShort}");
                var route = jsRoutes.controllers.HmmerController.aln('@jobID', data);
                $.ajax({
                    url: route.url,
                    method: route.method
                }).done(function (data_) {
                    forward(selectedTool, data_.toString());
                });
            }
        };


        window["@{tool.toolNameShort}_selectAll"] = function () {
            selectAllDatatable(this.hitlist.fnGetNodes());
            this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
            if(this.selectAllBool_@{tool.toolNameShort}) {
                selectAll(checkbox_@{tool.toolNameShort});
                $("#selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
            }
            else {
                _deselectAll();
                $("#selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
            }
        };

        function _deselectAll(){
            deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
        }


        window["@{tool.toolNameShort}_resubmitSection"] = function(){
            resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
        };


</script>
