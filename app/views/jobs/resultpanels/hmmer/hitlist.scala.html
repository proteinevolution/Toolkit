@import play.api.libs.json.JsObject
@import models.results.BlastVisualization
@import models.database.results.HmmerResult
@import better.files._
@import models.database.results.HmmerHSP
@(jobID: String, result: HmmerResult, tool: models.tools.Tool, htmlPath: String)(implicit request: RequestHeader)
@* Load html Map used for the image representation *@
@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

} else {
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" name="#visualization" onclick="scrollToSection('visualization')">Vis</a>
                <a id="hitlistScroll" name="#hitlist" onclick="scrollToSection('hitlist')">Hits</a>
                <a id="alignmentsScroll" name="#alignments" onclick="scrollToSection('alignments')">Aln</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">

                <a onclick="selectAll()" class="selectAllSeqBar" id="extraWide">Select all</a>
                <a type="button" id="forwardButtonNormal" data-open="forwardModal_@{
                    tool.toolNameShort
                }">Forward</a>
                <a onclick="wrap()" id="wrap">Wrap Seqs</a>
            </div>
        </div>
    </div>
    <br>
    <text class="notePlain">Number of hits: <b>@result.num_hits</b></text>
    <br>

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <br>
        <text class="note"> We have detected</i></text>

    }
    @if(result.TMPRED == "1"){

        <text class="note"> @result.TMPRED transmembrane helix</text>
    }
    @if(result.TMPRED.toInt > 1){

        <text class="note"> @result.TMPRED transmembrane helices</text>
    }
    @if((result.TMPRED == "1" || result.TMPRED.toInt > 1) && result.COILPRED == "0"){
        <text class="note"> and </text>

    }
    @if(result.COILPRED == "0"){
        <text class="note">coiled-coil segments </text>
    }

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <text class="note"> in your query protein!</text>

    }


    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div>
            <a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}')" type="button" id="resubmitSection">Resubmit section</a>
        </div>

        <div id='blastviz'>
            <div class='flat-slider' id='flat-slider'></div>
            @Html(htmlPath.toFile.contentAsString)
            <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
        </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
        <table id="htb" class="display" width="100%">
            <thead>
                <tr>
                    <th>Nr</th>
                    <th>Id</th>
                    <th>Title</th>
                    <th>E-value</th>
                    <th>Ind. E-value</th>
                    <th>Bitscore</th>
                    <th>Aligned positions</th>
                </tr>
            </thead>
        </table>
    </div>

    <div id="alignmentResult">
        <div id="alignments">
            <h5 id="alignmentsTitle">Alignments</h5>
            <form id="hhpred_templates">
                <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                    <tr>
                        <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                    </tr>
                    <tr>
                        <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
    <br>
    <div id="toolReferences">
        <h5 id="refTitle">References</h5>
        If you use our HMMER server for your research, please cite:
        <div class="citation">
            <div>The MPI bioinformatics Toolkit as an integrative platform for advanced protein sequence and structure analysis.<br>
                Alva V, Nam SZ, SÃ¶ding J, Lupas AN.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkw348" target="_blank"> Nucleic Acids Res. 2016 Jul 8;44(W1):W410-5</a>.</div>
            </div>
        And the HMMER paper:
        <div class="citation">
            <div>Accelerated Profile HMM Searches.<br>
                Eddy SR.<a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1002195" target="_blank">  PLoS Comput Biol. 2011 Oct;7(10):e1002195</a>.</div>
        </div>
    </div>
    <hr id="line-element" colspan="4" class="horizontal-line">

}
<script>
        var checkbox = "checkbox";
        var selectAllBool = false;
        var shownHits = 100;
        var showMore = 100;
        var numHits = @{result.num_hits};
        var jobID = '@{jobID}';
        var loading = false;
        var wrapped = true;
        var colorAAs = false;
        // use this array to store
        // checked checkboxes
        // due to pagination/lazyload
        var checkboxes = [];

        $(document).ready(function () {
            hitlistBaseFunctions();
            if (numHits > 0) {
                $("#wrap").text("Unwrap Seqs");
                $("#wrap").addClass("colorToggleBar");
                drawDataTable();
                var firstQueryStart = @{if(result.num_hits > 0){ result.HSPS.head.query_start}};
                var firstQueryEnd = @{if(result.num_hits > 0){ result.HSPS.head.query_end}};
                /* without timeout SLIDER is displayed */
                slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
                shownHits = shownHits > numHits ? numHits : shownHits;
                getHits(0, shownHits, wrapped);
                $("#wrap").hide();
            }
        });

        function drawDataTable() {
            hitlist = $('#htb').dataTable({
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "/api/job/results/dataTableHmmer/" + jobID,
                "autoWidth": false,
                "lengthMenu": [[10, 25, 50, 100, numHits], [10, 25, 50, 100, "All"]],
                "searching": false,
                "iDisplayLength": 25,
                "drawCallback": function() {
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                }
            });
        }

        function selectAll(){
            selectAllBool = !selectAllBool;
            $(".selectAllSeqBar").toggleClass("colorToggleBar");
            $(".selectAllSeqBar").toggleText("Select all","Deselect all");
            if(selectAllBool) {
                selectAllHelper(checkbox);
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits+1).forEach(function(num){return checkboxes.push(num)});
            }
            else {
                deselectAll(checkbox);
                // delete all checkboxes from array
                checkboxes = [];
            }
        }

        function hmmer_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength) {
            var data = {"checkboxes": checkboxes.removeDuplicates()};
            $.LoadingOverlay("show");
            var route = null;
            var filename = generateFilename();
            if (boolFullLength) {
                if (boolEvalue) {
                    data.evalue = evalue;
                    data.filename = filename;
                    route = jsRoutes.controllers.HmmerController.evalFull(jobID);
                } else {
                    data.filename = filename;
                    route = jsRoutes.controllers.HmmerController.full(jobID);
                    if(data.checkboxes.length == 0){
                        $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                        $.LoadingOverlay("hide");
                        alert("No sequence(s) selected!");
                        return false;
                    }
                }
                $.ajax({
                    url: route.url,
                    method: route.method,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    error: function(){
                        $.LoadingOverlay("hide")
                    }
                }).done(function () {
                    $.ajax({
                        type: 'GET',
                        url: 'files/' + jobID + '/'+filename+'.fa',
                        error: function(){
                            $.LoadingOverlay("hide")
                        }
                    }).done(function (data_) {
                        forward(selectedTool, data_.toString());
                    })
                });
            } else {
                if (boolEvalue) {
                    data.evalue = evalue;
                    route = jsRoutes.controllers.HmmerController.alnEval(jobID);
                } else {
                    route = jsRoutes.controllers.HmmerController.aln(jobID);
                }
                $.ajax({
                    url: route.url,
                    method: route.method,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    error: function(){
                        $.LoadingOverlay("hide")
                    }
                }).done(function (data_) {
                    forward(selectedTool, data_);
                });
            }
        }


        function getHits(start, end, isWrapped) {
            if (start <= numHits && end <= numHits && !loading) {
                var data = {"start": start, "end": end, "wrapped": wrapped};
                loading = true;
                $('#loadingHits').show();
                $('#loadHits').hide();
                var route = jsRoutes.controllers.HmmerController.loadHits(jobID);
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#alignmentTable").append(data_);
                    loading = false;
                    $('#loadingHits').hide();
                    if (shownHits != numHits) {
                        $('#loadHits').show();
                    }
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                    $("#alignments").floatingScroll('init');
                });
            }
        }

</script>
