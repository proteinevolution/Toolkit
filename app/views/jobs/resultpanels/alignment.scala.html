@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray
@import play.api.Logger
@import models.results.FileLoader
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import modules.tel.TEL
@(toolName: String, jobID: String, jsValue: JsValue)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">


<a type="button" class="button success tiny hhpred_extra_button" data-open="forwardModal">Forward selected</a>

<a type="button" class="button success tiny hhpred_extra_button" id="downloadAlignment"  onclick="download_()">Download File</a>
<div class="colorOptsAlignment">
    <a onclick="toggleSelectAll()" type="button"> <span id="selectAllSeq">Select all</span></a>
    <a onclick="toggleSelectTopTen()" type="button"><span id="selectTopTen">Select top ten</span></a>
    <a onclick='toggleAliColor_("letters")' type="button"><span id="letterColor">Color letters</span></a>
    <a onclick='toggleAliColor_("background")' type="button"><span id="backgroundColor">Color background</span></a>
    <a onclick='wrapSequences()' type="button"><span id="wrapSequences">Wrap sequences</span></a>
    <hr id="line-element" colspan="4" class="horizontal-line">
</div>
<div id="alignmentResultView">
    Number of sequences: @{{jsValue \ "alignment"}.as[List[JsArray]].size}
        <br />
        <br />
<form id="alignmentResult">
    <table class="unstriped">
        <tbody class="alignmentTBody">
        @for((alignment,index) <- {jsValue \ "alignment"}.as[List[JsArray]].zipWithIndex) {
            <tr class="header">
                <td ><input type="checkbox" name="templates" class="alignmentCheckbox" value='@{index}'></td>
                <td>
                    @{index+1}.
                    @{alignment{0} match {
                        case JsDefined(jsValue) => (alignment{0}).get.as[String]
                        }
                    }
                </td>
            </tr>
            <tr>
                <td></td>
                <td class="sequence">
                    @{alignment{1} match {
                        case JsDefined(jsValue) => Html(BlastVisualization.colorRegexReplacer((alignment{1}).get.as[String]))
                        }
                    }
                </td>
            </tr>
        }
            <tr><td><br/></td></tr>
            <tr><td><br/></td></tr>
        </tbody>
    </table>

</form>
</div>

<script>
        var data;
        var checkbox = "alignmentCheckbox";
        var colorLettersBool = false;
        var colorBackgroundBool = false;
        var selectTopTenBool = false;
        var selectAllBool = false;
        var wrapSequencesBool = false;
        var aas = $('span[class^="aa_"]'); // Have to use jQuery for that one

        // check first ten checkboxes by default
        $(document).ready(function () {
            selectTopTen(checkbox);
            $("#selectTopTen").addClass( "colorToggle" );
        });

        // get result json
        var fileUrl = "/files/@jobID/alignment.json";
        $.getJSON(fileUrl, function (data_) {
            data = data_;
        });

        function toggleAliColor_(str){
            if(str == "letters" ){
                if(colorLettersBool)
                    toggleAliColor("");
                else
                    toggleAliColor("letters");
                this.colorLettersBool = !this.colorLettersBool;
            }
            if(str == "background"){
                if(colorBackgroundBool)
                    toggleAliColor("");
                else
                    toggleAliColor("background");
                this.colorBackgroundBool = !this.colorBackgroundBool;
            }
        }


        function forward_(tool) {
            var forwardData = [];
            var checkedCheckboxes = [];
            // get values of all checked Checkboxes
            $('input:checkbox.' + checkbox + ":checked").each(function () {
                checkedCheckboxes.push($(this).val())
            });

            //fill array with headers and sequences
                checkedCheckboxes.forEach(function callback(currentValue) {
                    forwardData.push(">" + data[currentValue][0]);
                    forwardData.push(data[currentValue][1]);
                });
                forward(tool, forwardData.join("\n"));
        }

        function toggleSelectAll(){
            this.selectAllBool = !this.selectAllBool;
            if(selectAllBool) {
                selectAll(checkbox);
                $("#selectTopTen").removeClass( "colorToggle" );
                $("#selectAllSeq").addClass( "colorToggle" );
            }
            else {
                deselectAll(checkbox);
                $("#selectAllSeq").removeClass( "colorToggle" );
            }
        }
        function toggleSelectTopTen(){

            this.selectTopTenBool = !this.selectTopTenBool;
            if(selectTopTenBool ) {
                selectTopTen(checkbox);
                $("#selectTopTen").addClass( "colorToggle" );
                $("#selectAllSeq").removeClass( "colorToggle" );
            }
            else {
                deselectAll(checkbox);
                $("#selectTopTen").removeClass( "colorToggle" );
            }

        }
        function download_(){
            var fileString = "";
            for(var i = 0; i < data.length; i++){
                fileString += ">" + data[i][0] + "\n";
                    fileString += (data[i][1] + "\n");
            }
            var filename = "@{toolName}_jobID_@{jobID}.fasta";
            download(filename, fileString);
        }
        function wrapSequences(){
            this.wrapSequencesBool = !this.wrapSequencesBool;
            if(wrapSequencesBool) {
                $(".sequence").addClass("wrap");
                $("#wrapSequences").addClass("colorToggle");
            }
            else {
                $(".sequence").removeClass("wrap");
                $("#wrapSequences").removeClass("colorToggle");
            }
        }

</script>