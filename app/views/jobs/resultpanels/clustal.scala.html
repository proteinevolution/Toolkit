@import play.api.libs.json.JsObject
@import play.api.libs.json.JsValue
@import play.api.libs.json.JsArray
@import play.api.Logger
@import play.api.libs.json.JsUndefined
@import play.api.libs.json.JsDefined
@import models.results.BlastVisualization
@import modules.tel.TEL
@import play.api.libs.json.JsLookupResult
@import models.database.results.AlignmentResult
@(jobID: String, alignment: AlignmentResult, resultName: String,  tool : models.tools.Tool)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">

@views.html.forwardmodals.simpler(tool, resultName)

<div class="colorOptsAlignment">
    <a onclick="@{tool.toolNameShort}_selectAll()" class="selectAllSeq"><span class="selectAllSeqSpan">Select all</span></a>
    <a type="button" id="forwardButtonSimpler" data-open="forwardModal_@resultName"><span>Forward Selected</span></a>
    <a type="button" id="downloadAlignment"  onclick="@{resultName}_download()"><span>Download Alignment</span></a>
    <a type="button" onclick="@{tool.toolNameShort}_colorAA()"><span id="colorAA">Color Alignment</span></a>
    <hr id="line-element" colspan="4" class="horizontal-line">
</div>
<div id="alignmentResultView">
    Number of sequences: <b>@alignment.alignment.length</b>
        <br />
        <br />

<form id="alignmentResult">
    <table class="unstriped">
        <table id="clustalTable">
        </table>
        <tr>
            <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
        </tr>
    </table>
</form>
</div>

<script>

        var fileUrl = "/files/@jobID/alignment.clustalw_aln";
        var downloadFilename = "@{tool.toolNameShort}_@{resultName}_jobID_@{jobID}.clustal";
        var selectAllBool = false;
        var colorAAsClustal = false;
        var numHits = @alignment.alignment.length;
        var resultName = '@resultName';
        var jobID = '@jobID';
        var checkboxes = [];
        var checkbox = "checkbox";



        window["@{resultName}_forward"] = function(selectedTool){
            var data = {"checkboxes": checkboxes.removeDuplicates(), "resultName": resultName};
            var route = jsRoutes.controllers.AlignmentController.getAln(jobID);

            $.LoadingOverlay("show");
            // get result json
            $.ajax({
                type: route.method,
                url: route.url,
                contentType: "application/json",
                data: JSON.stringify(data),
                error: function(){
                    $.LoadingOverlay("hide")
                }
            }).done(function (data) {
                    forward(selectedTool, data);
            });
        };

        window["@{resultName}_download"] = function(){
            // get result json

            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: fileUrl
            }).done(function (data) {
                download(downloadFilename, data.toString());
            });
        };

        window["@{tool.toolNameShort}_selectAll"] = function(){
            selectAllBool = !selectAllBool;
            $(".selectAllSeqSpan").toggleClass("colorToggle");
            $(".selectAllSeqSpan").toggleText("Select all", "Deselect all");
            if(selectAllBool) {
                selectAllHelper(checkbox);
                // first empty array
                checkboxes = [];
                // push all checkboxes (1 to num_hits) into array
                _.range(1, numHits+1).forEach(function(x){checkboxes.push(x)});
            }
            else {
                deselectAll(checkbox);
                // delete all checkboxes from array
                checkboxes = [];
            }
        };


        window["@{tool.toolNameShort}_getHits"] = function(color){
                $('#loadingHits').show();
                var data = {"color": color, "resultName" : resultName};
            var route = {};
            route.url = "/AlignmentLoadHitsClustal/" + jobID;
            route.method = "POST";
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#clustalTable").append(data_);
                    loading = false;
                    linkCheckboxes();
                    selectFromArray(checkboxes);
                    $('#loadingHits').hide();
                    $.LoadingOverlay("hide");
                });
        };

        function @{tool.toolNameShort}_colorAA(){
            colorAAsClustal = !colorAAsClustal;
            $("#clustalTable").empty();
            $("#colorAA").toggleClass("colorToggle");
            @{tool.toolNameShort}_getHits(colorAAsClustal);
        }

        (function($){

            @{tool.toolNameShort}_getHits(false);

            $(document).on('scroll', function () {
                $("#alignmentResult").floatingScroll('init');
            });

        })(jQuery);

</script>
