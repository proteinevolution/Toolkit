@import de.proteinevolution.tools.results.Alignment.AlignmentResult
@import java.lang.String
@(jobID: String, alignment: AlignmentResult, resultName: String,  tool: de.proteinevolution.models.Tool)()

@fileURL = @{"/files/" + jobID + "/" + "alignment.clustalw_aln"}

@views.html.forwardmodals.simpler(tool, resultName)

<div class="colorOptsAlignment">
    <a onclick="ResultViewHelper.toggleAllCheckboxes();" class="selectAllSeq"><span class="selectAllSeqBar">Select all</span></a>
    <a type="button" id="forwardButtonSimpler" data-open="forwardModal_@resultName"><span>Forward Selected</span></a>
    <a type="button" id="downloadAlignment"  onclick="@{resultName}_download()"><span>Download MSA</span></a>
    <a type="button" href="@fileURL" target="_blank" rel="noopener"><span>Export MSA</span></a>
    <a type="button" onclick="@{tool.toolNameShort}_colorAA()"><span id="colorAA">Color MSA</span></a>
    <hr class="horizontal-line">
</div>
<div id="alignmentResultView">
    Number of sequences: <b>@alignment.alignment.length</b>
        <br />
        <br />
<div class="unstriped">
    <table id="resultTable">
    </table>
    <div id="loadingHitsClu">Loading Hits...</div>
</div>
</div>
<br/><br/>
<br/><hr><br/>
<div id="toolReferences">
    If you use @{tool.toolNameLong} on our Toolkit for your research, please cite:
    <div class="citation">
        @views.html.help.common.toolkit_citation_results()
        <br>

        @if(tool.toolNameShort == "clustalo") {
            <div>Fast, scalable generation of high-quality protein multiple sequence alignments using Clustal Omega.<br>
                Sievers F et al.<a href="http://msb.embopress.org/content/7/1/539" target="_blank" rel="noopener"> Mol Syst Biol. 2011 Oct 11;7:539.</a></div>
        }
        @if(tool.toolNameShort == "kalign") {
            <div>Kalign2: high-performance multiple alignment of protein and nucleotide sequences allowing external features.<br>
                Lassmann T, Frings O, Sonnhammer EL.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkn1006" target="_blank" rel="noopener"> Nucleic Acids Res. 2009 Feb;37(3):858-65.</a></div>
        }
        @if(tool.toolNameShort == "mafft") {
            <div>MAFFT multiple sequence alignment software version 7: improvements in performance and usability.<br>
                Katoh K, Standley DM.<a href="https://academic.oup.com/mbe/article-lookup/doi/10.1093/molbev/mst010" target="_blank" rel="noopener"> Mol Biol Evol. 2013 Apr;30(4):772-80.</a></div>
        }
        @if(tool.toolNameShort == "msaprobs") {
            <div>Multiple protein sequence alignment with MSAProbs.<br>
                Liu Y, Schmidt B.<a href="https://link.springer.com/protocol/10.1007%2F978-1-62703-646-7_14" target="_blank" rel="noopener"> Methods Mol Biol. 2014;1079:211-8.</a></div>
        }
        @if(tool.toolNameShort == "muscle") {
            <div>MUSCLE: multiple sequence alignment with high accuracy and high throughput.<br>
                Edgar RC.<a href="https://academic.oup.com/nar/article-lookup/doi/10.1093/nar/gkh340" target="_blank" rel="noopener"> Nucleic Acids Res. 2004 Mar 19;32(5):1792-7.</a></div>
        }
        @if(tool.toolNameShort == "tcoffee") {
            <div>A novel method for fast and accurate multiple sequence alignment.<br>
                Notredame C, Higgins DG, Heringa J.<a href="https://www.ncbi.nlm.nih.gov/pubmed/10964570" target="_blank" rel="noopener"> J Mol Biol. 2000 Sep 8;302(1):205-17.</a></div>
        }
    </div>
    <hr class="horizontal-line">
</div>

<script>
        var fileUrl = "/files/@jobID/alignment.clustalw_aln";
        var downloadFilename = "@{tool.toolNameShort}_@{resultName}_@{jobID}" + ".clustal";
        var colorAAsClustal = false;
        var numHits = @alignment.alignment.length - 1;
        var resultName = '@resultName';
        var jobID = '@jobID';
        var checkboxes = [];

        window["@{resultName}_forward"] = function(selectedTool){  
	    var data = {"checkboxes": checkboxes, "resultName": resultName};
	    $.LoadingOverlay("show");
            $.ajax({
                type: "POST",
                url: "/results/alignment/getAln/" + jobID,
                contentType: "application/json",
                data: JSON.stringify(data),
                error: function(){
                    $.LoadingOverlay("hide")
                }
            }).done(function (data) {
                Forwarding.simple(selectedTool, data);
            });
        };

        window["@{resultName}_download"] = function(){
            // get result json
            $.LoadingOverlay("show");
            $.ajax({
                type: 'GET',
                url: fileUrl
            }).done(function (data) {
                download(downloadFilename, data.toString());
            });
        };

        window["@{tool.toolNameShort}_getHits"] = function(color){
                $('#loadingHitsClu').show();
                var data = {"color": color, "resultName" : resultName};
            var route = {};
            route.url = "/results/alignment/clustal/" + jobID;
            route.method = "POST";
                return $.ajax({
                    method: route.method,
                    url: route.url,
                    contentType: "application/json",
                    data: JSON.stringify(data)
                }).done(function (data_) {
                    $("#resultTable").append(data_);
                    loading = false;
                    linkCheckboxes();
                    $('#loadingHitsClu').hide();
                    $.LoadingOverlay("hide");
                });
        };

        function @{tool.toolNameShort}_colorAA(){
            colorAAsClustal = !colorAAsClustal;
            $("#resultTable").empty();
            $("#colorAA").toggleClass("colorToggle");
            @{tool.toolNameShort}_getHits(colorAAsClustal);
        }

        (function($){
            @{tool.toolNameShort}_getHits(false);
        })(jQuery);
</script>
