@import models.results.BlastVisualization
@import models.database.results.PSIBlastResult
@(jobID: String, result: PSIBlastResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@* Load html Map used for the image representation *@

@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a>
                <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a>
                <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">
                <a onclick="selectAll()" class="selectAllSeqBar">Select all</a>
                <a type="button" data-open="forwardModal_@{
                    tool.toolNameShort
                }">Forward</a>
            </div>
        </div>
    </div>
    <br>
    Number of sequences: <b>@{result.num_hits}</b>
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div><a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}')" type="button" id="resubmitSection">Resubmit section</a></div>
            <div id='blastviz'>
                <div class='flat-slider' id='flat-slider'></div>
                    @BlastVisualization.html(s"$jobID/results/blastviz.html")
                    <p><img src="files/@{jobID}/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
            <table id="htb" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Nr</th>
                        <th>Accession ID</th>
                        <th>Title</th>
                        <th>E-value</th>
                        <th>Bitscore</th>
                        <th>Aligned positions</th>
                    </tr>
                </thead>
            </table>
    </div>
    <div id="alignments">
        <h5 id="alignmentsTitle">Alignments</h5>
            <form id="psiblast_templates">
                  <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                      <tr>
                          <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                      </tr>
                      <tr>
                          <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                      </tr>
                  </table>
            </form>
    </div>
}
<script>

var checkbox = "checkbox";
var selectAllBool = false;
var shownHits = 50;
var showMore = 100;
var colorAAs = true;
// use this array to store
// checked checkboxes
// due to pagination/lazyload
var checkboxes = [];
var numHits = @{result.num_hits};
var jobID = '@{jobID}';
var loading = false;

$(document).ready( function(){
    hitlistBaseFunctions();
    if(numHits > 0 ){
        drawDataTable();
        var firstQueryStart = @result.HSPS.head.query_start;
        var firstQueryEnd = @result.HSPS.head.query_end;
        slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
        shownHits = shownHits > numHits ? numHits : shownHits;
        getHits(0, shownHits).then(function(){
            // push checked checkboxes in checkboxes array
            getCheckedCheckboxes();
            // check checkboxes that are stored in array
            // in order to make it work with pagination/lazyload
            selectFromArray(checkboxes);
            // link checkboxes from hitlist and alignment, push
            // val of each checkbox in checkboxes array
            linkCheckboxes();
        });
}
});


function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/dataTablePSIBlast/"+jobID,
        "lengthMenu": [[10, 25, 50, numHits], [10, 25, 50, "All"]],
        "searching": false,
        "iDisplayLength": 10
    });
}


function psiblast_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength){
    // full seq is retrieved
    var data = {"checkboxes": checkboxes.removeDuplicates()};
    var route = null;
    $.LoadingOverlay("show");
    if(boolFullLength) {
        if(boolEvalue) {
            route = jsRoutes.controllers.PSIBlastController.evalFull(jobID, evalue);
        }else{
            route = jsRoutes.controllers.PSIBlastController.full(jobID);
        }
        $.ajax({
            url: route.url,
            contentType: "application/json",
            data: JSON.stringify(data),
            method: route.method,
            error: function(){
                $.LoadingOverlay("hide")
            }
        }).done(function (data_) {
            $.ajax({
                type: 'GET',
                url: 'files/'+jobID+'/sequences.fa',
                error: function(){
                    $.LoadingOverlay("hide")
                }
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            })
        })
    }else{
        if(boolEvalue) {
            route = jsRoutes.controllers.PSIBlastController.alnEval(jobID, evalue);
        }else{
            route = jsRoutes.controllers.PSIBlastController.aln(jobID);
        }
        $.ajax({
            url: route.url,
            contentType: "application/json",
            data: JSON.stringify(data),
            method: route.method
        }).done(function (data_) {
            forward(selectedTool, data_);
        })
    }
}

function getHits(start, end){
    if(start <= numHits && end <= numHits && !loading){
	    loading = true;
        $('#loadingHits').show();
        $('#loadHits').hide();
        var route = jsRoutes.controllers.PSIBlastController.loadHits(jobID,start, end);
        return $.ajax({
            method: route.method,
            url: route.url
        }).done(function (data_) {
            $("#alignmentTable").append(data_);
	    loading = false;
            $('#loadingHits').hide();
            if (shownHits != numHits) {
                $('#loadHits').show();
            }
        });
    }
}

</script>
