@import models.results.HHpred
@(jobID: String)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">


<ul id="psiblast_accordion" class="accordion" data-accordion data-allow-all-closed="true">
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            <div>

                <div style=' width: 89% ;margin-left: 2em !important;' class='flat-slider' id='flat-slider'></div>
                <div style="margin-top: 1em">
                @HHpred.html(s"$jobID/results/blastviz.html")
                <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
            </div>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table  class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="psiblast_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="psiblast_queryLength"></td>
                </tr>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <table id="htp" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th colspan="8"></th>
                        <th colspan="2">Query</th>
                        <th colspan="2">Template</th>
                    </tr>
                    <tr>
                        <th>No</th>
                        <th>Name</th>
                        <th>E-value</th>
                        <th>Score</th>
                        <th>Bitscore</th>
                        <th>Identity</th>
                        <th>Postitives</th>
                        <th>Gaps</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Length</th>
                    </tr>
                </thead>
            </table>

        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="psiblast_alignments" class="accordion-content table-scroll" data-tab-content>

            <div id="psiblast_alignment_control" style="display: flex;">
                <select id="psiblast_color_select" onchange="toggleAliColor(this)">
                    <option value="none">No color</option>
                    <option value="letters">Letters</option>
                    <option value="background">Background</option>
                </select>
                <button type="button" style="float: right;" class="button" onclick="submitManuallySelected()">Create Model from manually selected templates</button>
                <button type="button" style="float: right;" class="button" onclick="submitAutomaticallySelected()">Select Templates Automatically</button>
            </div>
            <form id="psiblast_templates">
            </form>
        </div>
    </li>
</ul>


<script>

        var aas;
        var hitlist;
        var queryLength;


        (function()  {
            var dataRoute = jsRoutes.controllers.DataController.get(@jobID);
            $.ajax({
                method: dataRoute.method,
                url: dataRoute.url
            }).done(function(data) {
                // For the hitlist

                var numIterations = data.output_psiblastp.BlastOutput2[0].report.results.iterations.length - 1;
                var basenameResults = data.output_psiblastp.BlastOutput2[0].report.results.iterations[numIterations].search
                var hits = basenameResults.hits
                var numHits = hits.length -1
                var info = basenameResults.stat

                queryLength = basenameResults.query_len;
                $("#psiblast_query").append(basenameResults.query_title);
                $("#psiblast_queryLength").append(queryLength);

                // generate JSON file that is easier to use with dataTable



                hitlist = $('#htp').dataTable({
                    "bInfo": false,
                    "bFilter": true,
                    "bLengthChange": true,
                    "aaData": hits,
                    "scrollY": 600,
                    "scrollX": true,
                    "aoColumns": [
                        { "mDataProp": "num" },
                        { "mDataProp": "description.0.accession" },
                        { "mDataProp": "hsps.0.evalue", render: function(data){return data.toExponential();}},
                        { "mDataProp": "hsps.0.score" },
                        { "mDataProp": "hsps.0.bit_score" },
                        { "mDataProp": "hsps.0.identity" },
                        { "mDataProp": "hsps.0.positive" },
                        { "mDataProp": "hsps.0.gaps" },
                        { "mDataProp": "hsps.0.query_from" },
                        { "mDataProp": "hsps.0.query_to" },
                        { "mDataProp": "hsps.0.hit_from" },
                        { "mDataProp": "hsps.0.hit_to" },
                        { "mDataProp": "hsps.0.align_len" }
                    ]
                });


                var alignments_container = document.getElementById("psiblast_templates");
                for(var i = 0; i < numHits; i++) {

                    var ali = hits[i].hsps[0]
                    var alignmentNum = hits[i].num

                    var divAlignment = document.createElement("div");
                    divAlignment.setAttribute("class", "alignment_box");
                    var checkbox = document.createElement("input");
                    checkbox.setAttribute("type", "checkbox");
                    checkbox.setAttribute("value", alignmentNum.toString());
                    checkbox.setAttribute("name", "templates");
                    divAlignment.appendChild(checkbox);
                    var tab = document.createElement("table");
                    tab.className += " unstriped ";
                    var tabbody = document.createElement("tbody");

                    // Number of sequence
                    tabbody.appendChild(makeRow(["Number: " + alignmentNum, "", "", ""]));

                    // Names and Accession Numbers
                    for(var j =0; j < hits[i].description.length ; j++) {
                        var accession = hits[i].description[j].accession;
                        var linkTemplate = ["<a href=\"https://www.ncbi.nlm.nih.gov/protein/", accession, "\">", accession, "</a>"].join('')
                        var names = makeRowColspan([linkTemplate, hits[i].description[j].title],2,"td")
                        names.setAttribute("class","name")
                        tabbody.appendChild(names)
                    }

                    // break
                    tabbody.appendChild(makeRow(["<br></br>"]))

                    // Query sequence
                    var  qseqColored = ali.qseq.replace(color_regex, color_regex_replacer);
                    var qseqRow = makeRow(["Query" , ali.query_from, qseqColored, ali.query_to]);
                    qseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(qseqRow);

                    //Middle sequence
                    var midlineRow = makeRow(["", "", ali.midline, ""]);
                    midlineRow.setAttribute("class", "sequence");
                    tabbody.appendChild(midlineRow);

                    // Hit sequence
                    var  hseqColored = ali.qseq.replace(color_regex, color_regex_replacer)
                    var hseqRow = makeRow(["Sbjct", ali.hit_from, hseqColored, ali.hit_to]);
                    hseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(hseqRow);

                    // Line
                    var line = makeRowColspan(["<hr style=\"margin-top: 1rem !important;margin-bottom: 1rem !important;\"></hr>"],4,"td");
                    line.setAttribute("class","horizontal-line")
                    tabbody.appendChild(line)

                    tab.appendChild(tabbody);

                    divAlignment.appendChild(tab);
                    alignments_container.appendChild(divAlignment);
                }

                aas = $('span[class^="aa_"]'); // Have to use jQuery for that one
                $('#psiblast_color_select').niceSelect();
                $("#psiblast_accordion").foundation();



            });
        })();

        /* without timeout SLIDER is not loaded */
        setTimeout(function() {slider_show(queryLength, 1, queryLength)}, 1000);



</script>
