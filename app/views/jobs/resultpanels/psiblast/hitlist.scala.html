@import models.results.HHpred
@(jobID: String)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">


<ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
    <li class="accordion-item is-active"  data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            <div class='flat-slider' id='flat-slider'></div>
            <a class="success button tiny resubmitSection" onclick="resubmit()" type="button" id="resubmitSection">Resubmit section</a>
            <div id='blastviz'>
                @HHpred.html(s"$jobID/results/blastviz.html")
                <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
            </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table  class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="psiblast_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="psiblast_queryLength"></td>
                </tr>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <table id="htp" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Name</th>
                        <th>E-value</th>
                        <th>Score</th>
                        <th>Bitscore</th>
                        <th>Identity</th>
                        <th>Postitives</th>
                        <th>Gaps</th>
                        <th>qStart</th>
                        <th>qEnd</th>
                        <th>hStart</th>
                        <th>hEnd</th>
                        <th>Length</th>
                    </tr>
                </thead>
            </table>

        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="alignments" class="accordion-content table-scroll" data-tab-content>

            <div id="psiblast_alignment_control" style="display: flex;">
                <select id="psiblast_color_select" onchange="toggleAliColor(this)">
                    <option value="none">No color</option>
                    <option value="letters">Letters</option>
                    <option value="background">Background</option>
                </select>
            </div>
            <form id="psiblast_templates">
            </form>
        </div>
    </li>
</ul>


<script>

        var aas;
        var hitlist;
        var queryLength;
        var firstHitBegin;
        var firstHitEnd;
        var numHitsShown = 1;
        var hitSequences= new Array();
        var hitNames = new Array();


        (function()  {
            var dataRoute = jsRoutes.controllers.DataController.get(@jobID);
            $.ajax({
                method: dataRoute.method,
                url: dataRoute.url
            }).done(function(data) {
                // For the hitlist

                var numIterations = data.output_psiblastp.BlastOutput2[0].report.results.iterations.length - 1;
                var basenameResults = data.output_psiblastp.BlastOutput2[0].report.results.iterations[numIterations].search
                var hits = basenameResults.hits
                var numHits = hits.length -1
                var info = basenameResults.stat

                queryLength = basenameResults.query_len;
                $("#psiblast_query").append(basenameResults.query_title);
                $("#psiblast_queryLength").append(queryLength);

                // generate JSON file that is easier to use with dataTable



                hitlist = $('#htp').dataTable({
                    "bInfo": false,
                    "bFilter": true,
                    "bLengthChange": true,
                    "aaData": hits,
                    "scrollY": 600,
                    "scrollX": true,
                    "aoColumns": [
                        { "mDataProp": "num" },
                        { "mDataProp": "description.0.accession" },
                        { "mDataProp": "hsps.0.evalue", render: function(data){return data.toExponential();}},
                        { "mDataProp": "hsps.0.score" },
                        { "mDataProp": "hsps.0.bit_score" },
                        { "mDataProp": "hsps.0.identity" },
                        { "mDataProp": "hsps.0.positive" },
                        { "mDataProp": "hsps.0.gaps" },
                        { "mDataProp": "hsps.0.query_from" },
                        { "mDataProp": "hsps.0.query_to" },
                        { "mDataProp": "hsps.0.hit_from" },
                        { "mDataProp": "hsps.0.hit_to" },
                        { "mDataProp": "hsps.0.align_len" }
                    ]
                });

                // get beg and end of first hit to set slider handles
                if(hits[0].hsps.length > 0 ) {
                    firstHitBegin = hits[0].hsps[0].query_from;
                    firstHitEnd = hits[0].hsps[0].query_to;
                }
                else {
                    firstHitBegin = 0;
                    firstHitEnd = 0;
                }


                var alignments_container = document.getElementById("psiblast_templates");
                for(var i = 0; i <= numHits; i++) {

                    var ali = hits[i].hsps[0]
                    var alignmentNum = hits[i].num

                    var divAlignment = document.createElement("div");
                    divAlignment.setAttribute("class", "alignment_box");
                    var checkbox = document.createElement("input");
                    checkbox.setAttribute("type", "checkbox");
                    checkbox.setAttribute("value", alignmentNum.toString());
                    checkbox.setAttribute("name", "templates");
                    divAlignment.appendChild(checkbox);
                    var tab = document.createElement("table");
                    tab.className += " unstriped ";
                    var tabbody = document.createElement("tbody");

                    hitNames.push(">" + hits[i].description[0].accession + " | " + hits[i].description[0].title)
                    // Names and Accession Numbers
                    for(var j =0; j < numHitsShown ; j++) {
                        var accession = hits[i].description[j].accession;
                        var linkTemplate = ["<a name=\"",accession,"\"href=\"https://www.ncbi.nlm.nih.gov/protein/", accession, "\">", accession, "</a>"].join('')
                        var names = makeRowColspan([alignmentNum, linkTemplate + "\t"+hits[i].description[j].title],2,"td")
                        names.setAttribute("class","name")
                        tabbody.appendChild(names)
                    }

                    // hit details
                    var score = ali.score
                    var bit_score = ali.bit_score
                    var evalue = ali.evalue;
                    var identities = ali.identity;
                    var positives = ali.positive;
                    var gaps = ali.gaps;
                    var align_len = ali.align_len
                    var identityPercentage  = Math.floor((identities / align_len) * 100);
                    var positivesPercentage  = Math.floor((positives / align_len) * 100);
                    var gapsPercentage  = Math.floor((gaps / align_len) * 100);

                    tabbody.appendChild(makeRow(["","","Score: "+ bit_score+ " bits (" +score +"), Expect: " +evalue+ ",",""]));
                    tabbody.appendChild(makeRowColspan(["","Identities: " + identities + "/" + align_len + "(" + identityPercentage +"%), Positives: "+
                        positives+ "/"+ align_len+" ("+ positivesPercentage+ "%), Gaps: "+ gaps+ "/"+ align_len+ " ("+ gapsPercentage+ "%)"],2,"td"));


                    // break
                    tabbody.appendChild(makeRow(["<br></br>"]))

                    // Query sequence
                    var  qseqColored = ali.qseq.replace(color_regex, color_regex_replacer);
                    var qseqRow = makeRow(["Query" , ali.query_from, qseqColored, ali.query_to]);
                    qseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(qseqRow);

                    //Middle sequence
                    var midlineRow = makeRow(["", "", ali.midline, ""]);
                    midlineRow.setAttribute("class", "sequence");
                    tabbody.appendChild(midlineRow);

                    // Hit sequence
                    var  hseqColored = ali.hseq.replace(color_regex, color_regex_replacer)
                    var hseqRow = makeRow(["Sbjct", ali.hit_from, hseqColored, ali.hit_to]);
                    hseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(hseqRow);

                    // filling array for resubmit Section
                    hitSequences.push(ali.hseq);

                    // Line
                    var line = makeRowColspan(["<hr id=\"line-element\"></hr>"],4,"td");
                    line.setAttribute("class","horizontal-line")
                    tabbody.appendChild(line)

                    tab.appendChild(tabbody);

                    divAlignment.appendChild(tab);
                    alignments_container.appendChild(divAlignment);
                }

                aas = $('span[class^="aa_"]'); // Have to use jQuery for that one
                $('#psiblast_color_select').niceSelect();
                $("#accordion").foundation();



            });
        })();


        function resubmit(){
            resubmit_section(this.hitSequences, this.hitNames);
        }
        /* without timeout SLIDER is not loaded */
        setTimeout(function() {slider_show(queryLength, firstHitBegin, firstHitEnd)}, 1000);



</script>
