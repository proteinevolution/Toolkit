@import models.results.BlastVisualization
@import models.database.results.PSIBlastResult
@(jobID: String, result: PSIBlastResult, tool: models.tools.Tool)(implicit request: RequestHeader)
@* Load html Map used for the image representation *@

@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
    <div id="stickyAnchor"></div>
    <div class="scrollContainer">
        <div id="scrollLinks">
            <a id="visualizationScroll" onclick="scrollToSection('visualization')">Visualization</a>
            <a id="hitlistScroll" onclick="scrollToSection('hitlist')">Hitlist</a>
            <a id="alignmentsScroll" onclick="scrollToSection('alignments')">Alignments</a>
        </div>
        <span class="headerDivider"></span>
        <div id="controlls">
            <a onclick="@{tool.toolNameShort}_selectAll()" type="button"class="selectAllSeq_@{tool.toolNameShort}">Select all</a>
            <a type="button" data-open="forwardModal_@{tool.toolNameShort}">Forward</a>
        </div>
    </div>
    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
            <div class='flat-slider' id='flat-slider'></div>
            <div id='blastviz'>
                <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                Resubmit section</a>
                    @BlastVisualization.html(s"$jobID/results/blastviz.html")
                    <p><img src="files/@{jobID}/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
            <table id="htb" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th>Nr</th>
                        <th>Id</th>
                        <th>Title</th>
                        <th>E-value</th>
                        <th>Bitscore</th>
                        <th>Length</th>
                    </tr>
                </thead>
            </table>
    </div>
    <div id="alignments">
        <h5 id="alignmentsTitle">Alignments</h5>
            <form id="psiblast_templates">
                  <table class="unstriped">
                    <tbody>
                        Number of sequences: @{result.num_hits}
                        <br />
                        <br />
                        @for(hit <- result.HSPS ){
                            @* hit number, links *@
                            <tr>
                                <td></td>
                                <td colspan="3">

                                   @BlastVisualization.getLinksDB(result.db, hit.accession)
                                </td>
                                <td></td>
                            </tr>
                            @* checkboxes, accession, name of hit*@
                            <tr class="header">
                                <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{hit.num}'> @{hit.num}.</td>
                            <td colspan="4">
                                @{BlastVisualization.getSingleLinkDB(result.db , hit.accession)}
                                @{"  "+hit.description}
                            </td>
                            </tr>
                            @* Alignment Details*@
                            <tr>
                                <td></td>
                            <td colspan="4">Score: @{hit.bitscore}
                                bits (@{hit.score}),
                                E-value: @{hit.evalue},
                                Identities: @{hit.identity}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.identity, hit.hit_len)}),
                                Positives: @{hit.positive}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.positive, hit.hit_len)}),
                                Gaps: @{hit.gaps}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.gaps, hit.hit_len)}),
                                Length: @{hit.hit_len}
                            </td>
                            </tr>
                            <tr>
                                <td><br /></td>
                            </tr>
                            @* color only 150 first hits, to avoid bloating of the generated html*@
                            @if(hit.num < 150) {
                                @* Query *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Query", hit.query_start.toString, BlastVisualization.colorRegexReplacer(hit.query_seq), hit.query_end.toString))
                                }
                                @* Midline *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("", "", BlastVisualization.colorRegexReplacer(hit.midline), ""))
                                }
                                @* Hit *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Hit", hit.hit_start.toString, BlastVisualization.colorRegexReplacer(hit.hit_seq), hit.hit_end.toString))
                                }
                            }else{
                                @* Query *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Query", hit.query_start.toString, hit.query_seq, hit.query_end.toString))
                                }
                                @* Midline *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("", "", hit.midline, ""))
                                }
                                @* Hit *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Hit", hit.hit_start.toString, hit.hit_seq, hit.hit_end.toString))
                                }
                            }
                            <tr>
                                <td colspan="5"><hr id="line-element" class="horizontal-line"></td>
                            </tr>
                        }
                    </tbody>
                  </table>
            </form>
    </div>
}
<script>

var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
var hitlist;
var query;
var selectAllBool_@{tool.toolNameShort} = false;


(function()  {

    // add scrollcontainer highlighting
    $(document).on('scroll', function() {
        if($(this).scrollTop()>=$('#alignments').position().top-10){
            $("#alignmentsScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }else if($(this).scrollTop()>=$('#hitlist').position().top-10){
            $("#hitlistScroll").addClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
            $("#visualizationScroll").removeClass("colorToggle");
        }  else if($(this).scrollTop()>=$('#visualization').position().top+75) {
            $('.scrollContainer').addClass('fixed');
        } else if($(this).scrollTop()>=$('#visualization').position().top-10) {
            $("#visualizationScroll").addClass("colorToggle");
            $("#hitlistScroll").removeClass("colorToggle");
            $("#alignmentsScroll").removeClass("colorToggle");
        }else{
            $('.scrollContainer').removeClass('fixed');
        }
    });

    // adding loading overlay
    $(document).ajaxStart(function(){
        $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
    });
    $(document).ajaxComplete(function(){
        $.LoadingOverlay("hide");
    });
    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
    var selectAllBool_@{tool.toolNameShort} = false;
    var urlParams = "/api/job/@{jobID}";
    var urlQuery = "/files/@{jobID}/query.json";

    if(@{result.num_hits} > 0){

        drawDataTable();
        var firstQueryStart = @result.HSPS.head.query_start;
        var firstQueryEnd = @result.HSPS.head.query_end;
        /* without timeout SLIDER is displayed */
        setTimeout(function () {
            slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd)
        }, 1000);

        $("#accordion").foundation();

    }
})();

$("#alignmentAccordion").bind('down.zf.accordion', (function() {
    $("#alignments").floatingScroll('update');

}));


$(document).ready(function () {
    setTimeout(function () {
        $("#alignments").floatingScroll('init');
    }, 2000);
});



function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/dataTablePSIBlast/@{jobID}"
});
}


function _deselectAll(){
    deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
}

window["@{tool.toolNameShort}_selectAll"] = function () {
    //selectAllDatatable(this.hitlist.fnGetNodes());
    this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
    if(this.selectAllBool_@{tool.toolNameShort}) {
        selectAll(checkbox_@{tool.toolNameShort});
        $(".selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
    }
    else {
        _deselectAll();
        $(".selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
    }
};


window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength){
    // full seq is retrieved
    var checkedCheckboxes = getCheckedCheckboxes("checkbox_@{tool.toolNameShort}");
    if(boolFullLength) {
        if(boolEvalue) {
            var route = jsRoutes.controllers.PSIBlastController.evalFull('@{jobID}', evalue);
            $.ajax({
                url: route.url,
                method: route.method
            }).done(function () {
                $.ajax({
                    type: 'GET',
                    url: 'files/@{jobID}/sequences.fa'
                }).done(function (data_) {
                    forward(selectedTool, data_.toString());
                });
            });
        }else{
            route = jsRoutes.controllers.PSIBlastController.full('@{jobID}', checkedCheckboxes);
            $.ajax({
                url: route.url,
                method: route.method
            }).done(function (data_) {
                $.ajax({
                    type: 'GET',
                    url: 'files/@{jobID}/sequences.fa'
                }).done(function (data_) {
                    forward(selectedTool, data_.toString());
                });
            });
        }
    }else{

        if(boolEvalue) {
            route = jsRoutes.controllers.PSIBlastController.alnEval('@{jobID}', evalue);
        }else{
            route = jsRoutes.controllers.PSIBlastController.aln('@{jobID}', checkedCheckboxes);
        }
        $.ajax({
            url: route.url,
            method: route.method
        }).done(function (data_) {
            forward(selectedTool, data_);
        });
    }
};

window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection('@{result.query.seq}', '>'+'@{result.query.accession}');
};

</script>
