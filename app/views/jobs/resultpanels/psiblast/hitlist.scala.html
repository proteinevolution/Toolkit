@import de.proteinevolution.models.database.results.PSIBlast.PSIBlastResult
@import better.files._
@import play.twirl.api.Html
@(jobID: String, result: PSIBlastResult, tool: de.proteinevolution.models.Tool, htmlPath: String)()
@* Load html Map used for the image representation *@

    @if(result.num_hits < 1) {
        <div class="callout alert noHitsWide" id="noHits">
            No hits found!
        </div>
    } else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort, "psiblast")
    <div class="scrollContainer scrollContainerWhite">
        <div class="scrollContainerDiv scrollContainerDivWhite">
            <div id="scrollLinks">
                <a id="visualizationScroll" name="#visualization" onclick="scrollToSection('visualization')">Vis</a>
                <a id="hitlistScroll" name="#hitlist" onclick="scrollToSection('hitlist')">Hits</a>
                <a id="alignmentsScroll" name="#alignments" onclick="scrollToSection('alignments')">Aln</a>
            </div>
            <span class="headerDivider"></span>
            <div id="controlls">
                <a onclick="selectAll()" class="selectAllSeqBar" id="extraWide">Select all</a>
                <a type="button" id="forwardButtonNormal" data-open="forwardModal_@{
                    tool.toolNameShort
                }">Forward</a>
                <a type="button" id="downloadAlignment"  onclick="@{tool.toolNameShort}_download()"><span>Download Alignment</span></a>

                <a onclick="wrap()" id="wrap">Wrap Seqs</a>
            </div>
        </div>
    </div>
    <br>
    <text class="notePlain">Number of hits: <b>@result.num_hits</b></text>
    <br>

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <br>
        <text class="note"> We have detected</text>

    }
    @if(result.TMPRED == "1"){
        <text class="note"> @result.TMPRED transmembrane helix</text>
    }
    @if(result.TMPRED.toInt > 1){
        <text class="note"> @result.TMPRED transmembrane helices</text>
    }
    @if((result.TMPRED == "1" || result.TMPRED.toInt > 1) && result.COILPRED == "0"){
        <text class="note"> and </text>

    }
    @if(result.COILPRED == "0"){
        <text class="note">coiled-coil segments </text>
    }

    @if(result.TMPRED == "1" || result.TMPRED.toInt > 1 || result.COILPRED == "0"){
        <text class="note"> in your query protein!</text>

    }

    <div id="visualization">
        <h5 id="visualizationTitle">Visualization</h5>
        <div><a class="success button tiny resubmitSection" onclick="resubmitSection('@{result.query.seq}', '>' + '@{result.query.accession}')" type="button" id="resubmitSection">Resubmit section</a></div>
            <div id='blastviz'>
                <div class='flat-slider' id='flat-slider'></div>
                    @Html(htmlPath.toFile.contentAsString)
                    <p><img src="files/@{jobID}/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
    </div>
    <div id="hitlist">
        <h5 id="hitlistTitle">Hitlist</h5>
            <table id="htb" class="display" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Nr</th>
                        <th>Accession ID</th>
                        <th>Title</th>
                        <th>E-value</th>
                        <th>Bitscore</th>
                        <th>Length</th>
                        <th>Aligned positions</th>
                    </tr>
                </thead>
            </table>
    </div>
    <br>
    <div id="alignments">
        <h5 id="alignmentsTitle">Alignments</h5>
            <form id="psiblast_templates">
                  <table class="unstriped">
                    <tbody id="alignmentTable">
                    </tbody>
                      <tr>
                          <td colspan="4" ><a onclick="getsHitsManually()" id="loadHits">Load Hits</a></td>
                      </tr>
                      <tr>
                          <td colspan="4"><div id="loadingHits">Loading Hits...</div></td>
                      </tr>
                  </table>
            </form>
    </div>
    <div id="toolReferences">
        <h5 id="refTitle">References</h5>
        If you use our PSI-BLAST+ server for your research, please cite:
        <div class="citation">
            @views.html.help.common.toolkit_citation_results()
        </div>
	And the BLAST+ paper:
        <div class="citation">
            <div>BLAST+: architecture and applications.<br>
                Camacho C, Coulouris G, Avagyan V, Ma N, Papadopoulos J, Bealer K, Madden TL.<a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-10-421" target="_blank" rel="noopener"> BMC Bioinformatics. 2009 Dec 15;10:421</a>.</div>
        </div>
    </div>
    <hr id="line-element" colspan="4" class="horizontal-line">

}
<script>

var checkbox = "checkbox";
var selectAllBool = false;
var shownHits = 500;
// use this array to store
// checked checkboxes
// due to pagination/lazyload
var checkboxes = [];
var numHits = @{result.num_hits};
var jobID = '@{jobID}';
var loading = false;
var wrapped = true;

$(document).ready( function(){
    hitlistBaseFunctions();
    if(numHits > 0 ){
        $("#wrap").text("Unwrap Seqs");
        $("#wrap").addClass("colorToggleBar");
        initiallyCheckCheckboxes();
        drawDataTable();
        var firstQueryStart = @{if(result.num_hits > 0){ result.HSPS.head.query_start}};
        var firstQueryEnd = @{if(result.num_hits > 0){ result.HSPS.head.query_end}};
        slider_show(@{result.query.seq.length}, firstQueryStart, firstQueryEnd);
        shownHits = shownHits > numHits ? numHits : shownHits;
        getHits(0, shownHits, wrapped);
        $("#wrap").hide();
    }
});

function selectAll(){
    selectAllBool = !selectAllBool;
    $(".selectAllSeqBar").toggleClass("colorToggleBar");
    $(".selectAllSeqBar").toggleText("Select all","Deselect all");
    if(selectAllBool) {
        selectAllHelper(checkbox);
        // first empty array
        checkboxes = [];
        // push all checkboxes (1 to num_hits) into array
        _.range(1, numHits+1).forEach(function(num){return checkboxes.push(num)});
    }
    else {
        deselectAll(checkbox);
        // delete all checkboxes from array
        checkboxes = [];
    }
}

function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/dataTablePSIBlast/"+jobID,
        "lengthMenu": [[10, 25, 50, 100, numHits], [10, 25, 50, 100, "All"]],
        "searching": false,
        "iDisplayLength": 25,
        "drawCallback": function() {
            linkCheckboxes();
            selectFromArray(checkboxes);
        }
    });
}


function psiblast_forward(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength){
    // full seq is retrieved
    var data = {};
    data.checkboxes = checkboxes.removeDuplicates();
    var route = null;
    var filename = generateFilename();
    $.LoadingOverlay("show");
    if(boolFullLength) {
        if(boolEvalue) {
            data.filename = filename;
            data.evalue = evalue;
            route = jsRoutes.controllers.PSIBlastController.evalFull(jobID);
        }else{
            if(data.checkboxes.length === 0){
                $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                $.LoadingOverlay("hide");
                alert("No sequence(s) selected!");
                return false;
            }
            data.filename = filename;
            route = jsRoutes.controllers.PSIBlastController.full(jobID);
        }
    }else{
        if(boolEvalue) {
            data.filename = filename;
            data.evalue = evalue;
            route = jsRoutes.controllers.PSIBlastController.alnEval(jobID);
        }else{
            if(data.checkboxes.length === 0){
                $('#forwardModal_@{tool.toolNameShort}').foundation('close');
                $.LoadingOverlay("hide");
                alert("No sequence(s) selected!");
                return false;
            }
            data.filename = filename;
            route = jsRoutes.controllers.PSIBlastController.aln(jobID);
        }
    }
    $.ajax({
        url: route.url,
        contentType: 'application/json',
        data: JSON.stringify(data),
        method: route.method,
        error: function(){
            $.LoadingOverlay("hide");
        }
    }).done(function (data_) {
        forwardPath(selectedTool, 'files/'+jobID+'/'+filename+'.fa');
    })
}

function getHits(start, end, isWrapped){
    if(start <= numHits && end <= numHits && !loading){
	    loading = true;
        $('#loadingHits').show();
        $('#loadHits').hide();
        var data = {};
        data.start = start;
        data.end = end;
        data.wrapped = isWrapped;
        var route = jsRoutes.controllers.PSIBlastController.loadHits(jobID);
        return $.ajax({
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(data),
            method: route.method,
            url: route.url
        }).done(function (data_) {
            $("#alignmentTable").append(data_);
	    loading = false;
            $('#loadingHits').hide();
            if (shownHits !== numHits) {
                $('#loadHits').show();
            }
            getCheckedCheckboxes();
            selectFromArray(checkboxes);
            linkCheckboxes();
            $("#alignments").floatingScroll('init');
        });
    }
}

window["@{tool.toolNameShort}_download"] = function(){
    var fileUrl = "/files/@jobID/output.aln_fas";
    var downloadFilename = "@{tool.toolNameShort}_@{jobID}" + ".aln";

    $.LoadingOverlay("show");
    $.ajax({
        type: 'GET',
        url: fileUrl
    }).done(function (data) {
        download(downloadFilename, data.toString());
    });
};

function initiallyCheckCheckboxes(){
    _.range(1, @result.belowEvalThreshold).forEach(function (currentVal) {
        checkboxes.push(currentVal);
    })
}

</script>
