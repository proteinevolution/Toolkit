@import models.results.HHpred
@(jobID: String)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/blast-visualization.css")" rel="stylesheet">


<ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
    <li class="accordion-item is-active" data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            <div class='flat-slider' id='flat-slider'></div>
            <a class="success button tiny resubmitSection" onclick="resubmitSection_()" type="button" id="resubmitSection">
                Resubmit section</a>
            <div id='blastviz'>
                @HHpred.html(s"$jobID/results/blastviz.html")
                <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
            </div>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="psiblast_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="psiblast_queryLength"></td>
                </tr>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <table id="htp" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Name</th>
                        <th>E-value</th>
                        <th>Score</th>
                        <th>Bitscore</th>
                        <th>Identity</th>
                        <th>Postitives</th>
                        <th>Gaps</th>
                        <th>qStart</th>
                        <th>qEnd</th>
                        <th>hStart</th>
                        <th>hEnd</th>
                        <th>Length</th>
                    </tr>
                </thead>
            </table>

        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="alignments" class="alignments accordion-content" data-tab-content>
            <ul id="accordion" class="accordion forward_panel" data-accordion data-multi-expand="true" data-allow-all-closed="true">
                <li class="accordion-item" data-accordion-item>
                    <a href="#" class="accordion-title" style="background-color: #eee;">Forward</a>
                    <div id="alignments" class="alignments accordion-content forward_panel_content" data-tab-content>
                        <div class="select_forward">
                            <select id="forward">
                                <option value="hhpred">HHpred</option>
                            </select>
                        </div>
                        <br>
                        <div class="forward_form">
                            <div class="forwardFormDiv">
                                <label style="font-weight: bold">Select hits to forward</label>
                                <input type="radio" name="radio1"><label>Selected Hits</label>
                                <div class="two_input">
                                    <input type="radio" name="radio1"><label>E-Value better than</label>
                                    <input class="result_inputs" type="text" value="0.001">
                                </div>
                            </div>

                            <div class="forwardFormDiv">
                                <label style="font-weight: bold">Select sequence length</label>
                                <input type="radio" name="radio2"><label>Forward slider region</label>
                                <br>
                                <input type="radio" name="radio2"><label>Forward full length sequence</label>
                            </div>
                            <div class="forwardFormLast"><a class="success button tiny" onclick="forward_($('#forward').val());" type="button" id="forward">
                                Forward Job</a></div>
                        </div>
                    </div>
                </li>
            </ul>
            <div class="colorOpts">
                <a onclick="selectAll_()" type="button" id="selectAllSeq">Select all</a>
                <a onclick="toggleAliColor(this)" type="button">Color alignments</a>
                <a onclick="toggleAliColor(this)" type="button">Color background</a>
                <a onclick="toggleSS()" type="button">Color only SS</a>
            </div>
            <form id="psiblast_templates">
                <hr id="line-element" colspan="4" class="horizontal-line">
            </form>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table  class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="psiblast_query"></td>
                </tr>
                <tr>
                    <td>Match_columns</td>
                    <td id="psiblast_queryLength"></td>
                </tr>
            </table>
        </div>
    </li>
</ul>


<script>

        var aas;
        var hitlist;
        var queryLength;
        var firstHitBegin;
        var firstHitEnd;
        var numHitsShown = 1;
        var hitSequences = [];
        var hitNames = [];


        (function () {
            var dataRoute = jsRoutes.controllers.DataController.get(@jobID);
            $.ajax({
                method: dataRoute.method,
                url: dataRoute.url
            }).done(function (data) {
                // For the hitlist

                var numIterations = data.output_psiblastp.BlastOutput2[0].report.results.iterations.length - 1;
                var basenameResults = data.output_psiblastp.BlastOutput2[0].report.results.iterations[numIterations].search;
                var hits = basenameResults.hits;
                var numHits = hits.length - 1;
                var info = basenameResults.stat;

                queryLength = basenameResults.query_len;
                $("#psiblast_query").append(basenameResults.query_title);
                $("#psiblast_queryLength").append(queryLength);

                // generate JSON file that is easier to use with dataTable


                hitlist = $('#htp').dataTable({
                    "bInfo": false,
                    "bFilter": true,
                    "bLengthChange": true,
                    "aaData": hits,
                    "scrollX": true,
                    "aoColumns": [

                        {"mDataProp": "num"},
                        {"mDataProp": "description.0.accession"},
                        {
                            "mDataProp": "hsps.0.evalue", render: function (data) {
                            return data.toExponential(2);
                        }
                        },
                        {"mDataProp": "hsps.0.score"},
                        {"mDataProp": "hsps.0.bit_score"},
                        {"mDataProp": "hsps.0.identity"},
                        {"mDataProp": "hsps.0.positive"},
                        {"mDataProp": "hsps.0.gaps"},
                        {"mDataProp": "hsps.0.query_from"},
                        {"mDataProp": "hsps.0.query_to"},
                        {"mDataProp": "hsps.0.hit_from"},
                        {"mDataProp": "hsps.0.hit_to"},
                        {"mDataProp": "len"}

                    ],
                    'columnDefs': [{
                        'targets': 0,
                        'searchable': false,
                        'orderable': false,
                        'render': function (data, type, full, meta) {
                            return '<input type="checkbox" name="hitCheckbox" class="hitCheckbox" value="' + $('<div/>').text(data).html() + '">';
                        }
                    }]
                });

                // get beg and end of first hit to set slider handles
                if (numHits > 0) {

                    if (hits[0].hsps.length > 0) {
                        firstHitBegin = hits[0].hsps[0].query_from;
                        firstHitEnd = hits[0].hsps[0].query_to;
                    }
                    else {
                        firstHitBegin = 0;
                        firstHitEnd = 0;
                        alert("No hits found!");
                    }
                }

                var alignments_container = document.getElementById("psiblast_templates");
                for (var i = 0; i <= numHits; i++) {

                    var ali = hits[i].hsps[0];
                    var alignmentNum = hits[i].num;

                    var divAlignment = document.createElement("div");
                    divAlignment.setAttribute("class", "alignment_box");

                    var checkbox = document.createElement("input");
                    checkbox.setAttribute("type", "checkbox");
                    checkbox.setAttribute("value", alignmentNum.toString());
                    checkbox.setAttribute("name", "hitCheckbox");
                    checkbox.setAttribute("class", "hitCheckbox");
                    divAlignment.appendChild(checkbox);
                    var tab = document.createElement("table");
                    tab.className += " unstriped ";
                    var tabbody = document.createElement("tbody");
                    hitNames.push(">" + hits[i].description[0].accession + " | " + hits[i].description[0].title)
                    // Names and Accession Numbers
                    for (var j = 0; j < numHitsShown ; j++) {
                        var accession = hits[i].description[j].accession;
                        var linkTemplate = ["<a name=\"", accession, "\"href=\"https://www.ncbi.nlm.nih.gov/protein/", accession, "\">", accession, "</a>"].join('')
                        var names = makeRowColspan([alignmentNum + " " + linkTemplate, hits[i].description[j].title], 2, "td")
                        names.setAttribute("class", "name");
                        tabbody.appendChild(names)
                    }

                    // hit details
                    var length = hits[i].len;
                    var score = ali.score;
                    var bit_score = ali.bit_score;
                    var evalue = ali.evalue.toExponential(2);
                    var identities = ali.identity;
                    var positives = ali.positive;
                    var gaps = ali.gaps;
                    var align_len = ali.align_len;
                    var identityPercentage = Math.floor((identities / align_len) * 100);
                    var positivesPercentage = Math.floor((positives / align_len) * 100);
                    var gapsPercentage = Math.floor((gaps / align_len) * 100);

                    tabbody.appendChild(makeRowColspan(["  Score: " + bit_score + " bits (" + score + "), Expect: " + evalue + ", Identities: "
                    + identities + "/" + align_len + "(" + identityPercentage + "%),", ""], 4, "td"));
                    tabbody.appendChild(makeRowColspan(["  Positives: " +
                    positives + "/" + align_len + " (" + positivesPercentage + "%), Gaps: " + gaps + "/" + align_len + " (" + gapsPercentage + "%), Length: " + length], 4, "td"));

                    // break
                    tabbody.appendChild(makeRow(["<br></br>"]));

                    // Query sequence
                    var qseqColored = ali.qseq.replace(color_regex, color_regex_replacer);
                    var qseqRow = makeRow(["Query", ali.query_from, qseqColored, ali.query_to]);
                    qseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(qseqRow);

                    //Middle sequence
                    var midlineRow = makeRow(["", "", ali.midline, ""]);
                    midlineRow.setAttribute("class", "sequence");
                    tabbody.appendChild(midlineRow);

                    // Hit sequence
                    var hseqColored = ali.hseq.replace(color_regex, color_regex_replacer)
                    var hseqRow = makeRow(["Sbjct", ali.hit_from, hseqColored, ali.hit_to]);
                    hseqRow.setAttribute("class", "sequence");
                    tabbody.appendChild(hseqRow);

                    // filling array for resubmit Section
                    hitSequences.push(ali.hseq);

                    // Line
                    var line = makeRowColspan(["<hr id=\"line-element\"></hr>"], 4, "td");
                    line.setAttribute("class", "horizontal-line");
                    tabbody.appendChild(line);

                    tab.appendChild(tabbody);

                    divAlignment.appendChild(tab);
                    alignments_container.appendChild(divAlignment);
                }

                aas = $('span[class^="aa_"]'); // Have to use jQuery for that one
                $('#psiblast_color_select').niceSelect();
                $('#forward').niceSelect();
                $("#accordion").foundation();


            });
        })();


        function resubmitSection_() {
            resubmitSection(this.hitSequences, this.hitNames);
        }

        function selectAll_() {
            selectAll(this.hitlist.fnGetNodes());
        }

        function forward_(tool) {

            if (tool == "")
                return;

            var forwardData = [];
            var count;
            for (var i = 0 ; i < hitSequences.length; i++) {
                count = i + 1;
                if ($("input[value=" + count + "]").prop('checked')) {
                    forwardData.push(this.hitNames[i] + '\n');
                    forwardData.push(this.hitSequences[i] + '\n');
                }
            }
            if (forwardData.length < 1) {
                alert("Please select at least one sequence.");
                return;
            }
            forward(tool, forwardData.join(''));
        }

        /* without timeout SLIDER is not loaded */
        setTimeout(function () {
            slider_show(queryLength, firstHitBegin, firstHitEnd)
        }, 500);





</script>
