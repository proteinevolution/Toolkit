@import models.results.BlastVisualization
@import models.database.results.PSIBlastResult
@(jobID: String, result: PSIBlastResult, tool: models.tools.Tool)(implicit request: RequestHeader)
<link href="@routes.Assets.versioned("styles/hhpred_slider.css")" rel="stylesheet">
@* Load html Map used for the image representation *@

@if(result.num_hits < 1) {
    <div class="callout alert noHits" id="noHits">
        <h6>No hits found!</h6>
    </div>

}else{
    @* Loads ForwardModal *@
    @views.html.forwardmodals.normal(tool, tool.toolNameShort)
<div class="container" id="loadingDiv"></div>
<ul id="accordion" class="accordion" data-accordion data-multi-expand="true" data-allow-all-closed="true">
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Visualization</a>
        <div class="accordion-content" data-tab-content>
            <div class='flat-slider' id='flat-slider'></div>
            <div id='blastviz'>
                <a class="success button tiny resubmitSection" onclick="@{tool.toolNameShort}_resubmitSection()" type="button" id="resubmitSection">
                Resubmit section</a>
                <div id='blastviz'>
                    @BlastVisualization.html(s"$jobID/results/blastviz.html")
                    <p><img src="files/@jobID/blastviz.png" border="0" alt="blasthits" usemap="#blastmap"></p>
                </div>
            </div>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Hitlist</a>
        <div class="accordion-content" data-tab-content>
            <div class="colorOpts">
                <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                <hr id="line-element" class="horizontal-line">
            </div>
            <table id="htb" class="display" cellspacing="0" width="80%">
                <thead>
                    <tr>
                        <th>Nr</th>
                        <th>Id</th>
                        <th>Title</th>
                        <th>E-value</th>
                        <th>Score</th>
                        <th>Bitscore</th>
                        <th>Identity</th>
                        <th>Length</th>
                    </tr>
                </thead>
            </table>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Alignments</a>
        <div id="alignments" class="accordion-content table-scroll" data-tab-content>
            <div class="colorOpts">
                <a onclick="@{tool.toolNameShort}_selectAll()" type="button"><span id="selectAllSeq_@{tool.toolNameShort}">Select all</span></a>
                <a type="button" data-open="forwardModal_@{tool.toolNameShort}"><span>Forward</span></a>
                <hr id="line-element" class="horizontal-line">
            </div>



            <form id="psiblast_templates">
                  <table class="unstriped">
                    <tbody>
                        Number of sequences: @{result.num_hits}
                        <br />
                        <br />
                        @for(hit <- result.HSPS ){
                            @* hit number, links *@
                            <tr>
                                <td></td>
                                <td colspan="3">

                                   @BlastVisualization.getLinks(hit.accession)
                                </td>
                                <td></td>
                            </tr>
                            @* checkboxes, accession, name of hit*@
                            <tr class="header">
                                <td ><input type="checkbox" name="templates" class="checkbox_@{tool.toolNameShort}" value='@{hit.num}'> @{hit.num}.</td>
                            <td colspan="4">
                                @{BlastVisualization.getSingleLink(hit.accession)}
                                @{"  "+hit.description}
                            </td>
                            </tr>
                            @* Alignment Details*@
                            <tr>
                                <td></td>
                            <td colspan="4">Score: @{hit.bitscore}
                                bits (@{hit.score}),
                                E-value: @{hit.evalue},
                                Identities: @{hit.identity}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.identity, hit.hit_len)}),
                                Positives: @{hit.positive}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.positive, hit.hit_len)}),
                                Gaps: @{hit.gaps}/@{hit.hit_len}
                                (@{BlastVisualization.calculatePercentage(hit.gaps, hit.hit_len)}),
                                Length: @{hit.hit_len}
                            </td>
                            </tr>
                            <tr>
                                <td><br /></td>
                            </tr>
                            @* color only 150 first hits, to avoid bloating of the generated html*@
                            @if(hit.num < 150) {
                                @* Query *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Query", hit.query_start.toString, BlastVisualization.colorRegexReplacer(hit.query_seq), hit.query_end.toString))
                                }
                                @* Midline *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("", "", BlastVisualization.colorRegexReplacer(hit.midline), ""))
                                }
                                @* Hit *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Hit", hit.hit_start.toString, BlastVisualization.colorRegexReplacer(hit.hit_seq), hit.hit_end.toString))
                                }
                            }else{
                                @* Query *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Query", hit.query_start.toString, hit.query_seq, hit.query_end.toString))
                                }
                                @* Midline *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("", "", hit.midline, ""))
                                }
                                @* Hit *@
                                @{
                                    BlastVisualization.makeRow("sequence", Array("Hit", hit.hit_start.toString, hit.hit_seq, hit.hit_end.toString))
                                }
                            }
                            <tr>
                                <td colspan="5"><hr id="line-element" class="horizontal-line"></td>
                            </tr>
                        }
                    </tbody>
                  </table>
            </form>
        </div>
    </li>
    <li class="accordion-item" data-accordion-item>
        <a href="#" class="accordion-title">Information</a>
        <div class="accordion-content" data-tab-content>
            <table  class="display" cellspacing="0" width="80%">
                <tr>
                    <td>Query</td>
                    <td id="psiblast_query"></td>
                </tr>
                <tr>
                    <td>Query Length</td>
                    <td id="psiblast_queryLength"></td>
                </tr>
                <tr>
                    <td>DB</td>
                    <td id="psiblast_db"></td>
                </tr>
            </table>
        </div>
    </li>
</ul>

}
<script>

var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
var hitlist;
var query;
var selectAllBool_@{tool.toolNameShort} = false;
var firstQueryName, firstQuerySequence = null;


(function()  {

    // adding loading overlay
    $(document).ajaxStart(function(){
        $.LoadingOverlay("show", {color:  "rgba(0,0,0,0.0)"});
    });
    $(document).ajaxComplete(function(){
        $.LoadingOverlay("hide");
    });
    $('.slider').on('moved.zf.slider', function() {
        $('#lefthandle').html($('#hidden1').val());
        $('#lefthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
        $('#righthandle').html($('#hidden2').val());
        $('#righthandle').css({
            'color' : 'white',
            'font-weight': 'bold',
            'padding-left' : '2px'
        });
    });

    var checkbox_@{tool.toolNameShort} = "checkbox_@{tool.toolNameShort}";
    var selectAllBool_@{tool.toolNameShort} = false;
    var firstQueryName, firstQuerySequence, firstQueryStart, firstQueryEnd = null;
    var numHits = @{result.num_hits};
    var urlParams = "/api/job/@jobID";
    var urlQuery = "/files/" + @jobID + "/query.json";

    $.getJSON(urlQuery, function(query){
        firstQueryName = ">" + query[0][0];
        firstQuerySequence = query[0][1];
        firstQueryLength = firstQuerySequence.length;
        if(numHits > 0){

            drawDataTable();

            firstQueryStart = @result.HSPS.head.query_start;
            firstQueryEnd = @result.HSPS.head.query_end;
            /* without timeout SLIDER is displayed */
            setTimeout(function () {
                slider_show(firstQueryLength, firstQueryStart, firstQueryEnd)
            }, 1000);

            $("#accordion").foundation();

        }
    });
})();



function drawDataTable(){
    hitlist = $('#htb').dataTable({
        "bProcessing" : true,
        "bServerSide" : true,
        "sAjaxSource" : "/api/job/results/psidt/1543125"
});
}


function _deselectAll(){
    deselectAll(checkbox_@{tool.toolNameShort}, this.hitlist.fnGetNodes());
}

window["@{tool.toolNameShort}_selectAll"] = function () {
    //selectAllDatatable(this.hitlist.fnGetNodes());
    this.selectAllBool_@{tool.toolNameShort} = !this.selectAllBool_@{tool.toolNameShort};
    if(this.selectAllBool_@{tool.toolNameShort}) {
        selectAll(checkbox_@{tool.toolNameShort});
        $("#selectAllSeq_@{tool.toolNameShort}").addClass("colorToggle");
    }
    else {
        _deselectAll();
        $("#selectAllSeq_@{tool.toolNameShort}").removeClass("colorToggle");
    }
};


window["@{tool.toolNameShort}_forward"] = function(selectedTool, boolSelectedHits, boolEvalue, evalue, boolFullLength){
    // full seq is retrieved
    var checkedCheckboxes = getCheckedCheckboxes("checkbox_@{tool.toolNameShort}");
    var route = jsRoutes.controllers.PSIBlastController.evalPSIBlastFull('@jobID', evalue);
    if(boolFullLength) {
        if(boolEvalue) {

            $.ajax({
                url: route.url,
                method: route.method
            }).done(function () {
                forward(selectedTool, data_.toString());
            });
        }else{
            var route = jsRoutes.controllers.PSIBlastController.PSIBlastFull('@jobID', checkedCheckboxes);
            $.ajax({
                url: route.url,
                method: route.method
            }).done(function (data_) {
                forward(selectedTool, data_.toString());
            });
        }
    }else{

        if(boolEvalue) {
            route = jsRoutes.controllers.PSIBlastController.alnEvalPSIBlast('@jobID', evalue);
        }else{
            route = jsRoutes.controllers.PSIBlastController.alnPSIBlast('@jobID', checkedCheckboxes);
        }
        $.ajax({
            url: route.url,
            method: route.method
        }).done(function (data_) {
            forward(selectedTool, data_);
        });
    }
};

window["@{tool.toolNameShort}_resubmitSection"] = function(){
    resubmitSection(firstQuerySequence, firstQueryName);
};

</script>
