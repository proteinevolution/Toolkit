@import play.api.mvc.RequestHeader
@import models.database.User
@(webJarAssets: WebJarAssets, content: Html, sectionname : String, user_o: Option[User])(implicit messages: Messages, request: RequestHeader)

<style>

    div#content {

        width: 100%;
        background-color: #d1d1d1 !important;
    }

    .sidebar {

        display: none;
    }

    .CodeMirror pre {

    font-family: Monaco, Consolas, "Lucida Console", monospace;
    font-size: 12px;

    }

    .code { color: #ffae00; }

    .has-tip {
        border-bottom: dotted 0px;

    }



</style>
<link href="@routes.Assets.at("styles/reformat.css")" rel="stylesheet">
<link href="@routes.WebJarAssets.at(webJarAssets.locate("dropzone.min.css"))" rel="stylesheet">
<script src="@routes.WebJarAssets.at(webJarAssets.locate("clipboard.min.js"))"></script>
<script src="@routes.WebJarAssets.at(webJarAssets.locate("dropzone.min.js"))"></script>
<div style="padding-top: 10px;"></div>
<ul class="vertical menu" data-accordion-menu>
    <li>
        <a href="#" class="menu-icon"><i class="fi-list"></i> <span id="reformat">Reformat Converter</span></a>
        <ul class="menu horizontal nested">
            <li><a download="export.txt" class="download" onclick="downloadResult()">Export</a></li>
            <li><a onclick="document.getElementById('dropzonewrapper').style.display= 'block';">Upload</a></li>
            <li><a data-open="alnvizmodal">AlignmentViewer</a></li>
            <li><a onclick="myCodeMirror.setValue('');myCodeMirror2.setValue('')">Clear</a></li>
        </ul>
    </li>
</ul>
<div class="large-12 columns" id="dropzonewrapper" style="display: none;">
<form action="/upload-target" class="dropzone" style="margin-top: 10px;"></form>
</div>
<p>&nbsp;</p>
<div style="width: 95%; display: block; margin: auto;">
    <div class="large-12 columns">
        <div style="float: right; z-index: 9;">
            <span data-tooltip aria-haspopup="true" class="has-tip top" tabindex="1" title="Copy to clipboard">
                <button class="small button warning" id="copy-button" data-clipboard-target="#outputarea" onclick="(function(){
                    new Clipboard('#copy-button');
                })();" style="margin: 0 0 0 0;">Copy</button></span>
        </div>
    </div>
<div class="large-6 columns">
<div id="inputMirror" style="width: 100%;"></div>
</div>
<div class="large-6 columns">
<div id="outputMirror" style="width: 100%;">
</div>


</div>
</div>
<p>&nbsp;</p>

<div class="show-for-medium large-12 columns" style="padding-top: 20px;">
<div class="success callout" id="fastacallout" data-closable="slide-out-right" style="width: 50%; display: block; margin: auto;">
    <p style="width: 80%; text-align: justify;">It looks as we found a <span id="nonalignedwarning" style="color: red; display: none;">non-aligned</span> FASTA formatted input. To which format do you want to convert it?</p>
    <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
    </button>

    <label>Select Output Format
        <select id="outformat_fas">
            <option selected>Choose</option>
            <option value="lowercase">Transform to lower case</option>
            <option value="a3m">A3M</option>
            <option value="clu" class="clustaloption">CLUSTAL</option>
        </select>
    </label>
</div>

<div class="primary callout" id="clustalcallout" data-closable="slide-out-right" style="width: 50%; display: none; margin: auto;">
    <p style="width: 80%; text-align: justify;">It looks as we found a CLUSTAL formatted input. To which format do you want to convert it?</p>
    <button class="close-button" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
    </button>

    <label>Select Output Format
        <select id="outformat_clu">
            <option selected>Choose</option>
            <option value="fas">FASTA</option>
            <option value="a3m">A3M</option>
        </select>
    </label>
</div>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>

<div class="large reveal" id="alnvizmodal" data-reveal>
    <h1>Awesome. I Have It.</h1>
    <p class="lead">Your couch. It is mine.</p>
    <p>I'm a cool paragraph that lives inside of an even cooler modal. Wins!</p>
    <button class="close-button" data-close aria-label="Close modal" type="button">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
<textarea id="outputarea" style="height: 1px; position: relative; top: -10000px; left: -10000px;"></textarea>
<script src="@routes.Assets.at("javascripts/reformat.js")" type="text/javascript"></script>
<script src="@routes.Assets.at("scripts/validation.js")"></script>
<script>

    var inputFasta = ">gi|33300828|ref|NP_877456#7 putative ATP-dependent DNA ligase [Bacteriophage phiKMV]\nPEITVDGRIVGYVMGKTG-KNVGRVVGYRVELEDGSTVAATGLSEEHIQLLTCAYLNAHI\nD---EAMPNYGRIVEVSAMERSAN-TLRHPSFSRFR\n>gi|114796395|emb|CAK25951#9 putative ATP-dependent DNA ligase [Bacteriophage LKD16]\nPSLAVEGIVVGFVMGKTG-ANVGKVVGYRVDLEDGTIVSATGLTRDRIEMLTTEAELLGG\nA-DHPGMADLGRVVEVTAMERSAN-TLRHPKFSRFR\n>gi|114796457|emb|CAK24995#5 putative DNA ligase [Bacteriophage LKA1]   E=4e-40 s/c=1.7\nPGFEADGTVIDYVWGDPDKANANKIVGFRVRLEDGAEVNATGLTQDQMACYTQSYHATAY\nEVGITQTIYIGRACRVSGMERTKDGSIRHPHFDGFR\n>gi|29366706|ref|NP_813751#8 putative DNA ligase [Pseudomonas phage gh-1]   gi|29243565\nPDDNEDGFIQDVIWGTKGLANEGKVIGFKVLLESGHVVNACKISRALMDEFTDTETRLPG\n-------YYKGHTAKVTFMERYPDGSLRHPSFDSFR\n>gi|68299729|ref|YP_249578#6 DNA ligase [Vibriophage VP4]   gi|66473268|gb|AAY46277.1|\nPEGEIDGTVVGVNWGTVGLANEGKVIGFQVLLENGVVVDANGITQEQMEEYTNLVYKTGH\nD-----DCFNGRPVQVKYMEKTPKGSLRHPSFQRWR\n>gi|77118174|ref|YP_338096#3 ligase [Enterobacteria phage K1F]   gi|72527918|gb|AAZ7297\nPSEEADGHVVRPVWGTEGLANEGMVIGFDVMLENGMEVSATNISRALMSEFTENVKSDP-\n------DYYKGWACQITYMEETPDGSLRHPSFDQWR\n>gi|17570796|ref|NP_523305#4 DNA ligase [Bacteriophage T3]   gi|118769|sp|P07717|DNLI_B\nPECEADGIIQGVNWGTEGLANEGKVIGFSVLLETGRLVDANNISRALMDEFTSNVKAHGE\nD------FYNGWACQVNYMEATPDGSLRHPSFEKFR\n>gi|119637753|ref|YP_91898#2 DNA ligase [Yersinia phage Berlin]   gi|119391784|emb|CAJ\nPECEADGIIQSVNWGTPGLSNEGLVIGFNVLLETGRHVAANNISQTLMEELTANAKEHGE\nD------YYNGWACQVAYMEETSDGSLRHPSFVMFR\n";
    // document.getElementById("alignment").value = inputFasta;
    var inputClustal = "CLUSTAL multiple sequence alignment\n\ngi|33300828\tPEITVDGRIVGYVMGKTG-KNVGRVVGYRVELEDGSTVAATGLSEEHIQLLTCAYLNAHI\ngi|11479639\tPSLAVEGIVVGFVMGKTG-ANVGKVVGYRVDLEDGTIVSATGLTRDRIEMLTTEAELLGG\ngi|11479645\tPGFEADGTVIDYVWGDPDKANANKIVGFRVRLEDGAEVNATGLTQDQMACYTQSYHATAY\ngi|29366706\tPDDNEDGFIQDVIWGTKGLANEGKVIGFKVLLESGHVVNACKISRALMDEFTDTETRLPG\ngi|68299729\tPEGEIDGTVVGVNWGTVGLANEGKVIGFQVLLENGVVVDANGITQEQMEEYTNLVYKTGH\ngi|77118174\tPSEEADGHVVRPVWGTEGLANEGMVIGFDVMLENGMEVSATNISRALMSEFTENVKSDP-\ngi|17570796\tPECEADGIIQGVNWGTEGLANEGKVIGFSVLLETGRLVDANNISRALMDEFTSNVKAHGE\ngi|11963775\tPECEADGIIQSVNWGTPGLSNEGLVIGFNVLLETGRHVAANNISQTLMEELTANAKEHGE\n\ngi|33300828\tD---EAMPNYGRIVEVSAMERSAN-TLRHPSFSRFR\ngi|11479639\tA-DHPGMADLGRVVEVTAMERSAN-TLRHPKFSRFR\ngi|11479645\tEVGITQTIYIGRACRVSGMERTKDGSIRHPHFDGFR\ngi|29366706\t-------YYKGHTAKVTFMERYPDGSLRHPSFDSFR\ngi|68299729\tD-----DCFNGRPVQVKYMEKTPKGSLRHPSFQRWR\ngi|77118174\t------DYYKGWACQITYMEETPDGSLRHPSFDQWR\ngi|17570796\tD------FYNGWACQVNYMEATPDGSLRHPSFEKFR\ngi|11963775\tD------YYNGWACQVAYMEETSDGSLRHPSFVMFR";



    var myCodeMirror = CodeMirror(document.getElementById("inputMirror"), {
    value: inputFasta,
    lineNumbers: false,
    mode:  "none",
    theme: "reformat"
    });

    myCodeMirror.setSize("100%", 500);


    var myCodeMirror2 = CodeMirror(document.getElementById("outputMirror"), {
    value: "",
    lineNumbers: false,
    readOnly: true,
    mode:  "javascript",
    theme: "reformat"
    });

    myCodeMirror2.setSize("100%", 500);



    // on and off handler like in jQuery
    myCodeMirror.on('change',function(cMirror){
        // get value right from instance
        if(validateFasta(myCodeMirror.getValue())) {
            document.getElementById('fastacallout').style.display = 'block';

            if (validateAlignment(myCodeMirror.getValue())) {
                $(".clustaloption").show();
                document.getElementById('nonalignedwarning').style.display= 'none';
            }
            if (!validateAlignment(myCodeMirror.getValue())) {

                $(".clustaloption").hide();
                document.getElementById('nonalignedwarning').style.display= 'inline';

            }
        }

        if(!validateFasta(myCodeMirror.getValue())) {
            document.getElementById('fastacallout').style.display = 'none';
        }

        if(checkClustal(myCodeMirror.getValue())) {
            document.getElementById('clustalcallout').style.display = 'block';
        }
        if(!checkClustal(myCodeMirror.getValue())) {
            document.getElementById('clustalcallout').style.display = 'none';
        }


    });


    document.getElementById("outformat_fas").onchange = function() {
        var currentVal = this.value;

        if (currentVal == "a3m") {

            myCodeMirror2.setValue(readA3mText(myCodeMirror.getValue()));
            tempCode = myCodeMirror.getValue();
            myCodeMirror.setValue('');
            $(".CodeMirror-line").decodeEffect();
            myCodeMirror.setValue(tempCode);
        }

        if (currentVal == "clu") {
            myCodeMirror2.setValue(printClustalText(myCodeMirror.getValue()));
            var tempCode = myCodeMirror.getValue();
            myCodeMirror.setValue('');
            $(".CodeMirror-line").decodeEffect();
            myCodeMirror.setValue(tempCode);
        }

        if (currentVal == "lowercase") {

            myCodeMirror2.setValue(printFastaObj(fastaToLowerCase(myCodeMirror.getValue())));
            tempCode = myCodeMirror.getValue();
            myCodeMirror.setValue('');
            $(".CodeMirror-line").decodeEffect();
            myCodeMirror.setValue(tempCode);

        }


        document.getElementById('outputarea').value = myCodeMirror2.getValue();

    };

    document.getElementById("outformat_clu").onchange = function() {
        var currentVal = this.value;

        if (currentVal == "a3m") {

            myCodeMirror2.setValue(readA3mText(clustal2Fasta(myCodeMirror.getValue())));
            tempCode = myCodeMirror.getValue();
            myCodeMirror.setValue('');
            $(".CodeMirror-line").decodeEffect();
            myCodeMirror.setValue(tempCode);
        }

        if (currentVal == "fas") {
            myCodeMirror2.setValue(clustal2Fasta(myCodeMirror.getValue()));
            tempCode = myCodeMirror.getValue();
            myCodeMirror.setValue('');
            $(".CodeMirror-line").decodeEffect();
            myCodeMirror.setValue(tempCode);
        }

        document.getElementById('outputarea').value = myCodeMirror2.getValue();

    };


    function downloadResult() {
        if (myCodeMirror2.getValue())
        $('a.download').attr('href', 'data:application/octet-stream;content-disposition:attachment;filename=file.txt;charset=utf-8,' + encodeURIComponent(myCodeMirror2.getValue()));
        }

    //$("#outputMirror").val().decodeEffect();


    jQuery.fn.decodeEffect = (function ($) {
        var defaultOptions = {
            duration:      1,
            stepsPerGlyph: 1,
            codeGlyphs:    "-ACDEFGHIKLMNPQRSTUVWY",
            className:     "code"
        };

        // get a random string from the given set,
        // or from the 33 - 125 ASCII range
        function randomString(set, length) {
            var string = "", i, glyph;
            for(i = 0 ; i < length ; i++) {
                glyph = Math.random() * set.length;
                string += set[glyph | 0];
            }
            return string;
        }

        function animate(element, options) {
            var text = element.text(),
                    span = $("<span/>").addClass(options.className).insertAfter(element),
                    interval = options.duration / (text.length * options.stepsPerGlyph),
                    step = 0,
                    length = 0,
                    stepper = function () {
                        if(++step % options.stepsPerGlyph === 0) {
                            length++;
                            element.text(text.slice(0, length));
                        }
                        if(length <= text.length) {
                            span.text(randomString(options.codeGlyphs, text.length - length));
                            setTimeout(stepper, interval);
                        } else {
                            span.remove();
                        }
                    };
            element.text("");
            stepper();
        }

        // Basic jQuery plugin pattern
        return function (options) {
            options = $.extend({}, defaultOptions, (options || {}));
            return this.each(function () {
                animate($(this), options);
            });
        };
    }(jQuery));

    $(document).foundation();

</script>

